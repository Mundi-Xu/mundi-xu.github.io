<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://mundi-xu.github.io/2021/07/27/Basics-of-Chrome-V8-1/"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="煊宇"><meta name="keywords" content="LLM Security"><meta property="article:published_time" content="2021-07-27T12:05:21.000Z"><meta property="article:modified_time" content="2021-07-28T12:05:21.000Z"><meta property="article:section" content="Software Development"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="v8"><meta property="article:tag" content="javascript"><meta property="article:tag" content="Memory Management"><meta name="google-site-verification" content="8weHOmi2lqvnOxDE30WJFT51umo63nyCgfm8dXHNT5g"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//raw.githubusercontent.com"><link rel="dns-prefetch" href="//busuanzi.ibruce.info"><link rel="preconnect" href="https://at.alicdn.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/LXGWWenKaiScreen-Regular.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"></noscript><link rel="preload" href="/css/main.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="/js/boot.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script"><meta name="description" content="介绍Chrome V8引擎的基础知识，重点解析其内存管理机制和核心数据类型，为理解JavaScript引擎的底层工作原理奠定基础。"><meta property="og:type" content="article"><meta property="og:title" content="Chrome V8基础（一）"><meta property="og:url" content="https://mundi-xu.github.io/2021/07/27/Basics-of-Chrome-V8-1/index.html"><meta property="og:site_name" content="Hanyin&#39;s Space"><meta property="og:description" content="介绍Chrome V8引擎的基础知识，重点解析其内存管理机制和核心数据类型，为理解JavaScript引擎的底层工作原理奠定基础。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-07-27T12:05:21.000Z"><meta property="article:modified_time" content="2021-07-28T12:05:21.000Z"><meta property="article:author" content="煊宇"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="v8"><meta property="article:tag" content="javascript"><meta property="article:tag" content="Memory Management"><meta name="twitter:card" content="summary_large_image"><meta name="format-detection" content="telephone=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanyin&#39;s Space"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_io/favicon-16x16.png"><link rel="manifest" href="/img/favicon_io/site.webmanifest"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "Chrome V8基础（一）",
    "author": {
      "@type": "Person",
      "name": "煊宇"
    },
    "datePublished": "2021-07-27T12:05:21.000Z",
    
    "dateModified": "2021-07-28T12:05:21.000Z",
    
    "description": "介绍Chrome V8引擎的基础知识，重点解析其内存管理机制和核心数据类型，为理解JavaScript引擎的底层工作原理奠定基础。",
    
    "publisher": {
      "@type": "Organization",
      "name": "Hanyin&#39;s Space",
      
      "logo": {
        "@type": "ImageObject",
        "url": "/img/favicon_io/favicon.ico"
      }
      
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://mundi-xu.github.io/2021/07/27/Basics-of-Chrome-V8-1/index.html"
    },
    
    "keywords": "Chromium,v8,javascript,Memory Management",
    
    
    "articleBody": "基本概念 Google Chrome的大致架构如下，V8主要包含堆栈的内存管理 12345678910111213141516171819202122232425262728+------------------------------------------------------------------------------------------+| Google Chrome                                                                            ||                                                                                          || +----------------------------------------+          +------------------------------+     || | Google V8                              |"
    
  }</script><title>Chrome V8基础（一） - Hanyin&#39;s Space</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/3.0.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"mundi-xu.github.io",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:3},web_analytics:{enable:!0,follow_dnt:!1,google:{measurement_id:"G-3847WCVNF2"}},search_path:"/local-search.json",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-3847WCVNF2",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-3847WCVNF2")})</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Hanyin's Space" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Hanyin&#39;s Space</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Chrome V8基础（一）"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-07-27 20:05" pubdate>July 27, 2021 pm</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 20k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 169 mins </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Software Development" id="heading-f287f429e4026672e5754c1201691e49" role="tab" data-toggle="collapse" href="#collapse-f287f429e4026672e5754c1201691e49" aria-expanded="true">Software Development <span class="list-group-count">(7)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-f287f429e4026672e5754c1201691e49" role="tabpanel" aria-labelledby="heading-f287f429e4026672e5754c1201691e49"><div class="category-post-list"><a href="/2021/08/15/Basics-of-Chrome-V8-3/" title="Chrome V8基础（三）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（三）</span> </a><a href="/2021/07/29/Basics-of-Chrome-V8-2/" title="Chrome V8基础（二）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（二）</span> </a><a href="/2021/07/27/Basics-of-Chrome-V8-1/" title="Chrome V8基础（一）" class="list-group-item list-group-item-action active"><span class="category-post">Chrome V8基础（一）</span> </a><a href="/2021/03/10/MySQL8-under-Kunpeng/" title="华为鲲鹏服务器下MySQL8的安装与远程连接配置" class="list-group-item list-group-item-action"><span class="category-post">华为鲲鹏服务器下MySQL8的安装与远程连接配置</span> </a><a href="/2021/03/02/Use-IPy-to-determine-the-legitimacy-of-an-IP-address/" title="利用IPy判断IP地址的合法性" class="list-group-item list-group-item-action"><span class="category-post">利用IPy判断IP地址的合法性</span> </a><a href="/2019/11/01/stl-list-implementation/" title="stl-list实现分析" class="list-group-item list-group-item-action"><span class="category-post">stl-list实现分析</span> </a><a href="/2019/08/21/Learn-through-automatic-play-mode/" title="超星学习通开启自动播放模式" class="list-group-item list-group-item-action"><span class="category-post">超星学习通开启自动播放模式</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Chrome V8基础（一）</h1><p id="updated-time" class="note note-primary" style="display:none">Last updated on 2021-07-28T20:05:21+08:00</p><div class="markdown-body"><h1 id="基本概念">基本概念</h1><p>Google Chrome的大致架构如下，V8主要包含堆栈的内存管理</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs text">+------------------------------------------------------------------------------------------+<br>| Google Chrome                                                                            |<br>|                                                                                          |<br>| +----------------------------------------+          +------------------------------+     |<br>| | Google V8                              |          |            WebAPIs           |     |<br>| | +-------------+ +---------------+      |          |                              |     |<br>| | |    Heap     | |     Stack     |      |          |                              |     |<br>| | |             | |               |      |          |                              |     |<br>| | |             | |               |      |          |                              |     |<br>| | |             | |               |      |          |                              |     |<br>| | |             | |               |      |          |                              |     |<br>| | |             | |               |      |          |                              |     |<br>| | +-------------+ +---------------+      |          |                              |     |<br>| |                                        |          |                              |     |<br>| +----------------------------------------+          +------------------------------+     |<br>|                                                                                          |<br>|                                                                                          |<br>| +---------------------+     +---------------------------------------+                    |<br>| |     Event loop      |     |          Task/Callback queue          |                    |<br>| |                     |     |                                       |                    |<br>| +---------------------+     +---------------------------------------+                    |<br>|                             +---------------------------------------+                    |<br>|                             |          Microtask queue              |                    |<br>|                             |                                       |                    |<br>|                             +---------------------------------------+                    |<br>|                                                                                          |<br>|                                                                                          |<br>+------------------------------------------------------------------------------------------+<br></code></pre></td></tr></table></figure><h2 id="内存机制">内存机制</h2><p>在Chrome V8中，内存机制是非常重要的，V8是一个使用C++完成的库，用于执行JavaScript，如果你在自己的JavaScript代码中声明了一个变量，那么这个变量将由V8的内存机制进行管理，且只能由它的内存回收机制所回收，而不能被我们自己进行管理（不能被delete或者free等操作符操作）。</p><p>Chrome V8中的堆内存大致可分为以下部分：</p><ul><li>新生代内存区：基本的数据对象都被分配在这里，其区域小但是回收频繁。</li><li>老生代指针区：一堆指向老生代内存区具体数据内容的指针，基本上从新生代进化过来的对象会被移动到此。</li><li>老生代数据区：存放数据对象而不是指向其他对象的指针，老生代指针区的指针就往这边指。</li><li>大对象区：这里存放体积超越其他区大小的对象，每个对象由自己的内存，GC并不会移动大对象。</li><li>代码区：代码对象，也就是包含JIT之后指令的对象，会被分配在这里，也是唯一拥有执行权限的内存区。</li><li>Cell区，属性Cell区，Map区：存放Cell，属性Cell和Map，每个区域都是存放相同大小的元素，结构简单。</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">+----------------------- -----------------------------------------------------------+<br>|   Young Generation                  Old Generation          Large Object space    |<br>|  +-------------+--------------+  +-----------+-------------+ +------------------+ |<br>|  |        NEW_SPACE           |  | MAP_SPACE | OLD_SPACE   | | LO_SPACE         | |<br>|  +-------------+--------------+  +-----------+-------------+ +------------------+ |<br>|  |  from_Space   | to_Space   |                                                   |<br>|  +-------------+--------------+                                                   |<br>|  +-------------+                 +-----------+               +------------------+ |<br>|  | NEW_LO_SPACE|                 | CODE_SPACE|               | CODE_LO_SPACE    | |<br>|  +-------------+                 +-----------+               +------------------+ |<br>|                                                                                   |<br>|   Read-only                                                                       |<br>|  +--------------+                                                                 |<br>|  | RO_SPACE     |                                                                 |<br>|  +--------------+                                                                 |<br>+-----------------------------------------------------------------------------------+<br></code></pre></td></tr></table></figure><p>上图中每个堆部分的空间被GC以不同的方式处理，最重要的两部分就是新生代内存和老生代内存的垃圾回收机制。</p><h3 id="新生代内存">新生代内存</h3><p>绝大多数JavaScript对象都会被分配到新生代内存中，内存区域很小但是垃圾回收频繁。</p><p>在新生代分配内存非常容易，我们只需要保存一个指向内存区的指针并不断根据新对象的大小递增即可。当该指针到达了新生代内存区的末尾时，就会有一次清理。</p><p>新生代内存使用Scavenge算法进行回收：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">ptrs   from_space (evacuation)   to_space<br>      +----------+            +------------+<br>-----&gt;|marked: * | ----------&gt;|marked: s   |       (s=survived)<br>      +----------+            +------------+<br>      |marked:   |      -----&gt;|marked: s   |<br>      +----------+     /      +------------+<br>-----&gt;|marked: * | ----       |            |<br>      +----------+            +------------+<br>      |marked:   |            |            |<br>      +----------+            +------------+<br>      |marked:   |            |            |<br>      +----------+            +------------+<br></code></pre></td></tr></table></figure><p>该种算法中的大致思想为：将内存一分为二，每部分的空间都被成为<code>Semispace</code>。在两个<code>Semispace</code>中，总有一个处于使用状态，成为From空间；另一个处于闲置状态，称为To空间。</p><p>在分配对象时，总使用From空间进行分配；在垃圾回收时，Chrome V8检查From空间中的存活对象，然后将这些对象复制到To空间中，剩下的对象就会被释放，完成复制后From空间和To空间的角色对调，原来的From空间变成了新的To空间，而原来的To空间就变成了From空间。由此可以看出，在新生代内存中总有至少一半的内存是空闲不用的，不过新生代内存的特点就是空间小，回收频繁，所以也浪费不了多少。</p><p>当一个新生代中的对象经过多次新生代的垃圾回收而继续坚挺在内存区中时，说明它的生命周期较长，就会被移动到老生代内存，也称为对象的晋升。</p><p>晋升的标准有两条：</p><ul><li>在垃圾回收的过程中，如果该对象已经经历过一次新生代的清理，那就会晋升</li><li>在垃圾回收的过程中，如果其中To空间的使用已经超过了25%，那么这个对象也会晋升</li></ul><h3 id="老生代内存">老生代内存</h3><p>老生代内存所保存的对象大多数是生存周期很长的甚至是常驻内存的对象，而且老生代占用的内存较多，如果这里再使用Scavenge算法进行垃圾回收，那浪费的内存就太大了。</p><p>所以GC就采用Mark-Sweep和Mark-Compact的结合体进行垃圾回收，主要采用Mark-Sweep，如果老生代空间不足以分配从新生代晋升过来的对象时，才使用Mark-Compact。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text"> Page 1              FreeList                        Page 1<br>+----------+        +--------------+		+------------+<br>|marked: * |---\    |    Size 1    |	--------|marked: s   |<br>+----------+    \   | +----------+ |   /	+------------+<br>|marked:   |     ---|&gt;|__________| |  /	       -|marked: s   |<br>+----------+        | |__________|&lt;|--        /	+------------+<br>|marked: * |--\     | |__________| |         /	|            |<br>+----------+   \    |    Size 2    |        /	+------------+<br>|marked:   |    \   | +----------+ |       /	|            |<br>+----------+     ---|&gt;|__________|&lt;|-------	+------------+<br>|marked:   |        | |__________| |		|            |<br>+----------+        | |__________| |            +------------+<br>                    +--------------+<br></code></pre></td></tr></table></figure><h4 id="mark-sweep标记清除">Mark-Sweep（标记清除）</h4><p>其分为两个阶段：</p><ul><li>标记：在标记阶段需要遍历老生代堆中的所有对象，并标记那些活着的对象，然后进入清除阶段。</li><li>清除：在清除阶段，Chrome V8只清除没有被标记的对象。</li></ul><p>由于Mark-Sweep只清除死亡对象，而死亡对象在老生代中占用的比例通常较小，因此效率还是比较高的。就像从一堆白球中拿出几个红球还是很快的，至少比从一堆白球中拿出半堆红球快得多。</p><h4 id="mark-compact标记整理">Mark-Compact（标记整理）</h4><p>在Mark-Sweep时，容易产生内存碎片的问题,所以Mark-Compact在标记清除的基础上进行了压缩步骤，在清除时让它们变得紧缩。这相当于在清除的时候，让活着的剩余对象尽可能往内存区域的前面靠，直到内存区域前排全部排满，而后部区域是空的。</p><p>Mark-Compact的过程涉及内存区域的紧缩，所以效率比Mark-Sweep要低，不过其优势是不会产生内存碎片。</p><h4 id="惰性清理">惰性清理</h4><p>Chrome V8在标记时就可以了解到哪些对象是死的，哪些对象是活的，但清理释放是需要开销的，所以Chrome V8并不急着去清理，而是延迟进行，GC可以根据需要来清理死掉的对象。</p><h2 id="隔离实例isolate">隔离实例（Isolate）</h2><p>在Chrome V8中，一个引擎实例的数据类型叫Isolate，这是Chrome V8中所有要执行的地方都要出现的数据。它就是一个V8引擎的实例，也可以理解为引擎本体。每个实例内部拥有完全独立的各种状态，包括堆管理、垃圾回收等。</p><p>通过一个实例生成的任何对象都不能在另一个实例中使用，可以创建多个Isolate实例并且并行的在多个线程中使用，但同一个实例不能在多线程中使用。实例自身并不执行JavaScript，也没有JavaScript环境里面的上下文。</p><p>可以通过下述代码创建一个实例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 省略 V8 初始化过程</span><br><br><span class="hljs-comment">// 实例所必要的参数</span><br>v8::Isolate::CreateParams create_params;<br><br><span class="hljs-comment">// 省略参数设置过程</span><br><br><span class="hljs-comment">// 创建一个实例</span><br>v8::Isolate* isolate = v8::Isolate::<span class="hljs-built_in">New</span>(create_params);<br></code></pre></td></tr></table></figure><h2 id="上下文context">上下文（Context）</h2><p>上下文是用来定义JavaScript执行环境的一个对象，其数据类型是Context，在创建时要指明属于哪个实例。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">v8::Isolate* isolate = ...;<br>v8:Local&lt;v8::Context&gt; context = v8::Context::<span class="hljs-built_in">New</span>(isolate);<br></code></pre></td></tr></table></figure><p>其大致相当于一个沙箱化的执行上下文环境，内部预置了一系列的对象和函数，具体细节将在下篇文章继续探讨。</p><h2 id="脚本script">脚本（Script）</h2><p>顾名思义，脚本就是一个包含一段已经编译好的JavaScript脚本的对象，数据类型就是Script。它在编译时就与一个处于活动状态的Context进行绑定。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++">v8::Local&lt;v8::Context&gt; context = ...;<br><br>v8::Local&lt;v8::String&gt; source = 一段JavaScript代码；<br><br><span class="hljs-comment">// 与上下文绑定并编译</span><br>v8::Local&lt;v8::Value&gt; result = v8::Script::<span class="hljs-built_in">Compile</span>(context, source).<span class="hljs-built_in">ToLocalChecked</span>();<br><br><span class="hljs-comment">//执行脚本</span><br>v8::Local&lt;v8::Value&gt; result = script-&gt;<span class="hljs-built_in">Run</span>(context).<span class="hljs-built_in">ToLocalChecked</span>();<br></code></pre></td></tr></table></figure><h1 id="句柄handle">句柄（Handle）</h1><p>句柄是Chrome V8中的一个重要概念，它提供了对于堆内存中JavaScript数据对象的一个引用。与对象（Object）相似，Handle也包含一个地址成员（在HandleBase中定义，称为location_），但和对象不同的是句柄充当抽象层的作用，其可以被GC重新定位。</p><p>Chrome V8在进行垃圾回收的时候，通常会将JavaScript的数据对象移来移去。和对象指针相比，一旦一个对象被移走，这个指针就成了野指针。而在移动的过程中，GC会更新引用了这个数据块的那些句柄，让其断不了联系。当一个对象不再被句柄引用时，那么它将被认定为垃圾，Chrome V8的垃圾回收机制会不时的对其进行回收。具体细节可以参阅<code>src/handles/handles.h</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HandleBase</span> &#123;  <br> ...<br> <span class="hljs-keyword">protected</span>:<br>  Address* location_; <br>&#125;<br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;                                                           <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Handle</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> HandleBase &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">+----------+                  +--------+         +---------+<br>|  Handle  |                  | Object |         |   int   |<br>|----------|      +-----+     |--------|         |---------|<br>|*location_| ---&gt; |&amp;ptr_| --&gt; | ptr_   | -----&gt;  |     5   |<br>+----------+      +-----+     +--------+         +---------+<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apl">(gdb) p handle<br>$8 = &#123;&lt;v8::internal::HandleBase&gt; = &#123;location_ = 0x7ffdf81d60c0&#125;, &lt;No data fields&gt;&#125;<br></code></pre></td></tr></table></figure><p>location_包含一个指针</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apl">(gdb) p /x *(int*)0x7ffdf81d60c0<br>$9 = 0xa9d330<br></code></pre></td></tr></table></figure><p>其值和对象中的一样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apl">(gdb) p /x obj.ptr_<br>$14 = 0xa9d330<br></code></pre></td></tr></table></figure><p>我们可以用指针去访问这个int值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apl">(gdb) p /x *value<br>$16 = 0x5<br>(gdb) p /x *obj.ptr_<br>$17 = 0x5<br>(gdb) p /x *(int*)0x7ffdf81d60c0<br>$18 = 0xa9d330<br>(gdb) p /x *(*(int*)0x7ffdf81d60c0)<br>$19 = 0x5<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/handles/handles.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> i = v8::internal;<br><br><span class="hljs-built_in">TEST</span>(Handle, DefaultConstructor) &#123;<br>  i::Handle&lt;<span class="hljs-type">int</span>&gt; handle&#123;&#125;;<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(handle.<span class="hljs-built_in">is_null</span>());<br>  <span class="hljs-built_in">EXPECT_EQ</span>(handle.<span class="hljs-built_in">location</span>(), <span class="hljs-literal">nullptr</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST</span>(Handle, AddressConstructor) &#123;<br>  <span class="hljs-type">int</span>* value = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>&#123;<span class="hljs-number">5</span>&#125;;<br>  i::Address addr = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Address&gt;(value);<br>  i::Object obj&#123;addr&#125;;<br><br>  i::Address ptr = obj.<span class="hljs-built_in">ptr</span>();<br>  i::Address* location = &amp;ptr;<br>  <span class="hljs-function">i::Handle&lt;i::Object&gt; <span class="hljs-title">handle</span><span class="hljs-params">(location)</span></span>;<br><br>  <span class="hljs-built_in">EXPECT_EQ</span>(handle.<span class="hljs-built_in">location</span>(), &amp;ptr);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(*handle.<span class="hljs-built_in">location</span>(), ptr);<br>  i::Object deref = *handle;<br>  i::Address deref_addr = deref.<span class="hljs-built_in">ptr</span>();<br>  <span class="hljs-type">int</span>* deref_value = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">int</span>*&gt;(deref_addr);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(*deref_value, *value);<br>  <span class="hljs-keyword">delete</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><p>话说回来，句柄在Chrome V8中只是一个统称，它其实还分为多种类型：</p><ul><li>本地句柄(v8::Local)</li><li>持久句柄(v8::Persistent)</li><li>永生句柄(v8::Eternal)</li><li>待实本地句柄(MaybeLocal)</li><li>其他句柄</li></ul><blockquote><p><a target="_blank" rel="noopener" href="https://v8.dev/docs/embed" class="uri">https://v8.dev/docs/embed</a></p></blockquote><p><strong>句柄存在的形式是C++的一个模板类，其需要根据不同的Chrome V8数据类型进行不同的声明。</strong> 例如：</p><ul><li><code>v8::Local&lt;v8::Number&gt;</code> 本地JavaScript数据类型句柄</li><li><code>v8::Persistent&lt;v8::String&gt;</code> 持久JavaScript字符串类型句柄</li></ul><h2 id="local">Local</h2><p>本地句柄存在于栈内存中，并在对应的析构函数调用时被删除，其生命周期由其所在的句柄作用域（Handle Scope）决定。</p><p>含有一个指向T的指针成员</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">Local</span> &#123; <br>...<br> <span class="hljs-keyword">private</span>:<br>  T* val_<br>&#125;<br></code></pre></td></tr></table></figure><p>所以我们可以通过<code>.方法名</code>来访问句柄对象的一些方法或通过重载后的<code>*</code>和<code>-&gt;</code>两个操作符得到这个句柄所引用对象的实体指针。</p><p>假设我们有一个字符串本地句柄<code>Local&lt;String&gt; str</code>，那么就可以有以下调用：</p><ul><li><code>str.IsEmpty()</code> 句柄对象本身的函数，用于判断这个句柄是否是空句柄。</li><li><code>str-&gt;Length()</code> 通过<code>-&gt;</code>得到<code>String*</code>，而String有一个方法Length可获取字符串长度，所以<code>str-&gt;Length()</code>是这个句柄所指的字符串实体的长度。</li></ul><p>我们同样可以使用As或者Cast函数来将某种数据类型的本地句柄转换成另一种类型的本地句柄，其中As是成员函数，而Cast是静态函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++">v8::Local&lt;v8::Number&gt; nr = v8::<span class="hljs-built_in">Local</span>&lt;v8::Number&gt;(v8::Number::<span class="hljs-built_in">New</span>(isolate_, <span class="hljs-number">12</span>));<br>v8::Local&lt;v8::Value&gt; val = v8::Local&lt;v8::Value&gt;::<span class="hljs-built_in">Cast</span>(nr);<br><br>v8::Local&lt;v8::Value&gt; val2 = nr.<span class="hljs-built_in">As</span>&lt;v8::Value&gt;();<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-built_in">TEST_F</span>(LocalTest, local) &#123;<br>  v8::Local&lt;v8::Value&gt; v;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-literal">true</span>, v.<span class="hljs-built_in">IsEmpty</span>()) &lt;&lt; <span class="hljs-string">&quot;Default constructed Local should be empty&quot;</span>;<br><br>  <span class="hljs-comment">// A Local&lt;T&gt; can be converted into a MaybeLocal&lt;T&gt;</span><br>  v8::MaybeLocal&lt;v8::Value&gt; maybe = v8::<span class="hljs-built_in">MaybeLocal</span>&lt;v8::Value&gt;(v);<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe.<span class="hljs-built_in">IsEmpty</span>());<br><br>  <span class="hljs-comment">// Both -&gt; and * return the value of the local.</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(*v, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(v.<span class="hljs-keyword">operator</span>-&gt;(), <span class="hljs-literal">nullptr</span>);<br><br>  <span class="hljs-comment">// The following can be useful in if statement to add branch for</span><br>  <span class="hljs-comment">// when the local is empty.</span><br>  v8::Local&lt;v8::Value&gt; out;<br>  <span class="hljs-type">bool</span> has_value = maybe.<span class="hljs-built_in">ToLocal</span>&lt;v8::Value&gt;(&amp;out);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(has_value);<br><br>  <span class="hljs-comment">// Calling ToLocalChecked will crash the process if called on an empty</span><br>  <span class="hljs-comment">// MaybeLocal&lt;T&gt;</span><br>  <span class="hljs-comment">//ASSERT_DEATH(maybe.ToLocalChecked(), &quot;Fatal error&quot;);</span><br><br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-comment">// Example of using Local::Cast:</span><br>  v8::Local&lt;v8::Number&gt; nr = v8::<span class="hljs-built_in">Local</span>&lt;v8::Number&gt;(v8::Number::<span class="hljs-built_in">New</span>(isolate_, <span class="hljs-number">12</span>));<br>  v8::Local&lt;v8::Value&gt; val = v8::Local&lt;v8::Value&gt;::<span class="hljs-built_in">Cast</span>(nr);<br>  <span class="hljs-comment">// Example of using As:</span><br>  v8::Local&lt;v8::Value&gt; val2 = nr.<span class="hljs-built_in">As</span>&lt;v8::Value&gt;();<br>  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="persistent">Persistent</h2><p>持久句柄提供了一个堆内存中声明的JavaScript对象的引用。持久句柄与本地句柄在生命周期上的管理是两种不同的方式。当你认为世界那么大，一个JavaScript对象不应该只存在于当前的HandleScope中，而应该出去看看的时候，就应该对这个JavaScript对象使用持久句柄。</p><p>举个简单的例子，Google Chrome中的DOM（Document Object Model）节点们在Chrome V8中就是以持久句柄的形式存在的，它们不局限在某个函数的作用域中。</p><p>持久句柄可以使用<code>PersistentBase::SetWeak</code>使其变弱，成为一个弱持久句柄。当对一个JavaScript对象的引用只剩下一个弱持久句柄时，Chrome V8的GC就会触发一个callback 。</p><p>除弱持久句柄以外，持久句柄还分唯一持久句柄（<code>v8::UniquePersistent&lt;...&gt;</code>)和一般持久句柄（<code>v8::Persistent&lt;...&gt;</code>)。</p><ul><li>唯一持久句柄使用C++的构造函数和析构函数来管理其底层对象的生命周期。</li><li>一般持久句柄可以使用它的构造函数来进行创建，但是必须调用<code>Persistent::Reset</code>来进行显式的清除。</li></ul><p>所以一个persistent object是怎么创建的呢？让我们用下述代码来研究研究：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/slots-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/api/api-inl.h&quot;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> _v8_internal_Print_Object(<span class="hljs-type">void</span>* object);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PersistentTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Something</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">Something</span>(v8::Isolate* isolate, v8::Local&lt;v8::Object&gt; obj);<br>  <span class="hljs-function">v8::Persistent&lt;v8::Object&gt;&amp; <span class="hljs-title">persistent</span><span class="hljs-params">()</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">make_weak</span><span class="hljs-params">()</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  v8::Persistent&lt;v8::Object&gt; persistent_handle_;<br>&#125;;<br><br>Something::<span class="hljs-built_in">Something</span>(v8::Isolate* isolate,<br>                     v8::Local&lt;v8::Object&gt; obj) : <span class="hljs-built_in">persistent_handle_</span>(isolate, obj) &#123;<br>&#125;<br><br><span class="hljs-function">v8::Persistent&lt;v8::Object&gt;&amp; <span class="hljs-title">Something::persistent</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> persistent_handle_;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WeakCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> v8::WeakCallbackInfo&lt;Something&gt;&amp; data)</span> </span>&#123;<br>  Something* obj = data.<span class="hljs-built_in">GetParameter</span>();<br>  std::cout &lt;&lt; <span class="hljs-string">&quot;in make weak callback...&quot;</span> &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WeakCallbackVoid</span><span class="hljs-params">(<span class="hljs-type">const</span> v8::WeakCallbackInfo&lt;<span class="hljs-type">void</span>&gt;&amp; data)</span> </span>&#123;<br>  Something* obj = <span class="hljs-built_in">reinterpret_cast</span>&lt;Something*&gt;(data.<span class="hljs-built_in">GetParameter</span>());<br>  <span class="hljs-comment">//std::cout &lt;&lt; &quot;in make weak callback...&quot; &lt;&lt; &#x27;\n&#x27;;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Something::make_weak</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  auto cb = [](const v8::WeakCallbackInfo&lt;Something&gt;&amp; data) &#123;</span><br><span class="hljs-comment">        Something* obj = data.GetParameter();</span><br><span class="hljs-comment">        std::cout &lt;&lt; &quot;in make weak callback...&quot; &lt;&lt; &#x27;\n&#x27;;</span><br><span class="hljs-comment">  &#125;;</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">typename</span> v8::WeakCallbackInfo&lt;Something&gt;::Callback Something_Callback;<br>  Something_Callback something_callback = WeakCallback;<br><br>  <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">typename</span> v8::WeakCallbackInfo&lt;<span class="hljs-type">void</span>&gt;::Callback v8_Callback;<br>  <span class="hljs-comment">//#if defined(__GNUC__) &amp;&amp; !defined(__clang__)</span><br>   <span class="hljs-comment">// #pragma GCC diagnostic push</span><br>    <span class="hljs-comment">//#pragma GCC diagnostic ignored &quot;-Wcast-function-type&quot;</span><br>  <span class="hljs-comment">//#endif</span><br>    v8_Callback cb = <span class="hljs-built_in">reinterpret_cast</span>&lt;v8_Callback&gt;(WeakCallbackVoid);<br>    <span class="hljs-comment">//persistent_handle_.SetWeak(this, WeakCallback, v8::WeakCallbackType::kParameter);</span><br>  <span class="hljs-comment">//#if defined(__GNUC__) &amp;&amp; !defined(__clang__)</span><br>    <span class="hljs-comment">//#pragma GCC diagnostic pop</span><br>  <span class="hljs-comment">//#endif</span><br><br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(PersistentTest, object) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(V8TestFixture::isolate_)</span></span>;<br>  v8::Handle&lt;v8::Context&gt; context = v8::Context::<span class="hljs-built_in">New</span>(isolate_,<br>                                         <span class="hljs-literal">nullptr</span>,<br>                                         v8::<span class="hljs-built_in">Local</span>&lt;v8::ObjectTemplate&gt;());<br>  v8::<span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br>  v8::Local&lt;v8::Object&gt; object = v8::Object::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Something <span class="hljs-title">s</span><span class="hljs-params">(isolate_, object)</span></span>;<br>  s.<span class="hljs-built_in">make_weak</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-literal">false</span>, s.<span class="hljs-built_in">persistent</span>().<span class="hljs-built_in">IsEmpty</span>()) &lt;&lt; <span class="hljs-string">&quot;Default constructed Local should be empty&quot;</span>;<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(PersistentTest, PrintObject) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  v8::<span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  v8::Handle&lt;v8::Context&gt; context = v8::Context::<span class="hljs-built_in">New</span>(isolate_,<br>                                         <span class="hljs-literal">nullptr</span>,<br>                                         v8::<span class="hljs-built_in">Local</span>&lt;v8::ObjectTemplate&gt;());<br>  v8::<span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  v8::Local&lt;v8::Object&gt; obj = v8::Object::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-comment">//v8::internal::Object** ppo = ((v8::internal::Object**)(*obj));</span><br>  <span class="hljs-comment">//_v8_internal_Print_Object(*ppo);</span><br>  _v8_internal_Print_Object(*((v8::internal::Object**)*obj));<br><br>  v8::internal::Handle&lt;v8::internal::Object&gt; h = v8::Utils::<span class="hljs-built_in">OpenHandle</span>(*obj); <br>  _v8_internal_Print_Object((v8::internal::Address*)h-&gt;<span class="hljs-built_in">ptr</span>());<br><br>  v8::internal::Object o = *h;<br>  v8::<span class="hljs-function">internal::ObjectSlot <span class="hljs-title">slot</span><span class="hljs-params">(h-&gt;ptr())</span></span>;<br>  v8::internal::Address a = slot.<span class="hljs-built_in">address</span>();<br><br>  _v8_internal_Print_Object((v8::internal::Address*)v8::Utils::<span class="hljs-built_in">OpenHandle</span>(*obj)-&gt;<span class="hljs-built_in">ptr</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">make ./persistent-object_test<br>./persistent-object_test --gtest_filter=PersistentTest.value<br></code></pre></td></tr></table></figure><p>与Local不同的是，持久句柄通常是通过Local升级而成，所以它通常是在构造函数中传入一个本地句柄。持久句柄的构造函数有几种常用的重载。</p><ul><li><code>Persistent()</code> 直接创建一个持久句柄，这种方法获得的持久句柄通常会在后续再调用别的方法对一个本地句柄进行升级。</li><li><code>Persistent(Isolate *isolate, Local&lt;T&gt; that)</code> 传入Isolate实例以及一个本地句柄，能得到这个本地句柄所引用的Chrome V8数据对象的一个持久句柄。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;Number&gt; local = Number:<span class="hljs-built_in">New</span>(isolate, <span class="hljs-number">2333</span>);<br><span class="hljs-function">Persistent&lt;Number&gt; <span class="hljs-title">persistent_handle</span><span class="hljs-params">(isolate, local)</span></span>;<br></code></pre></td></tr></table></figure><p>所以为了创建一个持久句柄，我们需要先创建一个Local</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;Object&gt; o = Local&lt;Object&gt;::<span class="hljs-built_in">New</span>(isolate_, Object::<span class="hljs-built_in">New</span>(isolate_));<br></code></pre></td></tr></table></figure><p><code>Local&lt;Object&gt;::New</code>能在<code>src/api/api.cc</code>中找到：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;v8::Object&gt; v8::Object::<span class="hljs-built_in">New</span>(Isolate* isolate) &#123;<br>  i::Isolate* i_isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(isolate);<br>  <span class="hljs-built_in">LOG_API</span>(i_isolate, Object, New);<br>  <span class="hljs-built_in">ENTER_V8_NO_SCRIPT_NO_EXCEPTION</span>(i_isolate);<br>  i::Handle&lt;i::JSObject&gt; obj =<br>      i_isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">NewJSObject</span>(i_isolate-&gt;<span class="hljs-built_in">object_function</span>());<br>  <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(obj);<br>&#125;<br></code></pre></td></tr></table></figure><p>首先将公有Isolate指针转换成指向内部类型的指针，LOG_API定义在<code>src\api\api-macros.h</code>中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_API(isolate, class_name, function_name)                        \</span><br><span class="hljs-meta">  RCS_SCOPE(isolate,                                                       \</span><br><span class="hljs-meta">            i::RuntimeCallCounterId::kAPI_##class_name##_##function_name); \</span><br><span class="hljs-meta">  LOG(isolate, ApiEntryCall(<span class="hljs-string">&quot;v8::&quot;</span> #class_name <span class="hljs-string">&quot;::&quot;</span> #function_name))</span><br></code></pre></td></tr></table></figure><p>LOG是定义在<code>src/log.h</code>中的宏：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG(isolate, Call)                                 \</span><br><span class="hljs-meta">  do &#123;                                                     \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (v8::internal::FLAG_log) (isolate)-&gt;logger()-&gt;Call; \</span><br><span class="hljs-meta">  &#125; while (false)</span><br></code></pre></td></tr></table></figure><p>ENTER_V8_NO_SCRIPT_NO_EXCEPTION在<code>src\api\api-macros.h</code>中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENTER_V8_NO_SCRIPT_NO_EXCEPTION(isolate) \</span><br><span class="hljs-meta">  i::VMState<span class="hljs-string">&lt;v8::OTHER&gt;</span> __state__((isolate));</span><br></code></pre></td></tr></table></figure><p>VMState做记录与分析用，StateTag表示VM的可能状态，logger维护着状态的一个堆栈。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;StateTag Tag&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VMState</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-keyword">inline</span> <span class="hljs-title">VMState</span><span class="hljs-params">(Isolate* isolate)</span></span>;<br>  <span class="hljs-keyword">inline</span> ~<span class="hljs-built_in">VMState</span>();<br><br> <span class="hljs-keyword">private</span>:<br>  Isolate* isolate_;<br>  StateTag previous_tag_;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="eternal">Eternal</h2><p>一般认为这种句柄在程序的整个生命周期内是不会被删除的。比起持久句柄来说，永生句柄的开销更小（因为不需要垃圾回收），通常用不到，不再赘述。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">Eternal</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function">V8_INLINE <span class="hljs-title">Eternal</span><span class="hljs-params">()</span> : val_(nullptr) &#123;</span>&#125;<br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">S</span>&gt;<br>  <span class="hljs-function">V8_INLINE <span class="hljs-title">Eternal</span><span class="hljs-params">(Isolate* isolate, Local&lt;S&gt; handle)</span> : val_(nullptr) &#123;</span><br>    <span class="hljs-built_in">Set</span>(isolate, handle);<br>  &#125;<br>  <span class="hljs-comment">// Can only be safely called if already set.</span><br>  <span class="hljs-function">V8_INLINE Local&lt;T&gt; <span class="hljs-title">Get</span><span class="hljs-params">(Isolate* isolate)</span> <span class="hljs-type">const</span></span>;<br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">bool</span> <span class="hljs-title">IsEmpty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> val_ == <span class="hljs-literal">nullptr</span>; &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> S&gt; V8_INLINE <span class="hljs-type">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(Isolate* isolate, Local&lt;S&gt; handle)</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  T* val_;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="maybelocal">MaybeLocal</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaybeLocal</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function">V8_INLINE <span class="hljs-title">MaybeLocal</span><span class="hljs-params">()</span> : val_(nullptr) &#123;</span>&#125;<br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">S</span>&gt;<br>  <span class="hljs-function">V8_INLINE <span class="hljs-title">MaybeLocal</span><span class="hljs-params">(Local&lt;S&gt; that)</span></span><br><span class="hljs-function">      : val_(reinterpret_cast&lt;T*&gt;(*that)) &#123;</span><br>    <span class="hljs-built_in">static_assert</span>(std::is_base_of&lt;T, S&gt;::value, <span class="hljs-string">&quot;type check&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">bool</span> <span class="hljs-title">IsEmpty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> val_ == <span class="hljs-literal">nullptr</span>; &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Converts this MaybeLocal&lt;&gt; to a Local&lt;&gt;. If this MaybeLocal&lt;&gt; is empty,</span><br><span class="hljs-comment">   * |false| is returned and |out| is left untouched.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">S</span>&gt;<br>  <span class="hljs-function">V8_WARN_UNUSED_RESULT V8_INLINE <span class="hljs-type">bool</span> <span class="hljs-title">ToLocal</span><span class="hljs-params">(Local&lt;S&gt;* out)</span> <span class="hljs-type">const</span> </span>&#123;<br>    out-&gt;val_ = <span class="hljs-built_in">IsEmpty</span>() ? <span class="hljs-literal">nullptr</span> : <span class="hljs-keyword">this</span>-&gt;val_;<br>    <span class="hljs-keyword">return</span> !<span class="hljs-built_in">IsEmpty</span>();<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Converts this MaybeLocal&lt;&gt; to a Local&lt;&gt;. If this MaybeLocal&lt;&gt; is empty,</span><br><span class="hljs-comment">   * V8 will crash the process.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">V8_INLINE Local&lt;T&gt; <span class="hljs-title">ToLocalChecked</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Converts this MaybeLocal&lt;&gt; to a Local&lt;&gt;, using a default value if this</span><br><span class="hljs-comment">   * MaybeLocal&lt;&gt; is empty.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">S</span>&gt;<br>  <span class="hljs-function">V8_INLINE Local&lt;S&gt; <span class="hljs-title">FromMaybe</span><span class="hljs-params">(Local&lt;S&gt; default_value)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">IsEmpty</span>() ? default_value : <span class="hljs-built_in">Local</span>&lt;S&gt;(val_);<br>  &#125;<br><br> <span class="hljs-keyword">private</span>:<br>  T* val_;<br>&#125;;<br></code></pre></td></tr></table></figure><p>在旧版本Chrome V8中，如下代码为例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;Value&gt; x = some_value;<br>Local&lt;String&gt; s = x.<span class="hljs-built_in">ToString</span>();<br>s-&gt;<span class="hljs-built_in">Anything</span>();<br></code></pre></td></tr></table></figure><p>在此段代码中，如果ToString()函数内部发生异常时，s将会是一个空的本地句柄，这时执行<code>s-&gt;Anything()</code>就会导致程序崩溃。所以，我们需要加一个<code>if(!s.IsEmpty())</code>判断才能保证程序的健壮性。但实际上有些数据类型的句柄并不需要检查IsEmpty，所以在旧版中可能返回空句柄的那些接口如今都会以MaybeLocal的形式来代替返回值，需要调用<code>ToLocalChecked</code>函数来拿到真正的本地句柄。</p><blockquote><p>MaybeLocal只是为了让你知道哪些地方的返回值需要检查是否为空，而不是确定一定不会返回空。若待实本地句柄为空，直接转换成Local还是会抛出异常。</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">MaybeLocal&lt;String&gt; s = x.<span class="hljs-built_in">ToString</span>();<br><br><span class="hljs-keyword">if</span>(!s.<span class="hljs-built_in">IsEmpty</span>())&#123;<br>    Local&lt;String&gt; _s = s.<span class="hljs-built_in">ToLocalChecked</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>样例代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> v8;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaybeLocalTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeLocalTest, Basic) &#123;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  MaybeLocal&lt;Value&gt; m;<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(m.<span class="hljs-built_in">IsEmpty</span>());<br>  <span class="hljs-built_in">ASSERT_DEATH</span>(m.<span class="hljs-built_in">ToLocalChecked</span>(), <span class="hljs-string">&quot;Fatal error&quot;</span>);<br><br>  <span class="hljs-comment">// the &#123;&#125; will use the types, MaybeLocal default constructor so this would</span><br>  <span class="hljs-comment">// be the same as writing MaybeLocal&lt;Value&gt; something = MaybeLocal&lt;Value&gt;();</span><br>  MaybeLocal&lt;Value&gt; something = &#123;&#125;;<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(something.<span class="hljs-built_in">IsEmpty</span>());<br>  MaybeLocal&lt;Value&gt; something2 = <span class="hljs-built_in">MaybeLocal</span>&lt;Value&gt;();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(something<span class="hljs-number">2.</span><span class="hljs-built_in">IsEmpty</span>());<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeLocalTest, ToLocal) &#123;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  Local&lt;Number&gt; nr = Number::<span class="hljs-built_in">New</span>(isolate_, <span class="hljs-number">18</span>);<br>  MaybeLocal&lt;Number&gt; maybe_nr = <span class="hljs-built_in">MaybeLocal</span>&lt;Number&gt;(nr);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(maybe_nr.<span class="hljs-built_in">IsEmpty</span>());<br><br>  Local&lt;Number&gt; nr2;<br>  <span class="hljs-comment">// The following pattern can be nice to use with if statements</span><br>  <span class="hljs-comment">// since ToLocal returns a bool if the MaybeLocal is empty.</span><br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe_nr.<span class="hljs-built_in">ToLocal</span>&lt;Number&gt;(&amp;nr2));<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe_nr.<span class="hljs-built_in">ToLocal</span>(&amp;nr2));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(nr2-&gt;<span class="hljs-built_in">Value</span>(), <span class="hljs-number">18</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeLocalTest, FromMaybe) &#123;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  Local&lt;String&gt; str = String::<span class="hljs-built_in">NewFromUtf8Literal</span>(isolate_, <span class="hljs-string">&quot;bajja&quot;</span>);<br>  MaybeLocal&lt;String&gt; maybe_str = <span class="hljs-built_in">MaybeLocal</span>&lt;String&gt;(str);<br>  Local&lt;Value&gt; from_local = maybe_str.<span class="hljs-built_in">FromMaybe</span>&lt;Value&gt;(<span class="hljs-built_in">Local</span>&lt;Value&gt;());<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(from_local.<span class="hljs-built_in">IsEmpty</span>());<br>  <span class="hljs-function">String::Utf8Value <span class="hljs-title">value</span><span class="hljs-params">(isolate_, from_local)</span></span>;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(<span class="hljs-string">&quot;bajja&quot;</span>, *value);<br><br>  maybe_str = <span class="hljs-built_in">MaybeLocal</span>&lt;String&gt;();<br>  from_local = maybe_str.<span class="hljs-built_in">FromMaybe</span>&lt;Value&gt;(<span class="hljs-built_in">Local</span>&lt;Value&gt;());<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(from_local.<span class="hljs-built_in">IsEmpty</span>());<br>&#125;<br><br><span class="hljs-function">MaybeLocal&lt;Value&gt; <span class="hljs-title">something</span><span class="hljs-params">()</span> </span>&#123;<br>  MaybeLocal&lt;Object&gt; empty; <span class="hljs-comment">// call some function that returns</span><br>  Local&lt;Object&gt; obj;<br>  <span class="hljs-keyword">if</span> (!empty.<span class="hljs-built_in">ToLocal</span>(&amp;obj)) &#123;<br>    <span class="hljs-comment">// do some error handling</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> obj; <span class="hljs-comment">// just return the value or empty.</span><br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeLocalTest, ReturnEmpty) &#123;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  MaybeLocal&lt;Value&gt; maybe = <span class="hljs-built_in">something</span>();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe.<span class="hljs-built_in">IsEmpty</span>());<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="小结">小结</h1><p>本节介绍了Chrome V8的一些基础知识，包括它的内存机制是怎样的，以及它的几个基础数据类型。</p><p>内存管理机制浅述了以空间换时间的高效新生代内存回收算法Scavenge，以及效率与碎片内存管理并存的Mark-Sweep和Mark-Compact结合体机制下的老生代内存回收算法。同时也介绍了新生代与老生代内存的一个联系，在特定情况下，新生代内存里面的对象会晋升到老生代对象中。</p><p>句柄是用于获取JavaScript对象实体的一种事物，有有效句柄连接的对象实体不会被垃圾回收器进行回收，而失去了所有句柄引用的对象实体会被认为是垃圾，从而在下次垃圾回收的时候被释放。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Software-Development/" class="category-chain-item">Software Development</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Chromium/" class="print-no-link">#Chromium</a> <a href="/tags/v8/" class="print-no-link">#v8</a> <a href="/tags/javascript/" class="print-no-link">#javascript</a> <a href="/tags/Memory-Management/" class="print-no-link">#Memory Management</a></div></div><div class="license-box my-3"><div class="license-title"><div>Chrome V8基础（一）</div><div>https://mundi-xu.github.io/2021/07/27/Basics-of-Chrome-V8-1/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>煊宇</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>July 27, 2021</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-cc-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-cc-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/07/29/Basics-of-Chrome-V8-2/" title="Chrome V8基础（二）"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Chrome V8基础（二）</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2021/07/15/Chromium-component-risk-analysis/" title="【转载】攻防启示：Chromium 组件风险剖析与收敛"><span class="hidden-mobile">【转载】攻防启示：Chromium 组件风险剖析与收敛</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Mundi-Xu/mundi-xu.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkxNTQ1OTg4Mjg=","category":"Announcements","category-id":"DIC_kwDOCTb9rM4CeUGi","theme-light":"light","theme-dark":"dark","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","strict":0};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>Contact me</span></a> <i class="iconfont icon-love"></i> <a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>mundi.xu@gmail.com</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.umd.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,a,d,i=document.getElementById("updated-time");i&&(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/,(a=(t=i.textContent).match(e))&&(d=dayjs(a[0]).fromNow(),i.textContent=t.replace(e,d)),i.style.display="")};Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js",function(){Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js",function(){dayjs.extend(dayjs_plugin_relativeTime),"en".startsWith("en")?relativeDate():Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/en.min.js",function(){dayjs.locale("en"),relativeDate()})})})</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://cdnjs.cloudflare.com/ajax/libs/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/DynamicLine.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>