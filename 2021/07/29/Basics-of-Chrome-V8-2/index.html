<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://mundi-xu.github.io/2021/07/29/Basics-of-Chrome-V8-2/"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="煊宇"><meta name="keywords" content="LLM Security"><meta property="article:published_time" content="2021-07-29T12:05:21.000Z"><meta property="article:modified_time" content="2021-07-30T12:05:21.000Z"><meta property="article:section" content="Software Development"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="v8"><meta property="article:tag" content="javascript"><meta property="article:tag" content="Engine Architecture"><meta name="google-site-verification" content="8weHOmi2lqvnOxDE30WJFT51umo63nyCgfm8dXHNT5g"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//raw.githubusercontent.com"><link rel="dns-prefetch" href="//busuanzi.ibruce.info"><link rel="preconnect" href="https://at.alicdn.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin><link rel="preload" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"></noscript><link rel="preload" href="/css/main.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="/js/boot.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script"><meta name="description" content="介绍Chrome V8引擎的整体模型与核心概念，深入解析其关键数据结构，为理解浏览器安全和JavaScript执行机制提供必要背景。"><meta property="og:type" content="article"><meta property="og:title" content="Chrome V8基础（二）"><meta property="og:url" content="https://mundi-xu.github.io/2021/07/29/Basics-of-Chrome-V8-2/index.html"><meta property="og:site_name" content="Hanyin&#39;s Space"><meta property="og:description" content="介绍Chrome V8引擎的整体模型与核心概念，深入解析其关键数据结构，为理解浏览器安全和JavaScript执行机制提供必要背景。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://v8.dev/_img/docs/embed/local-persist-handles-review.png"><meta property="og:image" content="https://v8.dev/_img/docs/embed/intro-contexts.png"><meta property="article:published_time" content="2021-07-29T12:05:21.000Z"><meta property="article:modified_time" content="2021-07-30T12:05:21.000Z"><meta property="article:author" content="煊宇"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="Engine Architecture"><meta property="article:tag" content="javascript"><meta property="article:tag" content="v8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://v8.dev/_img/docs/embed/local-persist-handles-review.png"><meta name="format-detection" content="telephone=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanyin&#39;s Space"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_io/favicon-16x16.png"><link rel="manifest" href="/img/favicon_io/site.webmanifest"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "Chrome V8基础（二）",
    "author": {
      "@type": "Person",
      "name": "煊宇"
    },
    "datePublished": "2021-07-29T12:05:21.000Z",
    
    "dateModified": "2021-07-30T12:05:21.000Z",
    
    "description": "介绍Chrome V8引擎的整体模型与核心概念，深入解析其关键数据结构，为理解浏览器安全和JavaScript执行机制提供必要背景。",
    
    "publisher": {
      "@type": "Organization",
      "name": "Hanyin&#39;s Space",
      
      "logo": {
        "@type": "ImageObject",
        "url": "/img/favicon_io/favicon.ico"
      }
      
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://mundi-xu.github.io/2021/07/29/Basics-of-Chrome-V8-2/index.html"
    },
    
    "keywords": "Chromium,v8,javascript,Engine Architecture",
    
    
    "articleBody": "句柄作用域（HandleScope） 在代码中，句柄作用域以HandleScope或者EscapableHandleScope的形式存在于栈内存中，其实际上是一个维护一堆句柄的容器。当一个句柄作用域对象的析构函数被调用时，在这个作用域中创建的所有句柄都会被从栈中抹去。于是，通常情况下这些句柄所指的对象将会失去所有引用，然后被GC统一处理。 作用域是一个套一个的以栈的形式存在的，在栈顶的句柄作用域处于激活状态。每次创建新的被管理对象的时候，都会将对象交付给栈顶的作用域管理，当栈顶作用域生命周期结束时，这段时间创建的对象就会被回收。 一般句柄作用域（Handle Scope） 一个HandleScope只有三个成员： 123internal::Isolate* isolate_;internal::Address* prev_next_;internal::Address* prev_limit_; 让我们看看创建一个作用域时会发生哪些事 1v8::HandleScope handle_scope&amp;#123;isolate_&amp;#125;; 构造函数只是单纯的跳到Initialize函数 1"
    
  }</script><title>Chrome V8基础（二） - Hanyin&#39;s Space</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/3.0.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"mundi-xu.github.io",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:3},web_analytics:{enable:!0,follow_dnt:!1,google:{measurement_id:"G-3847WCVNF2"}},search_path:"/local-search.json",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-3847WCVNF2",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-3847WCVNF2")})</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Hanyin's Space" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Hanyin&#39;s Space</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Chrome V8基础（二）"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-07-29 20:05" pubdate>July 29, 2021 pm</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 32k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 263 mins </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Software Development" id="heading-f287f429e4026672e5754c1201691e49" role="tab" data-toggle="collapse" href="#collapse-f287f429e4026672e5754c1201691e49" aria-expanded="true">Software Development <span class="list-group-count">(7)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-f287f429e4026672e5754c1201691e49" role="tabpanel" aria-labelledby="heading-f287f429e4026672e5754c1201691e49"><div class="category-post-list"><a href="/2021/08/15/Basics-of-Chrome-V8-3/" title="Chrome V8基础（三）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（三）</span> </a><a href="/2021/07/29/Basics-of-Chrome-V8-2/" title="Chrome V8基础（二）" class="list-group-item list-group-item-action active"><span class="category-post">Chrome V8基础（二）</span> </a><a href="/2021/07/27/Basics-of-Chrome-V8-1/" title="Chrome V8基础（一）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（一）</span> </a><a href="/2021/03/10/MySQL8-under-Kunpeng/" title="华为鲲鹏服务器下MySQL8的安装与远程连接配置" class="list-group-item list-group-item-action"><span class="category-post">华为鲲鹏服务器下MySQL8的安装与远程连接配置</span> </a><a href="/2021/03/02/Use-IPy-to-determine-the-legitimacy-of-an-IP-address/" title="利用IPy判断IP地址的合法性" class="list-group-item list-group-item-action"><span class="category-post">利用IPy判断IP地址的合法性</span> </a><a href="/2019/11/01/stl-list-implementation/" title="stl-list实现分析" class="list-group-item list-group-item-action"><span class="category-post">stl-list实现分析</span> </a><a href="/2019/08/21/Learn-through-automatic-play-mode/" title="超星学习通开启自动播放模式" class="list-group-item list-group-item-action"><span class="category-post">超星学习通开启自动播放模式</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Chrome V8基础（二）</h1><p id="updated-time" class="note note-primary" style="display:none">Last updated on 2021-07-30T20:05:21+08:00</p><div class="markdown-body"><h1 id="句柄作用域handlescope">句柄作用域（HandleScope）</h1><p>在代码中，句柄作用域以HandleScope或者EscapableHandleScope的形式存在于栈内存中，其实际上是一个维护一堆句柄的容器。当一个句柄作用域对象的析构函数被调用时，在这个作用域中创建的所有句柄都会被从栈中抹去。于是，通常情况下这些句柄所指的对象将会失去所有引用，然后被GC统一处理。</p><p>作用域是一个套一个的以栈的形式存在的，在栈顶的句柄作用域处于激活状态。每次创建新的被管理对象的时候，都会将对象交付给栈顶的作用域管理，当栈顶作用域生命周期结束时，这段时间创建的对象就会被回收。</p><h2 id="一般句柄作用域handle-scope">一般句柄作用域（Handle Scope）</h2><p>一个HandleScope只有三个成员：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">internal::Isolate* isolate_;<br>internal::Address* prev_next_;<br>internal::Address* prev_limit_;<br></code></pre></td></tr></table></figure><p>让我们看看创建一个作用域时会发生哪些事</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">v8::HandleScope handle_scope&#123;isolate_&#125;;<br></code></pre></td></tr></table></figure><p>构造函数只是单纯的跳到Initialize函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">HandleScope::<span class="hljs-built_in">HandleScope</span>(Isolate* isolate) &#123; <span class="hljs-built_in">Initialize</span>(isolate); &#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">HandleScope::Initialize</span><span class="hljs-params">(Isolate* isolate)</span> </span>&#123;<br>  i::Isolate* internal_isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(isolate);<br>   <span class="hljs-comment">// ApiCheck(),skip</span><br>  i::HandleScopeData* current = internal_isolate-&gt;<span class="hljs-built_in">handle_scope_data</span>();<br>  isolate_ = internal_isolate;<br>  prev_next_ = current-&gt;next;<br>  prev_limit_ = current-&gt;limit;<br>  current-&gt;level++;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">HandleScopeData* <span class="hljs-title">handle_scope_data</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> &amp;handle_scope_data_; &#125;<br>HandleScopeData handle_scope_data_;<br></code></pre></td></tr></table></figure><p>HandleScopeData是一个定义在<code>src/handles/handles.h</code>中的结构体</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HandleScopeData</span> <span class="hljs-keyword">final</span> &#123;<br>  Address* next;<br>  Address* limit;<br>  <span class="hljs-type">int</span> level;<br>  <span class="hljs-type">int</span> sealed_level;<br>  CanonicalHandleScope* canonical_scope;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Initialize</span><span class="hljs-params">()</span> </span>&#123;<br>    next = limit = <span class="hljs-literal">nullptr</span>;<br>    sealed_level = level = <span class="hljs-number">0</span>;<br>    canonical_scope = <span class="hljs-literal">nullptr</span>;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>析构函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">HandleScope::~<span class="hljs-built_in">HandleScope</span>() &#123;<br>  i::HandleScope::<span class="hljs-built_in">CloseScope</span>(isolate_, prev_next_, prev_limit_);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">HandleScope::CloseScope</span><span class="hljs-params">(Isolate* isolate, Address* prev_next,</span></span><br><span class="hljs-params"><span class="hljs-function">                             Address* prev_limit)</span> </span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEBUG</span><br>  <span class="hljs-type">int</span> before = FLAG_check_handle_count ? <span class="hljs-built_in">NumberOfHandles</span>(isolate) : <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-built_in">DCHECK_NOT_NULL</span>(isolate);<br>  HandleScopeData* current = isolate-&gt;<span class="hljs-built_in">handle_scope_data</span>();<br><br>  std::<span class="hljs-built_in">swap</span>(current-&gt;next, prev_next);<br>  current-&gt;level--;<br>  Address* limit = prev_next;<br>  <span class="hljs-keyword">if</span> (current-&gt;limit != prev_limit) &#123;<br>    current-&gt;limit = prev_limit;<br>    limit = prev_limit;<br>    <span class="hljs-built_in">DeleteExtensions</span>(isolate);<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> ENABLE_HANDLE_ZAPPING</span><br>  <span class="hljs-built_in">ZapRange</span>(current-&gt;next, limit);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-built_in">MSAN_ALLOCATED_UNINITIALIZED_MEMORY</span>(<br>      current-&gt;next,<br>      <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(<span class="hljs-built_in">reinterpret_cast</span>&lt;Address&gt;(limit) -<br>                          <span class="hljs-built_in">reinterpret_cast</span>&lt;Address&gt;(current-&gt;next)));<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEBUG</span><br>  <span class="hljs-type">int</span> after = FLAG_check_handle_count ? <span class="hljs-built_in">NumberOfHandles</span>(isolate) : <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">DCHECK_LT</span>(after - before, kCheckHandleThreshold);<br>  <span class="hljs-built_in">DCHECK_LT</span>(before, kCheckHandleThreshold);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/handles/handles-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/contexts-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/api/api-inl.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> i = v8::internal;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HandleScopeTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123; &#125;;<br><br><span class="hljs-built_in">TEST_F</span>(HandleScopeTest, HandleScopeData) &#123;<br>  i::Isolate* isolate = <span class="hljs-built_in">asInternal</span>(isolate_);<br>  <span class="hljs-function">i::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate)</span></span>;<br>  i::HandleScopeData data&#123;&#125;;<br>  data.<span class="hljs-built_in">Initialize</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data.next, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data.limit, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data.canonical_scope, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data.level, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data.sealed_level, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(HandleScopeTest, Create) &#123;<br>  i::Isolate* i_isolate = <span class="hljs-built_in">asInternal</span>(isolate_);<br>  i_isolate-&gt;<span class="hljs-built_in">handle_scope_data</span>()-&gt;<span class="hljs-built_in">Initialize</span>();<br>  i::HandleScope handle_scope&#123;i_isolate&#125;;<br>  i::Object obj&#123;<span class="hljs-number">18</span>&#125;;<br>  <span class="hljs-function">i::Handle&lt;i::Object&gt; <span class="hljs-title">handle</span><span class="hljs-params">(obj, i_isolate)</span></span>;<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(handle.<span class="hljs-built_in">is_null</span>());<br>  <span class="hljs-built_in">EXPECT_EQ</span>(*handle, obj);<br><br>  i::HandleScopeData* data = i_isolate-&gt;<span class="hljs-built_in">handle_scope_data</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(data-&gt;level, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(HandleScopeTest, HandleScopeImplementer) &#123;<br>  i::Isolate* i_isolate = <span class="hljs-built_in">asInternal</span>(isolate_);<br>  i::HandleScopeImplementer implementer&#123;i_isolate&#125;;<br>  <span class="hljs-comment">// Context is just a HeapObject so we can construct using the default not</span><br>  <span class="hljs-comment">// args constructor.</span><br>  i::Context context&#123;&#125;;<br><br>  implementer.<span class="hljs-built_in">SaveContext</span>(context);<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(implementer.<span class="hljs-built_in">HasSavedContexts</span>());<br><br>  implementer.<span class="hljs-built_in">EnterContext</span>(context);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(implementer.<span class="hljs-built_in">EnteredContextCount</span>()), <span class="hljs-number">1</span>);<br>  implementer.<span class="hljs-built_in">LeaveContext</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(implementer.<span class="hljs-built_in">EnteredContextCount</span>()), <span class="hljs-number">0</span>);<br><br>  i::DetachableVector&lt;i::Address*&gt;* blocks = implementer.<span class="hljs-built_in">blocks</span>();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(blocks-&gt;<span class="hljs-built_in">empty</span>());<br>  i::Address* block = implementer.<span class="hljs-built_in">GetSpareOrNewBlock</span>();<br>  blocks-&gt;<span class="hljs-built_in">push_back</span>(block);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(blocks-&gt;<span class="hljs-built_in">empty</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>让我们用Chrome V8的样例代码(<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/branch-heads/6.8/samples/hello-world.cc">samples/hello-world.cc</a>)来分析下它的作用：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;include/libplatform/libplatform.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;include/v8.h&quot;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> </span>&#123;<br>  <span class="hljs-comment">// Initialize V8.</span><br>  v8::V8::<span class="hljs-built_in">InitializeICUDefaultLocation</span>(argv[<span class="hljs-number">0</span>]);<br>  v8::V8::<span class="hljs-built_in">InitializeExternalStartupData</span>(argv[<span class="hljs-number">0</span>]);<br>  std::unique_ptr&lt;v8::Platform&gt; platform = v8::platform::<span class="hljs-built_in">NewDefaultPlatform</span>();<br>  v8::V8::<span class="hljs-built_in">InitializePlatform</span>(platform.<span class="hljs-built_in">get</span>());<br>  v8::V8::<span class="hljs-built_in">Initialize</span>();<br>  <span class="hljs-comment">// Create a new Isolate and make it the current one.</span><br>  v8::Isolate::CreateParams create_params;<br>  create_params.array_buffer_allocator =<br>      v8::ArrayBuffer::Allocator::<span class="hljs-built_in">NewDefaultAllocator</span>();<br>  v8::Isolate* isolate = v8::Isolate::<span class="hljs-built_in">New</span>(create_params);<br>  &#123;<br>    v8::<span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate)</span></span>;<br>    <span class="hljs-comment">// Create a stack-allocated handle scope.</span><br>    <span class="hljs-function">v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate)</span></span>;<br>    <span class="hljs-comment">// Create a new context.</span><br>    v8::Local&lt;v8::Context&gt; context = v8::Context::<span class="hljs-built_in">New</span>(isolate);<br>    <span class="hljs-comment">// Enter the context for compiling and running the hello world script.</span><br>    v8::<span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br>    <span class="hljs-comment">// Create a string containing the JavaScript source code.</span><br>    v8::Local&lt;v8::String&gt; source =<br>        v8::String::<span class="hljs-built_in">NewFromUtf8</span>(isolate, <span class="hljs-string">&quot;&#x27;Hello&#x27; + &#x27;, World!&#x27;&quot;</span>,<br>                                v8::NewStringType::kNormal)<br>            .<span class="hljs-built_in">ToLocalChecked</span>();<br>    <span class="hljs-comment">// Compile the source code.</span><br>    v8::Local&lt;v8::Script&gt; script =<br>        v8::Script::<span class="hljs-built_in">Compile</span>(context, source).<span class="hljs-built_in">ToLocalChecked</span>();<br>    <span class="hljs-comment">// Run the script to get the result.</span><br>    v8::Local&lt;v8::Value&gt; result = script-&gt;<span class="hljs-built_in">Run</span>(context).<span class="hljs-built_in">ToLocalChecked</span>();<br>    <span class="hljs-comment">// Convert the result to an UTF8 string and print it.</span><br>    v8::<span class="hljs-function">String::Utf8Value <span class="hljs-title">utf8</span><span class="hljs-params">(isolate, result)</span></span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, *utf8);<br>  &#125;<br>  <span class="hljs-comment">// Dispose the isolate and tear down V8.</span><br>  isolate-&gt;<span class="hljs-built_in">Dispose</span>();<br>  v8::V8::<span class="hljs-built_in">Dispose</span>();<br>  v8::V8::<span class="hljs-built_in">ShutdownPlatform</span>();<br>  <span class="hljs-keyword">delete</span> create_params.array_buffer_allocator;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在下图中，我们可以看到句柄堆栈和堆分配的对象。不妨在<code>v8::Local&lt;v8::Context&gt; context = v8::Context::New(isolate);</code>下面加上一句代码<code>Persistent&lt;Context&gt; persistent_context(isolate, context);</code>，便于理解持久句柄。</p><blockquote><p>图片来自<a target="_blank" rel="noopener external nofollow noreferrer" href="https://v8.dev/docs/embed">Getting started with embedding V8 · V8</a></p></blockquote><figure><img lazyload src="/img/loading.gif" data-src="https://v8.dev/_img/docs/embed/local-persist-handles-review.png" alt="句柄与句柄作用域"><figcaption aria-hidden="true">句柄与句柄作用域</figcaption></figure><ol type="1"><li><code>HandleScope handle_scope(isolate);</code> 创建一个句柄作用域，根据C++的特性，在它所处的作用域结束时，其生命周期也就结束了，这时候程序会自动调用它的析构函数。</li><li><code>Local&lt;Context&gt; context = Context::New(isolate);</code> 创建一个Context对象，并得到它的本地句柄。该句柄存在于<code>handle_scope</code>的句柄栈中，被这个HandleScope对象管理，同时它的真实对象存在于堆内存中，被GC盯着。</li><li><code>Persistent&lt;Context&gt; persistent_context(isolate, context);</code> 基于context我们创建一个新的持久句柄和<code>Context</code>对象，它不再受句柄作用域掌控，直接被GC管理。</li><li><code>Context::Scope context_scope(context);</code> 进入context以编译和执行hello world脚本。</li><li><code>Local&lt;String&gt; source = String::NewFromUtf8(...).ToLocalChecked();</code> 将一段JavaScript代码赋值给一个V8字符串，并得到句柄。</li><li><code>Local&lt;Script&gt; script = Script::Compile(context, source).ToLocalChecked();</code> 编译代码。</li><li><code>Local&lt;Value&gt; result = script-&gt;Run(context).ToLocalChecked();</code> 执行代码。</li></ol><p>最后，当HandleScope的析构函数被调用时，这些在这个句柄作用域中被创建的句柄和对象如果没有其他地方有引用的话，就会在下一次垃圾回收的时候被处理掉。不过我们创建的那个持久句柄并不会在析构时被动手，我们只能显式的调用Reset清除它。</p><h2 id="可逃句柄作用域escapable-handle-scope">可逃句柄作用域（Escapable Handle Scope）</h2><p>根据上文所说，如果一个函数有一个 HandleScope 并且想要返回一个本地句柄，它在函数返回后将不可用。这就是<code>EscapableHandleScope</code>的作用了，它有一个<code>Escape</code>函数，可以给一个句柄以豁免权，将其复制到一个封闭的作用域中并删除其他的本地句柄，然后返回这个新复制的可以安全返回的句柄。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> V8_NODISCARD EscapableHandleScope : <span class="hljs-keyword">public</span> HandleScope &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">EscapableHandleScope</span><span class="hljs-params">(Isolate* isolate)</span></span>;<br>  V8_INLINE ~<span class="hljs-built_in">EscapableHandleScope</span>() = <span class="hljs-keyword">default</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Pushes the value into the previous scope and returns a handle to it.</span><br><span class="hljs-comment">   * Cannot be called twice.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br>  <span class="hljs-function">V8_INLINE Local&lt;T&gt; <span class="hljs-title">Escape</span><span class="hljs-params">(Local&lt;T&gt; value)</span> </span>&#123;<br>    internal::Address* slot =<br>        <span class="hljs-built_in">Escape</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;internal::Address*&gt;(*value));<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Local</span>&lt;T&gt;(<span class="hljs-built_in">reinterpret_cast</span>&lt;T*&gt;(slot));<br>  &#125;<br><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br>  <span class="hljs-function">V8_INLINE MaybeLocal&lt;T&gt; <span class="hljs-title">EscapeMaybe</span><span class="hljs-params">(MaybeLocal&lt;T&gt; value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Escape</span>(value.<span class="hljs-built_in">FromMaybe</span>(<span class="hljs-built_in">Local</span>&lt;T&gt;()));<br>  &#125;<br><br>  <span class="hljs-built_in">EscapableHandleScope</span>(<span class="hljs-type">const</span> EscapableHandleScope&amp;) = <span class="hljs-keyword">delete</span>;<br>  <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> EscapableHandleScope&amp;) = <span class="hljs-keyword">delete</span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// Declaring operator new and delete as deleted is not spec compliant.</span><br>  <span class="hljs-comment">// Therefore declare them private instead to disable dynamic alloc</span><br>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span>;<br>  <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span> size);<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>)</span></span>;<br>  <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>);<br><br>  <span class="hljs-function">internal::Address* <span class="hljs-title">Escape</span><span class="hljs-params">(internal::Address* escape_value)</span></span>;<br>  internal::Address* escape_slot_;<br>&#125;;<br></code></pre></td></tr></table></figure><p>构造函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">EscapableHandleScope::<span class="hljs-built_in">EscapableHandleScope</span>(Isolate* v8_isolate) &#123;<br>  i::Isolate* isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(v8_isolate);<br>  escape_slot_ = <span class="hljs-built_in">CreateHandle</span>(isolate, i::<span class="hljs-built_in">ReadOnlyRoots</span>(isolate).<span class="hljs-built_in">the_hole_value</span>().<span class="hljs-built_in">ptr</span>());<br>  <span class="hljs-built_in">Initialize</span>(v8_isolate);<br>&#125;<br></code></pre></td></tr></table></figure><p>当一个<code>EscapableHandleScope</code>被创建的时候它会创建一个带有<code>the_hole_value</code>的Handle并将其存在Address中。后续作用域可以设置需要逃逸的指针地址，当到期时正常设置一个新的HandleScope。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">i::Address* <span class="hljs-title">HandleScope::CreateHandle</span><span class="hljs-params">(i::Isolate* isolate, i::Address value)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> i::HandleScope::<span class="hljs-built_in">CreateHandle</span>(isolate, value);<br>&#125;<br></code></pre></td></tr></table></figure><p>定义在<code>handles-inl.h</code>中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">Address* <span class="hljs-title">HandleScope::CreateHandle</span><span class="hljs-params">(Isolate* isolate, Address value)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(AllowHandleAllocation::<span class="hljs-built_in">IsAllowed</span>());<br>  HandleScopeData* data = isolate-&gt;<span class="hljs-built_in">handle_scope_data</span>();<br>  Address* result = data-&gt;next;<br>  <span class="hljs-keyword">if</span> (result == data-&gt;limit) &#123;<br>    result = <span class="hljs-built_in">Extend</span>(isolate);<br>  &#125;<br>  <span class="hljs-comment">// Update the current next field, set the value in the created handle,</span><br>  <span class="hljs-comment">// and return the result.</span><br>  <span class="hljs-built_in">DCHECK_LT</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;Address&gt;(result),<br>            <span class="hljs-built_in">reinterpret_cast</span>&lt;Address&gt;(data-&gt;limit));<br>  data-&gt;next = <span class="hljs-built_in">reinterpret_cast</span>&lt;Address*&gt;(<span class="hljs-built_in">reinterpret_cast</span>&lt;Address&gt;(result) +<br>                                          <span class="hljs-built_in">sizeof</span>(Address));<br>  *result = value;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>Escape函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">i::Address* <span class="hljs-title">EscapableHandleScope::Escape</span><span class="hljs-params">(i::Address* escape_value)</span> </span>&#123;<br>  i::Heap* heap = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(<span class="hljs-built_in">GetIsolate</span>())-&gt;<span class="hljs-built_in">heap</span>();<br>  Utils::<span class="hljs-built_in">ApiCheck</span>(i::<span class="hljs-built_in">Object</span>(*escape_slot_).<span class="hljs-built_in">IsTheHole</span>(heap-&gt;<span class="hljs-built_in">isolate</span>()),<br>                  <span class="hljs-string">&quot;EscapableHandleScope::Escape&quot;</span>, <span class="hljs-string">&quot;Escape value set twice&quot;</span>);<br>  <span class="hljs-keyword">if</span> (escape_value == <span class="hljs-literal">nullptr</span>) &#123;<br>    *escape_slot_ = i::<span class="hljs-built_in">ReadOnlyRoots</span>(heap).<span class="hljs-built_in">undefined_value</span>().<span class="hljs-built_in">ptr</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br>  *escape_slot_ = *escape_value;<br>  <span class="hljs-keyword">return</span> escape_slot_;<br>&#125;<br></code></pre></td></tr></table></figure><p>样例代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// This function returns a new array with three elements, x, y, and z.</span><br><span class="hljs-function">Local&lt;Array&gt; <span class="hljs-title">NewPointArray</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> z)</span> </span>&#123;<br>  v8::Isolate* isolate = v8::Isolate::<span class="hljs-built_in">GetCurrent</span>();<br><br>  <span class="hljs-comment">// We will be creating temporary handles so we use a handle scope.</span><br>  <span class="hljs-function">v8::EscapableHandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate)</span></span>;<br><br>  <span class="hljs-comment">// Create a new empty array.</span><br>  v8::Local&lt;v8::Array&gt; array = v8::Array::<span class="hljs-built_in">New</span>(isolate, <span class="hljs-number">3</span>);<br><br>  <span class="hljs-comment">// Return an empty result if there was an error creating the array.</span><br>  <span class="hljs-keyword">if</span> (array.<span class="hljs-built_in">IsEmpty</span>())<br>    <span class="hljs-keyword">return</span> v8::<span class="hljs-built_in">Local</span>&lt;v8::Array&gt;();<br><br>  <span class="hljs-comment">// Fill out the values</span><br>  array-&gt;<span class="hljs-built_in">Set</span>(<span class="hljs-number">0</span>, Integer::<span class="hljs-built_in">New</span>(isolate, x));<br>  array-&gt;<span class="hljs-built_in">Set</span>(<span class="hljs-number">1</span>, Integer::<span class="hljs-built_in">New</span>(isolate, y));<br>  array-&gt;<span class="hljs-built_in">Set</span>(<span class="hljs-number">2</span>, Integer::<span class="hljs-built_in">New</span>(isolate, z));<br><br>  <span class="hljs-comment">// Return the value through Escape.</span><br>  <span class="hljs-keyword">return</span> handle_scope.<span class="hljs-built_in">Escape</span>(array);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="上下文context">上下文（Context）</h1><p>上下文是Chrome V8中的JavaScript代码执行环境，所以当你想执行JavaScript代码的时候，必须为其指定一个Context：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;Script&gt; script = Script::<span class="hljs-built_in">Compile</span>(context, source).<span class="hljs-built_in">ToLocalChecked</span>();<br></code></pre></td></tr></table></figure><p>在Chrome V8中，除了Isolate实例是各自独立的，上下文也是独立且允许存在多个的。在同一个Isolate中，不同的上下文也是不相干的，其可以执行各自的JavaScript代码。</p><p>上下文对象在堆上分配，因此应该是Data对象。这允许通过 API 在 GC 中进行跟踪来处理它们。具体可以参见<code>v8.h</code>中的定义<code>class V8_EXPORT Context : public Data {...}</code></p><p>从CPU运行时间和内存的角度来看，创建一个新的执行上下文的开销很大，但是V8的缓存机制让这个操作在第二次、第三次以及更多次数的时候让开销变小很多。原因在于这个开销的大头是解析“创建内置对象的JavaScript代码”。在第一次创建成功之后，下次创建就不需要再解析这些代码，而是直接执行这些代码来创建内置对象。与此同时，如果在编译V8的时候加入编译选项<code>snapshop=yes</code>的话，这些创建好的内置对象会被放入快照中，可在创建上下文的时候直接到快照中取。这就是Chrome V8高效的另一方面的体现了——善用缓存。具体细节会在之后的文章中探讨（<code>src/snapshot/snapshot.cc</code>)。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;Context&gt; context = Context::<span class="hljs-built_in">FromSnapshot</span>(isolate, index).<span class="hljs-built_in">ToLocalChecked</span>();<br></code></pre></td></tr></table></figure><p>创建一个Context后我们可以多次进入或退出它，当我们在Context A时也可以切换成不同的Context B，当退出B时返回A，如下图：</p><figure><img lazyload src="/img/loading.gif" data-src="https://v8.dev/_img/docs/embed/intro-contexts.png" alt="intro-contexts"><figcaption aria-hidden="true">intro-contexts</figcaption></figure><p>需要注意的是每个上下文的内置函数和对象都是分离的，当我们创建上下文时可以设置security token，具体请参阅<a target="_blank" rel="noopener" href="https://v8.dev/docs/embed#security-model">Security Model</a>。</p><h1 id="模板template">模板（Template）</h1><p>这里的模板可不是值C++中的模板，Chrome V8中的模板指的是在上下文中JavaScript对象以及函数的一个模具。你可以用一个模板来把C++函数或者数据结构包裹进JavaScript的对象中，这样JavaScript就能对它做一些不可描述的事情了。实际上Google Chrome中的DOM节点就是用C++完成，然后再用模板包裹成JavaScript对象，这样我们就能在浏览器中使用JavaScript来对它们进行操作了。</p><p>模板是一个对象模板和函数模板的超类，需要注意的是在JavaScript中函数也能和对象一样拥有属性字段。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> Template : <span class="hljs-keyword">public</span> Data &#123;<br> <span class="hljs-keyword">public</span>:<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(Local&lt;Name&gt; name, Local&lt;Data&gt; value,</span></span><br><span class="hljs-params"><span class="hljs-function">           PropertyAttribute attributes = None)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetPrivate</span><span class="hljs-params">(Local&lt;Private&gt; name, Local&lt;Data&gt; value,</span></span><br><span class="hljs-params"><span class="hljs-function">                  PropertyAttribute attributes = None)</span></span>;<br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(Isolate* isolate, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, Local&lt;Data&gt; value)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetAccessorProperty</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">     Local&lt;Name&gt; name,</span></span><br><span class="hljs-params"><span class="hljs-function">     Local&lt;FunctionTemplate&gt; getter = Local&lt;FunctionTemplate&gt;(),</span></span><br><span class="hljs-params"><span class="hljs-function">     Local&lt;FunctionTemplate&gt; setter = Local&lt;FunctionTemplate&gt;(),</span></span><br><span class="hljs-params"><span class="hljs-function">     PropertyAttribute attribute = None,</span></span><br><span class="hljs-params"><span class="hljs-function">     AccessControl settings = DEFAULT)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetNativeDataProperty</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;String&gt; name, AccessorGetterCallback getter,</span></span><br><span class="hljs-params"><span class="hljs-function">      AccessorSetterCallback setter = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Value&gt; data = Local&lt;Value&gt;(), PropertyAttribute attribute = None,</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;AccessorSignature&gt; signature = Local&lt;AccessorSignature&gt;(),</span></span><br><span class="hljs-params"><span class="hljs-function">      AccessControl settings = DEFAULT,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType getter_side_effect_type = SideEffectType::kHasSideEffect,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType setter_side_effect_type = SideEffectType::kHasSideEffect)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetNativeDataProperty</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Name&gt; name, AccessorNameGetterCallback getter,</span></span><br><span class="hljs-params"><span class="hljs-function">      AccessorNameSetterCallback setter = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Value&gt; data = Local&lt;Value&gt;(), PropertyAttribute attribute = None,</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;AccessorSignature&gt; signature = Local&lt;AccessorSignature&gt;(),</span></span><br><span class="hljs-params"><span class="hljs-function">      AccessControl settings = DEFAULT,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType getter_side_effect_type = SideEffectType::kHasSideEffect,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType setter_side_effect_type = SideEffectType::kHasSideEffect)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetLazyDataProperty</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Name&gt; name, AccessorNameGetterCallback getter,</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Value&gt; data = Local&lt;Value&gt;(), PropertyAttribute attribute = None,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType getter_side_effect_type = SideEffectType::kHasSideEffect,</span></span><br><span class="hljs-params"><span class="hljs-function">      SideEffectType setter_side_effect_type = SideEffectType::kHasSideEffect)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetIntrinsicDataProperty</span><span class="hljs-params">(Local&lt;Name&gt; name, Intrinsic intrinsic,</span></span><br><span class="hljs-params"><span class="hljs-function">                                PropertyAttribute attribute = None)</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-built_in">Template</span>();<br><br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectTemplate</span>;<br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionTemplate</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>Set</code>函数可用于在从此模板创建的实例上设置名字和值，<code>SetAccessorProperty</code>函数用于获取或设置属性。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PropertyAttribute</span> &#123;<br>  <span class="hljs-comment">/** None. **/</span><br>  None = <span class="hljs-number">0</span>,<br>  <span class="hljs-comment">/** ReadOnly, i.e., not writable. **/</span><br>  ReadOnly = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,<br>  <span class="hljs-comment">/** DontEnum, i.e., not enumerable. **/</span><br>  DontEnum = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,<br>  <span class="hljs-comment">/** DontDelete, i.e., not configurable. **/</span><br>  DontDelete = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span><br>&#125;;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">AccessControl</span> &#123;<br>  DEFAULT               = <span class="hljs-number">0</span>,<br>  ALL_CAN_READ          = <span class="hljs-number">1</span>,<br>  ALL_CAN_WRITE         = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,<br>  PROHIBITS_OVERWRITING = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>本文主要介绍两种模板，这两种模板均继承自Template：</p><ul><li>函数模板（Function Template）</li><li>对象模板（Object Template）</li></ul><h2 id="函数模板function-template">函数模板（Function Template）</h2><p>函数模板在Chrome V8中的数据类型是FunctionTemplate。它是一个JavaScript函数的模具。当生成一个函数模板后，我们通过调用它的<code>GetFunction</code>方法来获取其函数具体句柄，这个函数可以被JavaScript调用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> FunctionTemplate : <span class="hljs-keyword">public</span> Template &#123; ... &#125;<br></code></pre></td></tr></table></figure><p>可以用下述方法定义</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;FunctionTemplate&gt; ft = FunctionTemplate::<span class="hljs-built_in">New</span>(isolate_, function_callback, data);<br>Local&lt;Function&gt; function = ft-&gt;<span class="hljs-built_in">GetFunction</span>(context).<span class="hljs-built_in">ToLocalChecked</span>();<br></code></pre></td></tr></table></figure><p>同时这样调用函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">MaybeLocal&lt;Value&gt; ret = function-&gt;<span class="hljs-built_in">Call</span>(context, recv, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>);<br></code></pre></td></tr></table></figure><p><code>Function::Call</code> 能在 <code>src/api/api.cc</code>中找到</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;v8::Value&gt; <span class="hljs-title">Function::Call</span><span class="hljs-params">(Local&lt;Context&gt; context,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     v8::Local&lt;v8::Value&gt; recv, <span class="hljs-type">int</span> argc,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     v8::Local&lt;v8::Value&gt; argv[])</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(context-&gt;<span class="hljs-built_in">GetIsolate</span>());<br>  <span class="hljs-built_in">TRACE_EVENT_CALL_STATS_SCOPED</span>(isolate, <span class="hljs-string">&quot;v8&quot;</span>, <span class="hljs-string">&quot;V8.Execute&quot;</span>);<br>  <span class="hljs-built_in">ENTER_V8</span>(isolate, context, Function, Call, <span class="hljs-built_in">MaybeLocal</span>&lt;Value&gt;(),<br>           InternalEscapableScope);<br>  <span class="hljs-function">i::TimerEventScope&lt;i::TimerEventExecute&gt; <span class="hljs-title">timer_scope</span><span class="hljs-params">(isolate)</span></span>;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  Utils::<span class="hljs-built_in">ApiCheck</span>(!self.<span class="hljs-built_in">is_null</span>(), <span class="hljs-string">&quot;v8::Function::Call&quot;</span>,<br>                  <span class="hljs-string">&quot;Function to be called is a null pointer&quot;</span>);<br>  i::Handle&lt;i::Object&gt; recv_obj = Utils::<span class="hljs-built_in">OpenHandle</span>(*recv);<br>  <span class="hljs-built_in">STATIC_ASSERT</span>(<span class="hljs-built_in">sizeof</span>(v8::Local&lt;v8::Value&gt;) == <span class="hljs-built_in">sizeof</span>(i::Handle&lt;i::Object&gt;));<br>  i::Handle&lt;i::Object&gt;* args = <span class="hljs-keyword">reinterpret_cast</span>&lt;i::Handle&lt;i::Object&gt;*&gt;(argv);<br>  Local&lt;Value&gt; result;<br>  has_pending_exception = !<span class="hljs-built_in">ToLocal</span>&lt;Value&gt;(<br>      i::Execution::<span class="hljs-built_in">Call</span>(isolate, self, recv_obj, argc, args), &amp;result);<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(Value);<br>  <span class="hljs-built_in">RETURN_ESCAPED</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们可以看到<code>Call</code>的返回值是一个<code>MaybeHandle&lt;Object&gt;</code>，会被传给定义在<code>api.h</code>内的<code>ToLocal</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ToLocal</span><span class="hljs-params">(v8::internal::MaybeHandle&lt;v8::internal::Object&gt; maybe,</span></span><br><span class="hljs-params"><span class="hljs-function">                    Local&lt;T&gt;* local)</span> </span>&#123;<br>  v8::internal::Handle&lt;v8::internal::Object&gt; handle;<br>  <span class="hljs-keyword">if</span> (maybe.<span class="hljs-built_in">ToHandle</span>(&amp;handle)) &#123;<br>    *local = Utils::<span class="hljs-built_in">Convert</span>&lt;v8::internal::Object, T&gt;(handle);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Execution:Call</code>定义在<code>execution/execution.cc</code>中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++]">MaybeHandle&lt;Object&gt; Execution::Call(Isolate* isolate, Handle&lt;Object&gt; callable,<br>                                    Handle&lt;Object&gt; receiver, int argc,<br>                                    Handle&lt;Object&gt; argv[]) &#123;<br>  return Invoke(isolate, InvokeParams::SetUpForCall(isolate, callable, receiver,<br>                                                    argc, argv));<br>&#125;<br></code></pre></td></tr></table></figure><p><code>SetUpForCall</code> 返回一个 <code>InvokeParams</code>.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">V8_WARN_UNUSED_RESULT MaybeHandle&lt;Object&gt; <span class="hljs-title">Invoke</span><span class="hljs-params">(Isolate* isolate,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 <span class="hljs-type">const</span> InvokeParams&amp; params)</span> </span><br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">Handle&lt;Object&gt; receiver = params.is_construct                             <br>                                    ? isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">the_hole_value</span>()         <br>                                    : params.receiver; <br></code></pre></td></tr></table></figure><p>当抛出异常时<code>Invoke</code>会返回一个空对象</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span> value = Builtins::<span class="hljs-built_in">InvokeApiFunction</span>(<br>    isolate, params.is_construct, function, receiver, params.argc,<br>    params.argv, Handle&lt;HeapObject&gt;::<span class="hljs-built_in">cast</span>(params.new_target));<br><span class="hljs-type">bool</span> has_exception = value.<span class="hljs-built_in">is_null</span>();<br><span class="hljs-built_in">DCHECK</span>(has_exception == isolate-&gt;<span class="hljs-built_in">has_pending_exception</span>());<br><span class="hljs-keyword">if</span> (has_exception) &#123;<br>  <span class="hljs-keyword">if</span> (params.message_handling == Execution::MessageHandling::kReport) &#123;<br>    isolate-&gt;<span class="hljs-built_in">ReportPendingMessages</span>();<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">MaybeHandle</span>&lt;Object&gt;();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  isolate-&gt;<span class="hljs-built_in">clear_pending_message</span>();<br>&#125;<br><span class="hljs-keyword">return</span> value;<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libplatform/libplatform.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/api/api-inl.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> v8;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionTemplateTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">function_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; info)</span> </span>&#123;<br>  Isolate* isolate = info.<span class="hljs-built_in">GetIsolate</span>();<br>  std::cout &lt;&lt; <span class="hljs-string">&quot;function_callback args= &quot;</span> &lt;&lt; info.<span class="hljs-built_in">Length</span>() &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br><br>  <span class="hljs-comment">// If the function was called using the new operator the property</span><br>  <span class="hljs-comment">// new.target(NewTarget) will be set.</span><br>  Local&lt;Value&gt; new_target_value = info.<span class="hljs-built_in">NewTarget</span>();<br>  <span class="hljs-keyword">if</span> (new_target_value.<span class="hljs-built_in">IsEmpty</span>()) &#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;new_target_value is undefined: &quot;</span> &lt;&lt; new_target_value-&gt;<span class="hljs-built_in">IsUndefined</span>() &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br>  &#125;<br>  <span class="hljs-comment">// This is the receiver passed as the second argument to the Call function,</span><br>  <span class="hljs-comment">// which is like the this.</span><br>  Local&lt;Object&gt; receiver = info.<span class="hljs-built_in">This</span>();<br>  Local&lt;Name&gt; name = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate, <span class="hljs-string">&quot;nr&quot;</span>, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;Value&gt; nr_local = receiver-&gt;<span class="hljs-built_in">GetRealNamedProperty</span>(isolate-&gt;<span class="hljs-built_in">GetCurrentContext</span>(), name).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;Number&gt; nr = nr_local-&gt;<span class="hljs-built_in">ToNumber</span>(isolate-&gt;<span class="hljs-built_in">GetCurrentContext</span>()).<span class="hljs-built_in">ToLocalChecked</span>();<br><br>  Local&lt;Object&gt; holder = info.<span class="hljs-built_in">Holder</span>();<br><br>  ReturnValue&lt;Value&gt; return_value = info.<span class="hljs-built_in">GetReturnValue</span>();<br>  <span class="hljs-type">double</span> nr2 = nr-&gt;<span class="hljs-built_in">Value</span>() + <span class="hljs-number">2</span>;<br>  return_value.<span class="hljs-built_in">Set</span>(nr2);<br><br>  <span class="hljs-built_in">EXPECT_STREQ</span>(*String::<span class="hljs-built_in">Utf8Value</span>(isolate, info.<span class="hljs-built_in">Data</span>()), <span class="hljs-string">&quot;some info&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(FunctionTemplateTest, FunctionTemplate) &#123;<br>  i::Isolate* i_isolate = V8TestFixture::<span class="hljs-built_in">asInternal</span>(isolate_);<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  <span class="hljs-comment">// This value, data, will be made available via the FunctionCallbackInfo:</span><br>  Local&lt;Value&gt; data = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, <span class="hljs-string">&quot;some info&quot;</span>, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;FunctionTemplate&gt; ft = FunctionTemplate::<span class="hljs-built_in">New</span>(isolate_, function_callback, data);<br>  Local&lt;Function&gt; function = ft-&gt;<span class="hljs-built_in">GetFunction</span>(context).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;String&gt; func_name = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, <span class="hljs-string">&quot;SomeFunc&quot;</span>, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  function-&gt;<span class="hljs-built_in">SetName</span>(func_name);<br>  Local&lt;Value&gt; prototype = function-&gt;<span class="hljs-built_in">GetPrototype</span>();<br>  V8TestFixture::<span class="hljs-built_in">print_local</span>(prototype);<br><br>  Local&lt;Object&gt; recv = Object::<span class="hljs-built_in">New</span>(isolate_);<br>  Local&lt;Name&gt; name = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, <span class="hljs-string">&quot;nr&quot;</span>, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;Number&gt; value = Number::<span class="hljs-built_in">New</span>(isolate_, <span class="hljs-number">18</span>);<br>  recv-&gt;<span class="hljs-built_in">Set</span>(context, name, value).<span class="hljs-built_in">Check</span>();<br><br>  <span class="hljs-type">int</span> argc = <span class="hljs-number">0</span>;<br>  Local&lt;Value&gt; argv[] = &#123;&#125;; <br>  MaybeLocal&lt;Value&gt; ret = function-&gt;<span class="hljs-built_in">Call</span>(context, recv, argc, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-keyword">if</span> (!ret.<span class="hljs-built_in">IsEmpty</span>()) &#123;<br>    Local&lt;Number&gt; nr = ret.<span class="hljs-built_in">ToLocalChecked</span>()-&gt;<span class="hljs-built_in">ToNumber</span>(context).<span class="hljs-built_in">ToLocalChecked</span>();<br>    <span class="hljs-built_in">EXPECT_EQ</span>(nr-&gt;<span class="hljs-built_in">Value</span>(), <span class="hljs-number">20</span>);<br>  &#125;<br><br>  i::RootsTable roots_table = i_isolate-&gt;<span class="hljs-built_in">roots_table</span>();<br>  i::Heap* heap = i_isolate-&gt;<span class="hljs-built_in">heap</span>();<br><br>  <span class="hljs-comment">//Local&lt;Function&gt; function2 = ft-&gt;GetFunction(context).ToLocalChecked();</span><br>  <span class="hljs-comment">//MaybeLocal&lt;Value&gt; ret = function-&gt;Call(context, recv, 0, nullptr);</span><br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(FunctionTemplateTest, FunctionTemplateInfo) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_);<br>  <span class="hljs-function">Context::Scope <span class="hljs-title">context_scope</span><span class="hljs-params">(context)</span></span>;<br><br>  <span class="hljs-comment">// This value, data, will be made available via the FunctionCallbackInfo:</span><br>  Local&lt;Value&gt; data = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, <span class="hljs-string">&quot;some info&quot;</span>, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;FunctionTemplate&gt; ft = FunctionTemplate::<span class="hljs-built_in">New</span>(isolate_, function_callback, data);<br>  i::Handle&lt;i::FunctionTemplateInfo&gt; ft_info = i::<span class="hljs-built_in">Handle</span>&lt;i::FunctionTemplateInfo&gt;(<br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Address*&gt;(<span class="hljs-built_in">const_cast</span>&lt;FunctionTemplate*&gt;(*ft)));<br>  i::Isolate* i_isolate = V8TestFixture::<span class="hljs-built_in">asInternal</span>(isolate_);<br>  i::Handle&lt;i::SharedFunctionInfo&gt; sfi = i::FunctionTemplateInfo::<span class="hljs-built_in">GetOrCreateSharedFunctionInfo</span>(<br>      i_isolate, ft_info, i::<span class="hljs-built_in">MaybeHandle</span>&lt;i::Name&gt;());<br>  <span class="hljs-comment">//std::cout &lt;&lt; sfi-&gt;Name() &lt;&lt; &#x27;\n&#x27;;</span><br>  <span class="hljs-comment">//ft_info-&gt;GetCFunction(i_isolate);</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="对象模板object-template">对象模板（Object Template）</h2><p>每个函数模板都有一个相关联的对象模板，这用于配置使用此函数创建的对象作为其构造函数。对象模板用于在运行时创建对象，从对象模板被创建的对象会被挂上被加到这个模板中的属性，大概类似于<code>const obj = {};</code></p><p>定义在<code>include/v8.h</code>中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> ObjectTemplate : <span class="hljs-keyword">public</span> Template &#123;<br>  ...<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> Template : <span class="hljs-keyword">public</span> Data &#123;<br>  ...<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> Data &#123;<br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-built_in">Data</span>();  <br>&#125;;<br></code></pre></td></tr></table></figure><p>我们创建一个对象模板的实例之后就可以给它添加属性，这样每个用该实例创建的对象实例都会带有该属性。此操作通过<code>Template</code>类中的成员函数<code>Set</code>实现，在<code>src/api/api.cc</code>中定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Template::Set</span><span class="hljs-params">(v8::Local&lt;Name&gt; name, v8::Local&lt;Data&gt; value,</span></span><br><span class="hljs-params"><span class="hljs-function">                   v8::PropertyAttribute attribute)</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> templ = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  i::Isolate* isolate = templ-&gt;<span class="hljs-built_in">GetIsolate</span>();<br>  <span class="hljs-built_in">ENTER_V8_NO_SCRIPT_NO_EXCEPTION</span>(isolate);<br>  <span class="hljs-function">i::HandleScope <span class="hljs-title">scope</span><span class="hljs-params">(isolate)</span></span>;<br>  <span class="hljs-keyword">auto</span> value_obj = Utils::<span class="hljs-built_in">OpenHandle</span>(*value);<br><br>  Utils::<span class="hljs-built_in">ApiCheck</span>(!value_obj-&gt;<span class="hljs-built_in">IsJSReceiver</span>() || value_obj-&gt;<span class="hljs-built_in">IsTemplateInfo</span>(),<br>                  <span class="hljs-string">&quot;v8::Template::Set&quot;</span>,<br>                  <span class="hljs-string">&quot;Invalid value, must be a primitive or a Template&quot;</span>);<br><br>  <span class="hljs-comment">// The template cache only performs shallow clones, if we set an</span><br>  <span class="hljs-comment">// ObjectTemplate as a property value then we can not cache the receiver</span><br>  <span class="hljs-comment">// template.</span><br>  <span class="hljs-keyword">if</span> (value_obj-&gt;<span class="hljs-built_in">IsObjectTemplateInfo</span>()) &#123;<br>    templ-&gt;<span class="hljs-built_in">set_serial_number</span>(i::TemplateInfo::kDoNotCache);<br>  &#125;<br><br>  i::ApiNatives::<span class="hljs-built_in">AddDataProperty</span>(isolate, templ, Utils::<span class="hljs-built_in">OpenHandle</span>(*name),<br>                                 value_obj,<br>                                 <span class="hljs-built_in">static_cast</span>&lt;i::PropertyAttributes&gt;(attribute));<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Name</code>是<code>Symbol</code>和<code>String</code>的超类，它们都可以用作属性的名称。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">Private::Name</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-type">const</span> Symbol* sym = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Symbol*&gt;(<span class="hljs-keyword">this</span>);<br>  i::Handle&lt;i::Symbol&gt; i_sym = Utils::<span class="hljs-built_in">OpenHandle</span>(sym);<br>  <span class="hljs-comment">// v8::Private symbols are created by API and are therefore writable, so we</span><br>  <span class="hljs-comment">// can always recover an Isolate.</span><br>  i::Isolate* isolate = i::<span class="hljs-built_in">GetIsolateFromWritableObject</span>(*i_sym);<br>  <span class="hljs-keyword">return</span> sym-&gt;<span class="hljs-built_in">Description</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;Isolate*&gt;(isolate));<br>&#125;<br></code></pre></td></tr></table></figure><p>样例代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libplatform/libplatform.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/api/api.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> v8;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectTemplateTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-built_in">TEST_F</span>(ObjectTemplateTest, AddProperty) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;FunctionTemplate&gt; constructor = <span class="hljs-built_in">Local</span>&lt;FunctionTemplate&gt;();<br>  Local&lt;ObjectTemplate&gt; ot = ObjectTemplate::<span class="hljs-built_in">New</span>(isolate_, constructor);<br><br>  <span class="hljs-comment">// Add a property that all instanced created from this object template will</span><br>  <span class="hljs-comment">// have. (Set is member function of class Template):</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* prop_name = <span class="hljs-string">&quot;prop_name&quot;</span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* prop_value = <span class="hljs-string">&quot;prop_value&quot;</span>;<br>  Local&lt;Name&gt; name = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, prop_name, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;Data&gt; value = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, prop_value, NewStringType::kNormal).<span class="hljs-built_in">ToLocalChecked</span>();<br>  ot-&gt;<span class="hljs-built_in">Set</span>(name, value, PropertyAttribute::None);<br><br>  Handle&lt;Context&gt; context = Context::<span class="hljs-built_in">New</span>(isolate_, <span class="hljs-literal">nullptr</span>, ot);<br>  MaybeLocal&lt;Object&gt; maybe_instance = ot-&gt;<span class="hljs-built_in">NewInstance</span>(context);<br>  Local&lt;Object&gt; obj = maybe_instance.<span class="hljs-built_in">ToLocalChecked</span>();<br><br>  <span class="hljs-comment">// Verify that the property we added exist in the instance we created:</span><br>  MaybeLocal&lt;Array&gt; maybe_names = obj-&gt;<span class="hljs-built_in">GetPropertyNames</span>(context);<br>  Local&lt;Array&gt; names = maybe_names.<span class="hljs-built_in">ToLocalChecked</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(names-&gt;<span class="hljs-built_in">Length</span>()), <span class="hljs-number">1</span>);<br>  <span class="hljs-comment">// If found it iteresting that Array does not have any methods except Length()</span><br>  <span class="hljs-comment">// and thress static methods (New, New, and Cast). Since Array extends Object</span><br>  <span class="hljs-comment">// we can use Object::Get with the index:</span><br>  Local&lt;Value&gt; name_from_array = names-&gt;<span class="hljs-built_in">Get</span>(context, <span class="hljs-number">0</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  String::Utf8Value utf8_name&#123;isolate_, name_from_array&#125;;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(*utf8_name, prop_name);<br><br>  <span class="hljs-comment">// Verify the value is correct.</span><br>  Local&lt;Value&gt; val = obj-&gt;<span class="hljs-built_in">GetRealNamedProperty</span>(context, name).<span class="hljs-built_in">ToLocalChecked</span>();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(val-&gt;<span class="hljs-built_in">IsName</span>());<br>  String::Utf8Value utf8_value&#123;isolate_, val&#125;;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(*utf8_value, prop_value);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="访问器accessor与拦截器interceptor">访问器（Accessor）与拦截器（Interceptor）</h3><p>访问器与拦截器是对象模板中两种不同的C++回调函数：</p><ul><li>访问器的回调函数会在模板对象生成的对象中指定属性被访问时执行</li><li>拦截器的回调函数会在模板对象生成的对象中任何属性被访问时执行</li></ul><p>可以使用ObjectTemplate的SetAccessor函数为对象模板或者对象创建一个访问器：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ObjectTemplate::SetAccessor</span><span class="hljs-params">(v8::Local&lt;String&gt; name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 AccessorGetterCallback getter,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 AccessorSetterCallback setter,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 v8::Local&lt;Value&gt; data, AccessControl settings,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 PropertyAttribute attribute,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 v8::Local&lt;AccessorSignature&gt; signature,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 SideEffectType getter_side_effect_type,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 SideEffectType setter_side_effect_type)</span> </span>&#123;<br>  <span class="hljs-built_in">TemplateSetAccessor</span>(<span class="hljs-keyword">this</span>, name, getter, setter, data, settings, attribute,<br>                      signature, i::FLAG_disable_old_api_accessors, <span class="hljs-literal">false</span>,<br>                      getter_side_effect_type, setter_side_effect_type);<br>&#125;<br></code></pre></td></tr></table></figure><p>其中name是访问器的属性名，getter是访问器的get函数，setter是访问器的set函数，其类型也可以为<code>v8::Local&lt;Name&gt; name, AccessorNameGetterCallback getter, AccessorNameSetterCallback setter</code>。</p><p>拦截器与访问器有相似之处，只不过访问器是针对某个特定的访问设置的getter和setter，而拦截器则是对于一个对象实例的所有相关访问进行拦截。一般一个对象模板有两种不同类型的拦截器可以设置：</p><ul><li><strong>映射型拦截器（Named Property Interceptor）</strong>： 当对于一个对象内成员的访问方式是字符串型的属性名时，映射型拦截器就会生效，比如在Chrome浏览器中，文档中的一些访问就是映射型拦截器<code>document.theFormName.elementName</code></li><li><strong>索引型拦截器（Indexed Property Interceptor）</strong>： 与映射型拦截器不同，索引型拦截器的访问与数组类似，通过整型下标来对内容进行访问。比如在Chrome浏览器中，<code>document.forms.elements[0]</code>这种形式的访问就是索引型拦截器的一种体现。</li></ul><p>对象模板通过<code>SetHandler</code>来对这个模板设置拦截器，通过传入不同类型的配置对象来决定设置的是映射型拦截器还是索引型拦截器。定义在<code>api.cc</code>中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ObjectTemplate::SetHandler</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> NamedPropertyHandlerConfiguration&amp; config)</span> </span>&#123;<br>  <span class="hljs-built_in">ObjectTemplateSetNamedPropertyHandler</span>(<br>      <span class="hljs-keyword">this</span>, config.getter, config.setter, config.query, config.descriptor,<br>      config.deleter, config.enumerator, config.definer, config.data,<br>      config.flags);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ObjectTemplate::SetHandler</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> IndexedPropertyHandlerConfiguration&amp; config)</span> </span>&#123;<br>  i::Isolate* isolate = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>)-&gt;<span class="hljs-built_in">GetIsolate</span>();<br>  <span class="hljs-built_in">ENTER_V8_NO_SCRIPT_NO_EXCEPTION</span>(isolate);<br>  <span class="hljs-function">i::HandleScope <span class="hljs-title">scope</span><span class="hljs-params">(isolate)</span></span>;<br>  <span class="hljs-keyword">auto</span> cons = <span class="hljs-built_in">EnsureConstructor</span>(isolate, <span class="hljs-keyword">this</span>);<br>  <span class="hljs-built_in">EnsureNotPublished</span>(cons, <span class="hljs-string">&quot;v8::ObjectTemplate::SetHandler&quot;</span>);<br>  <span class="hljs-keyword">auto</span> obj = <span class="hljs-built_in">CreateIndexedInterceptorInfo</span>(<br>      isolate, config.getter, config.setter, config.query, config.descriptor,<br>      config.deleter, config.enumerator, config.definer, config.data,<br>      config.flags);<br>  i::FunctionTemplateInfo::<span class="hljs-built_in">SetIndexedPropertyHandler</span>(isolate, cons, obj);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>NamedPropertyHandlerConfiguration</code>类定义在<code>v8.h</code>中，这个类的对象用于配置一个映射型拦截器。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NamedPropertyHandlerConfiguration</span> &#123;<br><br>  ...<br><br>  <span class="hljs-built_in">NamedPropertyHandlerConfiguration</span>(<br>      <span class="hljs-comment">/** Note: getter is required */</span><br>      GenericNamedPropertyGetterCallback getter = <span class="hljs-literal">nullptr</span>,<br>      GenericNamedPropertySetterCallback setter = <span class="hljs-literal">nullptr</span>,<br>      GenericNamedPropertyQueryCallback query = <span class="hljs-literal">nullptr</span>,<br>      GenericNamedPropertyDeleterCallback deleter = <span class="hljs-literal">nullptr</span>,<br>      GenericNamedPropertyEnumeratorCallback enumerator = <span class="hljs-literal">nullptr</span>,<br>      Local&lt;Value&gt; data = <span class="hljs-built_in">Local</span>&lt;Value&gt;(),<br>      PropertyHandlerFlags flags = PropertyHandlerFlags::kNone)<br>      : <span class="hljs-built_in">getter</span>(getter),<br>        <span class="hljs-built_in">setter</span>(setter),<br>        <span class="hljs-built_in">query</span>(query),<br>        <span class="hljs-built_in">deleter</span>(deleter),<br>        <span class="hljs-built_in">enumerator</span>(enumerator),<br>        <span class="hljs-built_in">definer</span>(<span class="hljs-literal">nullptr</span>),<br>        <span class="hljs-built_in">descriptor</span>(<span class="hljs-literal">nullptr</span>),<br>        <span class="hljs-built_in">data</span>(data),<br>        <span class="hljs-built_in">flags</span>(flags) &#123;&#125;<br><br>...<br>    <br>&#125;;<br></code></pre></td></tr></table></figure><p>我们重点关注它的构造函数， <code>getter</code>是拦截器的<code>getter</code>函数，其在函数内部为<code>info</code>返回<code>getter</code>的值。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> GenericNamedPropertyGetterCallback =<br>    <span class="hljs-built_in">void</span> (*)(Local&lt;Name&gt; property, <span class="hljs-type">const</span> PropertyCallbackInfo&lt;Value&gt;&amp; info);<br></code></pre></td></tr></table></figure><p><code>setter</code> 是拦截器的<code>setter</code>函数，其在函数内部把<code>value</code>的值设置到相应的地方。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> GenericNamedPropertySetterCallback =<br>    <span class="hljs-built_in">void</span> (*)(Local&lt;Name&gt; property, Local&lt;Value&gt; value,<br>             <span class="hljs-type">const</span> PropertyCallbackInfo&lt;Value&gt;&amp; info);<br></code></pre></td></tr></table></figure><p><code>query</code>用于对象内查询某属性状态，如只读、不可枚举等，其在函数内部为<code>info</code>返回一个<code>Local&lt;Number&gt;</code>的值，代表它的状态，如<code>v8::ReadOnly</code> 、<code>v8::DontDelete</code>、<code>v8::None</code>等。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> GenericNamedPropertyQueryCallback =<br>    <span class="hljs-built_in">void</span> (*)(Local&lt;Name&gt; property, <span class="hljs-type">const</span> PropertyCallbackInfo&lt;Integer&gt;&amp; info);<br></code></pre></td></tr></table></figure><p><code>deleter</code>用于对象内删除属性，其在函数内部做相应的删除操作之后为<code>info</code>返回一个是否可删除的<code>Local&lt;Boolean&gt;</code>布尔值。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> GenericNamedPropertyDeleterCallback =<br>    <span class="hljs-built_in">void</span> (*)(Local&lt;Name&gt; property, <span class="hljs-type">const</span> PropertyCallbackInfo&lt;Boolean&gt;&amp; info);<br></code></pre></td></tr></table></figure><p><code>enumerator</code>用于对象枚举，如定义了<code>for...in</code>、<code>console.log</code>等执行结果的行为等，其在函数内部为<code>info</code>返回一个字段数组，表示这个对象可枚举出来的字段名。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> GenericNamedPropertyEnumeratorCallback =<br>    <span class="hljs-built_in">void</span> (*)(<span class="hljs-type">const</span> PropertyCallbackInfo&lt;Array&gt;&amp; info);<br></code></pre></td></tr></table></figure><p><code>data</code>这个参数将会被传入上述的各种函数中使用，在<code>PropertyCallbackInfo</code>的对象中，有一个<code>Data()</code>函数就是用来获取这个<code>data</code>用的，如<code>info.Data()</code>。</p><p><code>flags</code>表示这个拦截器的一些标识,主要值如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Configuration flags for v8::NamedPropertyHandlerConfiguration or</span><br><span class="hljs-comment"> * v8::IndexedPropertyHandlerConfiguration.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">PropertyHandlerFlags</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * None. 无标识</span><br><span class="hljs-comment">   */</span><br>  kNone = <span class="hljs-number">0</span>,<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * See ALL_CAN_READ above.  所有属性可读</span><br><span class="hljs-comment">   */</span><br>  kAllCanRead = <span class="hljs-number">1</span>,<br><br>  <span class="hljs-comment">/** Will not call into interceptor for properties on the receiver or prototype</span><br><span class="hljs-comment">   * chain, i.e., only call into interceptor for properties that do not exist.</span><br><span class="hljs-comment">   * Currently only valid for named interceptors.</span><br><span class="hljs-comment">   */</span><br>  kNonMasking = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Will not call into interceptor for symbol lookup.  Only meaningful for</span><br><span class="hljs-comment">   * named interceptors.</span><br><span class="hljs-comment">   */</span><br>  kOnlyInterceptStrings = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * The getter, query, enumerator callbacks do not produce side effects.</span><br><span class="hljs-comment">   */</span><br>  kHasNoSideEffect = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,<br>&#125;;<br></code></pre></td></tr></table></figure><p>索引型拦截器（Indexed Property Interpector）拦截的是数字下标访问的属性，我们可以用JavaScript中普通对象和数组的不同来类比映射型拦截器和索引型拦截器的不同。就使用方法来说，索引型拦截器和映射型拦截器大同小异。它们均通过<code>SetHandler</code>函数来设置拦截器，只不过索引型拦截器传的参数是一个<code>IndexedPropertyHandlerConfiguration</code>的对象，该类的构造函数如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IndexedPropertyHandlerConfiguration</span> &#123;<br> <br>    ...<br>     <br>  <span class="hljs-built_in">IndexedPropertyHandlerConfiguration</span>(<br>      <span class="hljs-comment">/** Note: getter is required */</span><br>      IndexedPropertyGetterCallback getter = <span class="hljs-literal">nullptr</span>,<br>      IndexedPropertySetterCallback setter = <span class="hljs-literal">nullptr</span>,<br>      IndexedPropertyQueryCallback query = <span class="hljs-literal">nullptr</span>,<br>      IndexedPropertyDeleterCallback deleter = <span class="hljs-literal">nullptr</span>,<br>      IndexedPropertyEnumeratorCallback enumerator = <span class="hljs-literal">nullptr</span>,<br>      Local&lt;Value&gt; data = <span class="hljs-built_in">Local</span>&lt;Value&gt;(),<br>      PropertyHandlerFlags flags = PropertyHandlerFlags::kNone)<br>      : <span class="hljs-built_in">getter</span>(getter),<br>        <span class="hljs-built_in">setter</span>(setter),<br>        <span class="hljs-built_in">query</span>(query),<br>        <span class="hljs-built_in">deleter</span>(deleter),<br>        <span class="hljs-built_in">enumerator</span>(enumerator),<br>        <span class="hljs-built_in">definer</span>(<span class="hljs-literal">nullptr</span>),<br>        <span class="hljs-built_in">descriptor</span>(<span class="hljs-literal">nullptr</span>),<br>        <span class="hljs-built_in">data</span>(data),<br>        <span class="hljs-built_in">flags</span>(flags) &#123;&#125;<br><br>	...<br>    <br>&#125;;<br></code></pre></td></tr></table></figure><p>看起来和映射型拦截器的配置对象也基本一致，只不过里面的各种回调函数的类型前缀不一样。当然，写这些函数的时候也是不一样的。</p><p>在映射型拦截器的各种回调函数中，第一个参数是一个<code>Name</code>数据对象的本地句柄（<code>Local&lt;Name&gt;</code>），而索引型拦截器的各种回调函数中的第一个参数则是一个<code>uint32_t</code>型的C++底层数据类型，即无符号32位整型，如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> IndexedPropertyGetterCallback =<br>    <span class="hljs-built_in">void</span> (*)(<span class="hljs-type">uint32_t</span> index, <span class="hljs-type">const</span> PropertyCallbackInfo&lt;Value&gt;&amp; info);<br></code></pre></td></tr></table></figure><h2 id="对象模板的内置字段internal-field">对象模板的内置字段（Internal Field）</h2><p>在V8中，能与JavaScript代码中直接交互的数据类型都是以句柄形式出现的V8数据类型，如<code>v8::Number</code>等，以及对象<code>v8::Object</code>。在<code>v8::Object</code>中，存在的也都是一些同类的数据。</p><p>当我们有一个自身的底层数据结构需要和V8的数据类型联系起来时，就涉及到了V8对象的另一个概念——内置字段。该字段对于JavaScript代码来说是不可见的，只有到C++的层面，才能通过<code>v8::Object</code>的特定方法将其获取出来，可以简单将其理解为V8对象数据类型的私有属性。</p><h1 id="小结">小结</h1><p>句柄作用域就是管理句柄的一种类，它以栈的形式一层一层套着，存在于Isolate实例中，栈顶的作用域是当前活动作用域，每次新建对象时得到的句柄都会与当前活动作用域绑定。当活动作用域被析构时（通常是句柄作用域所处的C++作用域结束导致生命周期到期所致），与其绑定的所有句柄都会被回收，除可逃句柄作用域所设置的已逃脱句柄。</p><p>本节还介绍了V8中的两个重要模板类型————函数模板和对象模板，这两个模板很大意义上是相辅相成的。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Software-Development/" class="category-chain-item">Software Development</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Chromium/" class="print-no-link">#Chromium</a> <a href="/tags/v8/" class="print-no-link">#v8</a> <a href="/tags/javascript/" class="print-no-link">#javascript</a> <a href="/tags/Engine-Architecture/" class="print-no-link">#Engine Architecture</a></div></div><div class="license-box my-3"><div class="license-title"><div>Chrome V8基础（二）</div><div>https://mundi-xu.github.io/2021/07/29/Basics-of-Chrome-V8-2/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>煊宇</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>July 29, 2021</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-cc-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-cc-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/08/15/Basics-of-Chrome-V8-3/" title="Chrome V8基础（三）"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Chrome V8基础（三）</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2021/07/27/Basics-of-Chrome-V8-1/" title="Chrome V8基础（一）"><span class="hidden-mobile">Chrome V8基础（一）</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Mundi-Xu/mundi-xu.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkxNTQ1OTg4Mjg=","category":"Announcements","category-id":"DIC_kwDOCTb9rM4CeUGi","theme-light":"light","theme-dark":"dark","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","strict":0};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>Contact me</span></a> <i class="iconfont icon-love"></i> <a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>mundi.xu@gmail.com</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.umd.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,a,d,i=document.getElementById("updated-time");i&&(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/,(a=(t=i.textContent).match(e))&&(d=dayjs(a[0]).fromNow(),i.textContent=t.replace(e,d)),i.style.display="")};Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js",function(){Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js",function(){dayjs.extend(dayjs_plugin_relativeTime),"en".startsWith("en")?relativeDate():Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/en.min.js",function(){dayjs.locale("en"),relativeDate()})})})</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://cdnjs.cloudflare.com/ajax/libs/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/DynamicLine.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>