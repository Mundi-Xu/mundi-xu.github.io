<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://mundi-xu.github.io/2021/08/15/Basics-of-Chrome-V8-3/"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="煊宇"><meta name="keywords" content="LLM Security"><meta property="article:published_time" content="2021-08-15T12:05:21.000Z"><meta property="article:modified_time" content="2021-08-16T12:05:21.000Z"><meta property="article:section" content="Software Development"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="v8"><meta property="article:tag" content="javascript"><meta property="article:tag" content="Data Types"><meta name="google-site-verification" content="8weHOmi2lqvnOxDE30WJFT51umo63nyCgfm8dXHNT5g"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//raw.githubusercontent.com"><link rel="dns-prefetch" href="//busuanzi.ibruce.info"><link rel="preconnect" href="https://at.alicdn.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin><link rel="preload" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"></noscript><link rel="preload" href="/css/main.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="/js/boot.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script"><meta name="description" content="深入介绍Chrome V8引擎中的基本数据类型和异常处理机制，解析其底层实现，为理解JavaScript的运行时行为提供基础。"><meta property="og:type" content="article"><meta property="og:title" content="Chrome V8基础（三）"><meta property="og:url" content="https://mundi-xu.github.io/2021/08/15/Basics-of-Chrome-V8-3/index.html"><meta property="og:site_name" content="Hanyin&#39;s Space"><meta property="og:description" content="深入介绍Chrome V8引擎中的基本数据类型和异常处理机制，解析其底层实现，为理解JavaScript的运行时行为提供基础。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-08-15T12:05:21.000Z"><meta property="article:modified_time" content="2021-08-16T12:05:21.000Z"><meta property="article:author" content="煊宇"><meta property="article:tag" content="Chromium"><meta property="article:tag" content="Data Types"><meta property="article:tag" content="javascript"><meta property="article:tag" content="v8"><meta name="twitter:card" content="summary_large_image"><meta name="format-detection" content="telephone=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanyin&#39;s Space"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_io/favicon-16x16.png"><link rel="manifest" href="/img/favicon_io/site.webmanifest"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "Chrome V8基础（三）",
    "author": {
      "@type": "Person",
      "name": "煊宇"
    },
    "datePublished": "2021-08-15T12:05:21.000Z",
    
    "dateModified": "2021-08-16T12:05:21.000Z",
    
    "description": "深入介绍Chrome V8引擎中的基本数据类型和异常处理机制，解析其底层实现，为理解JavaScript的运行时行为提供基础。",
    
    "publisher": {
      "@type": "Organization",
      "name": "Hanyin&#39;s Space",
      
      "logo": {
        "@type": "ImageObject",
        "url": "/img/favicon_io/favicon.ico"
      }
      
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://mundi-xu.github.io/2021/08/15/Basics-of-Chrome-V8-3/index.html"
    },
    
    "keywords": "Chromium,v8,javascript,Data Types",
    
    
    "articleBody": "常用数据类型 对前面提到的一些数据类型加以说明 基值（Value） v8::Value是Chrome V8在JavaScript层面用到的各种数据（如Number、String、Function等）的一个总的基类，也就是说这些数据类型都是从Value继承而来的。所以我们经常能从代码中看到Value类型的本地句柄，也就是Local&amp;lt;Value&amp;gt;。关于Chrome V8的Value继承关系可以参阅文档。 由于Value是很多JavaScript数据类型的父类，因此当遇到这种数据的句柄时，我们可以认为它是某一种数据类型的抽象。至于想要知道具体是哪一种数据类型，或者想要将其转换成特定的一种数据类型，就要依靠Value的各种API了。举个栗子： 123V8_WARN_UNUSED_RESULT MaybeLocal&amp;lt;Number&amp;gt; ToNumber(Local&amp;lt;Context&amp;gt; context) const;V8_WARN_UNUSED_RESULT MaybeLocal&amp;lt;String&amp;gt; ToNumber(Local&amp;lt;String&amp;gt; c"
    
  }</script><title>Chrome V8基础（三） - Hanyin&#39;s Space</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/3.0.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"mundi-xu.github.io",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:3},web_analytics:{enable:!0,follow_dnt:!1,google:{measurement_id:"G-3847WCVNF2"}},search_path:"/local-search.json",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-3847WCVNF2",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-3847WCVNF2")})</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Hanyin's Space" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Hanyin&#39;s Space</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Chrome V8基础（三）"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-08-15 20:05" pubdate>August 15, 2021 pm</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 27k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 225 mins </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Software Development" id="heading-f287f429e4026672e5754c1201691e49" role="tab" data-toggle="collapse" href="#collapse-f287f429e4026672e5754c1201691e49" aria-expanded="true">Software Development <span class="list-group-count">(7)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-f287f429e4026672e5754c1201691e49" role="tabpanel" aria-labelledby="heading-f287f429e4026672e5754c1201691e49"><div class="category-post-list"><a href="/2021/08/15/Basics-of-Chrome-V8-3/" title="Chrome V8基础（三）" class="list-group-item list-group-item-action active"><span class="category-post">Chrome V8基础（三）</span> </a><a href="/2021/07/29/Basics-of-Chrome-V8-2/" title="Chrome V8基础（二）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（二）</span> </a><a href="/2021/07/27/Basics-of-Chrome-V8-1/" title="Chrome V8基础（一）" class="list-group-item list-group-item-action"><span class="category-post">Chrome V8基础（一）</span> </a><a href="/2021/03/10/MySQL8-under-Kunpeng/" title="华为鲲鹏服务器下MySQL8的安装与远程连接配置" class="list-group-item list-group-item-action"><span class="category-post">华为鲲鹏服务器下MySQL8的安装与远程连接配置</span> </a><a href="/2021/03/02/Use-IPy-to-determine-the-legitimacy-of-an-IP-address/" title="利用IPy判断IP地址的合法性" class="list-group-item list-group-item-action"><span class="category-post">利用IPy判断IP地址的合法性</span> </a><a href="/2019/11/01/stl-list-implementation/" title="stl-list实现分析" class="list-group-item list-group-item-action"><span class="category-post">stl-list实现分析</span> </a><a href="/2019/08/21/Learn-through-automatic-play-mode/" title="超星学习通开启自动播放模式" class="list-group-item list-group-item-action"><span class="category-post">超星学习通开启自动播放模式</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Chrome V8基础（三）</h1><p id="updated-time" class="note note-primary" style="display:none">Last updated on 2021-08-16T20:05:21+08:00</p><div class="markdown-body"><h1 id="常用数据类型">常用数据类型</h1><p>对前面提到的一些数据类型加以说明</p><h2 id="基值value">基值（Value）</h2><p><code>v8::Value</code>是Chrome V8在JavaScript层面用到的各种数据（如<code>Number</code>、<code>String</code>、<code>Function</code>等）的一个总的基类，也就是说这些数据类型都是从<code>Value</code>继承而来的。所以我们经常能从代码中看到<code>Value</code>类型的本地句柄，也就是<code>Local&lt;Value&gt;</code>。关于Chrome V8的Value继承关系可以参阅<a target="_blank" rel="noopener" href="https://v8docs.nodesource.com/node-16.0/dc/d0a/classv8_1_1_value.html">文档</a>。</p><p>由于<code>Value</code>是很多JavaScript数据类型的父类，因此当遇到这种数据的句柄时，我们可以认为它是某一种数据类型的抽象。至于想要知道具体是哪一种数据类型，或者想要将其转换成特定的一种数据类型，就要依靠<code>Value</code>的各种API了。举个栗子：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">V8_WARN_UNUSED_RESULT MaybeLocal&lt;Number&gt; <span class="hljs-title">ToNumber</span><span class="hljs-params">(Local&lt;Context&gt; context)</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-function">V8_WARN_UNUSED_RESULT MaybeLocal&lt;String&gt; <span class="hljs-title">ToNumber</span><span class="hljs-params">(Local&lt;String&gt; context)</span> <span class="hljs-type">const</span></span>;<br>...<br></code></pre></td></tr></table></figure><h2 id="字符串string">字符串（String）</h2><p>V8中有许多不同的String类型，它们针对各种情况进行了优化，可以在<code>src/objects/objects.h</code>中看到层次结构：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++">    Object<br>SMI<br>HeapObject    <span class="hljs-comment">// superclass for every object instans allocated on the heap.</span><br>  ...<br>  Name<br>    String<br>      SeqString<br>        SeqOneByteString<br>        SeqTwoByteString<br>      SlicedString<br>      ConsString<br>      ThinString<br>      ExternalString<br>        ExternalOneByteString<br>        ExternalTwoByteString<br>      InternalizedString<br>        SeqInternalizedString<br>          SeqOneByteInternalizedString<br>          SeqTwoByteInternalizedString<br>        ConsInternalizedString<br>        ExternalInternalizedString<br>          ExternalOneByteInternalizedString<br>                ExternalTwoByteInternalizedString<br></code></pre></td></tr></table></figure><p>不过<code>v8::String</code>定义在<code>include/v8.h</code>中。可以看到String继承自Name</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetIdentityHash</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Name* <span class="hljs-title">Cast</span><span class="hljs-params">(Value* obj)</span></span><br></code></pre></td></tr></table></figure><h3 id="unicode">Unicode</h3><p>Unicode里的抽象字符（Abstract characters）有类似于<code>LATIN SMALL LETTER A</code>的名字，<code>Code point</code>是一个和抽象字符相关联的数字，比如<code>U+0061</code>，其中U表示Unicode。从U+n0000到U+nFFFF，65536个连续的code points叫做一个plane，如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apl">Plane 0: U+0000 -&gt; U+FFFF           Basic Multilingual Plane (BMP)<br>Plane 1: U+10000 -&gt; U+1FFFF         Supplementary Multilingual Plane<br>Plane 2: U+20000 -&gt; U+2FFFF         Supplementary Ideographic Plane<br>Plane 3: U+30000 -&gt; U+3FFFF<br>...<br>Plane 16: U+100000 -&gt; U+10FFFF      Supplementary Private Use Area B.<br></code></pre></td></tr></table></figure><p>BPM包含编程时使用的绝大部分字符，用四个十六进制数字表示。</p><p>计算机中的内存不处理code points或者abstract characters，而是处理作为一个bit sequence的code uints。code points仅仅是一个查找抽象字符的数字而已，我们可以用一个函数将code point转换成code unit，这个过程就叫做字符编码。计算机中存在着很多种编码，JavaScript使用的是UTF-16（16-bit Unicode Transformation Format）。</p><h3 id="string">String</h3><p>String就是一个拥有长度和内容的<code>Name</code>，内容由一个或两个字节组成，查看<code>include/v8.h</code>中 的定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Encoding</span> &#123;<br>  UNKNOWN_ENCODING = <span class="hljs-number">0x1</span>,<br>  TWO_BYTE_ENCODING = <span class="hljs-number">0x0</span>,<br>  ONE_BYTE_ENCODING = <span class="hljs-number">0x8</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Length</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-type">int</span> Uft8Length <span class="hljs-type">const</span>;<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsOneByte</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libplatform/libplatform.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> v8;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">StringTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, create) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; str = String::<span class="hljs-built_in">NewFromOneByte</span>(isolate_, <br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-string">&quot;bajja&quot;</span>),<br>      NewStringType::kNormal,<br>      <span class="hljs-number">6</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  <span class="hljs-function">String::Utf8Value <span class="hljs-title">value</span><span class="hljs-params">(isolate_, str)</span></span>;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(<span class="hljs-string">&quot;bajja&quot;</span>, *value);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Length</span>(), <span class="hljs-number">6</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Utf8Length</span>(isolate_), <span class="hljs-number">6</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsOneByte</span>(), <span class="hljs-literal">true</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsExternal</span>(), <span class="hljs-literal">false</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsExternalOneByte</span>(), <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, NewFromUtf8) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; str = String::<span class="hljs-built_in">NewFromUtf8</span>(isolate_, <span class="hljs-string">&quot;åäö&quot;</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Length</span>(), <span class="hljs-number">3</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Utf8Length</span>(isolate_), <span class="hljs-number">6</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsOneByte</span>(), <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, fromStringLiteral) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; str = String::<span class="hljs-built_in">NewFromUtf8Literal</span>(isolate_, <span class="hljs-string">&quot;something&quot;</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Length</span>(), <span class="hljs-number">9</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Utf8Length</span>(isolate_), <span class="hljs-number">9</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsOneByte</span>(), <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, empty) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; str = String::<span class="hljs-built_in">Empty</span>(isolate_); <br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Length</span>(), <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">Utf8Length</span>(isolate_), <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">IsOneByte</span>(), <span class="hljs-literal">true</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(str-&gt;<span class="hljs-built_in">ContainsOnlyOneByte</span>(), <span class="hljs-literal">true</span>);<br>  v8::<span class="hljs-function">String::Utf8Value <span class="hljs-title">empty</span><span class="hljs-params">(isolate_, str)</span></span>;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(*empty, <span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, concat) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; left = String::<span class="hljs-built_in">NewFromOneByte</span>(isolate_, <br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-string">&quot;hey&quot;</span>),<br>      NewStringType::kNormal,<br>      <span class="hljs-number">6</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;String&gt; right = String::<span class="hljs-built_in">NewFromOneByte</span>(isolate_, <br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-string">&quot; bajja&quot;</span>),<br>      NewStringType::kNormal,<br>      <span class="hljs-number">6</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;String&gt; joined = String::<span class="hljs-built_in">Concat</span>(isolate_, left, right);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(joined-&gt;<span class="hljs-built_in">Length</span>(), <span class="hljs-number">12</span>);<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(StringTest, compare) &#123;<br>  <span class="hljs-function"><span class="hljs-type">const</span> v8::HandleScope <span class="hljs-title">handle_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  <span class="hljs-function">Isolate::Scope <span class="hljs-title">isolate_scope</span><span class="hljs-params">(isolate_)</span></span>;<br>  Local&lt;String&gt; first = String::<span class="hljs-built_in">NewFromOneByte</span>(isolate_,<br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-string">&quot;hey&quot;</span>),<br>      NewStringType::kNormal,<br>      <span class="hljs-number">6</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  Local&lt;String&gt; second = String::<span class="hljs-built_in">NewFromOneByte</span>(isolate_,<br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-string">&quot;hey&quot;</span>),<br>      NewStringType::kNormal,<br>      <span class="hljs-number">6</span>).<span class="hljs-built_in">ToLocalChecked</span>();<br>  v8::<span class="hljs-function">String::Utf8Value <span class="hljs-title">first_utf8</span><span class="hljs-params">(isolate_, first)</span></span>;<br>  v8::<span class="hljs-function">String::Utf8Value <span class="hljs-title">second_utf8</span><span class="hljs-params">(isolate_, second)</span></span>;<br>  <span class="hljs-built_in">EXPECT_STREQ</span>(*first_utf8, *second_utf8);<br>&#125;<br></code></pre></td></tr></table></figure><p>这是v8.h中唯一的字符串类，但它有很多实现以用于多种用途。</p><h3 id="newfromutf8">NewFromUtf8</h3><p>String数据类型有多个静态函数可以从一个<code>char*</code>指针建立起一个V8字符串数据，最常用的一个就是String的静态函数<code>NewFromUtf8</code>，其就是从一个UTF8数据中新建一个String数据。</p><p>一般用法如下为： <code>Local&lt;String&gt; str = String::NewFromUtf8(isolate_, "åäö").ToLocalChecked();</code></p><p>现在<code>String::NewFromUtf8</code>长这样：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;String&gt; <span class="hljs-title">String::NewFromUtf8</span><span class="hljs-params">(Isolate* isolate, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       NewStringType type, <span class="hljs-type">int</span> length)</span> </span>&#123;<br>  <span class="hljs-built_in">NEW_STRING</span>(isolate, String, NewFromUtf8, <span class="hljs-type">char</span>, data, type, length);<br>  <span class="hljs-keyword">return</span> result;  <br>&#125;<br></code></pre></td></tr></table></figure><p><code>NEW_STRING</code>宏在<code>src/api/api.cc</code>中可以找到，可以用下述命令查看展开后的样子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">g++ -I./out/x64.release_gcc/gen -I./include -I. -E src/api/api.cc &gt; output<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;String&gt; <span class="hljs-title">String::NewFromUtf8</span><span class="hljs-params">(Isolate* isolate, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* data,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       NewStringType type, <span class="hljs-type">int</span> length)</span> </span>&#123;<br>  MaybeLocal&lt;String&gt; result;<br>  <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) &#123;<br>    result = String::<span class="hljs-built_in">Empty</span>(isolate);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &gt; i::String::kMaxLength) &#123;<br>    result = <span class="hljs-built_in">MaybeLocal</span>&lt;String&gt;();<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    i::Isolate* i_isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;internal::Isolate*&gt;(isolate);<br>    i::VMState&lt;v8::OTHER&gt; __state__((i_isolate));;<br>    i::RuntimeCallTimerScope _runtime_timer( i_isolate, i::RuntimeCallCounterId::kAPI_String_NewFromUtf8);<br>    <span class="hljs-keyword">do</span> &#123;<br>      <span class="hljs-keyword">auto</span>&amp;&amp; logger = (i_isolate)-&gt;<span class="hljs-built_in">logger</span>();<br>      <span class="hljs-keyword">if</span> (logger-&gt;<span class="hljs-built_in">is_logging</span>())<br>        logger-&gt;<span class="hljs-built_in">ApiEntryCall</span>(<span class="hljs-string">&quot;v8::&quot;</span> <span class="hljs-string">&quot;String&quot;</span> <span class="hljs-string">&quot;::&quot;</span> <span class="hljs-string">&quot;NewFromUtf8&quot;</span>);<br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">if</span> (length &lt; <span class="hljs-number">0</span>)<br>      length = <span class="hljs-built_in">StringLength</span>(data);<br>     i::Handle&lt;i::String&gt; handle_result = <span class="hljs-built_in">NewString</span>(i_isolate-&gt;<span class="hljs-built_in">factory</span>(), type, i::<span class="hljs-built_in">Vector</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>&gt;(data, length)) .<span class="hljs-built_in">ToHandleChecked</span>();<br>     result = Utils::<span class="hljs-built_in">ToLocal</span>(handle_result);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> result;  <br>&#125;<br></code></pre></td></tr></table></figure><p>有很多的检查是不需要的，可以移到编译时检查，比如字符串的最大长度：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">int</span> N&gt;<br><span class="hljs-function"><span class="hljs-type">static</span> V8_WARN_UNUSED_RESULT Local&lt;String&gt; <span class="hljs-title">NewFromUtf8Literal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    Isolate* isolate, <span class="hljs-type">const</span> <span class="hljs-type">char</span> (&amp;literal)[N],</span></span><br><span class="hljs-params"><span class="hljs-function">    NewStringType type = NewStringType::kNormal)</span> </span>&#123;<br>  <span class="hljs-built_in">static_assert</span>(N &lt;= kMaxLength, <span class="hljs-string">&quot;String is too long&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">NewFromUtf8Literal</span>(isolate, literal, type, N - <span class="hljs-number">1</span>);      <br>&#125;<br></code></pre></td></tr></table></figure><p><code>static_assert</code>在编译时检查。</p><h2 id="数值类型">数值类型</h2><p>数值类型在V8中代表的意义很宽泛，有些中间数值类型从<code>Number</code>中继承出来，所以也属于V8的数值类型，如:</p><ul><li><code>Integer</code> 继承自<code>Number</code></li><li><code>Int32</code> 继承自<code>Integer</code></li><li><code>Uint32</code> 继承自<code>Integer</code></li></ul><p>关于数值类型的用法很简单，常用的无非是静态函数<code>New()</code>以及成员函数<code>Value()</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">Number::Value</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>; <span class="hljs-comment">// Value()函数声明，返回一个double数值</span><br><span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Number&gt; <span class="hljs-title">New</span><span class="hljs-params">(Isolate* isolate, <span class="hljs-type">double</span> value)</span></span>; <span class="hljs-comment">// New()函数声明</span><br></code></pre></td></tr></table></figure><p>相应地，<code>Integer</code>以及其他几个数值类型也有其相应的<code>New()</code>函数和<code>Value()</code>函数。不过值得注意的是<code>Integer::Value()</code>的返回值是<code>int64_t</code>类型的数据，但是在<code>New()</code>的时候传的却需要是<code>int32_t</code>或者<code>uint32_t</code>。</p><h2 id="布尔类型boolean">布尔类型（Boolean)</h2><p>布尔类型非常简单，常用的API和数值类型差不多，无非是<code>New()</code>和<code>Value()</code>两个，不同的是它们的参数或者返回值是一个<code>bool</code>类型罢了。</p><h2 id="对象object">对象（Object）</h2><p>对象继承自 <code>TaggedImpl</code>，从<code>Object</code>出发，衍生了各种其他非元类型的数据类型，如数组、函数等：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Object</span> : <span class="hljs-keyword">public</span> TaggedImpl&lt;HeapObjectReferenceType::STRONG, Address&gt; &#123; <br></code></pre></td></tr></table></figure><p>对象可以用它默认的构造函数创建或者传入一个指向TaggedImpl的构造函数的地址。对象本身不包括任何成员，除了一个继承自TaggedImpl的<code>ptr_</code>，所以我们创建的Object在栈上类似于一个指向对象的指针。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">+------+<br>|Object|<br>|------|<br>|ptr_  |----&gt;<br>+------+<br></code></pre></td></tr></table></figure><p><code>ptr_</code>是一个StrongType，所以它可以是一个<code>smi</code>，此时它会包含一个像小整数的值：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">+------+<br>|Object|<br>|------|<br>|  18  |<br>+------+<br></code></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bitset&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/slots.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> i = v8::internal;<br><br><span class="hljs-built_in">TEST</span>(Object, Create) &#123;<br>  i::Object obj&#123;&#125;;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(obj.<span class="hljs-built_in">ptr</span>(), i::kNullAddress);<br>  i::Object obj2&#123;<span class="hljs-number">18</span>&#125;;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(obj<span class="hljs-number">2.</span><span class="hljs-built_in">ptr</span>()), <span class="hljs-number">18</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="objectslot">ObjectSlot</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">i::Object obj&#123;<span class="hljs-number">18</span>&#125;;<br>i::FullObjectSlot slot&#123;&amp;obj&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">+----------+      +---------+<br>|ObjectSlot|      | Object  |<br>|----------|      |---------|<br>| address  | ---&gt; |   18    |<br>+----------+      +---------+<br></code></pre></td></tr></table></figure><p>样例代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bitset&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/objects-inl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;src/objects/slots.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> i = v8::internal;<br><br><span class="hljs-built_in">TEST</span>(ObjectSlot, Create) &#123;<br>  i::Object obj&#123;<span class="hljs-number">18</span>&#125;;<br>  i::FullObjectSlot slot&#123;&amp;obj&#125;;<br>  <span class="hljs-built_in">EXPECT_NE</span>(slot.<span class="hljs-built_in">address</span>(), obj.<span class="hljs-built_in">ptr</span>());<br>  <span class="hljs-built_in">EXPECT_EQ</span>(*slot, obj);<br><br>  i::Object* p = &amp;obj;<br>  i::Object** pp = &amp;p;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(*slot, **pp);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="maybe">Maybe</h3><p><code>Maybe</code>是一个简单的用于表现一个对象是否具值的数据类型，当一个API返回一个<code>Maybe&lt;&gt;</code>时，就说明它可能是一个布尔值，也可能是一个因为异常而得到的无值结果。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;                                                              <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Maybe</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">bool</span> <span class="hljs-title">IsNothing</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> !has_value_; &#125;                      <br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">bool</span> <span class="hljs-title">IsJust</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> has_value_; &#125;<br>  ...<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-type">bool</span> has_value_;                                                              <br>  T value_; <br>&#125;<br></code></pre></td></tr></table></figure><p><code>Maybe&lt;&gt;</code>的数据类型有几个常用的函数：</p><ul><li><code>bool Maybe&lt;T&gt;::IsNothing() const</code> 是否具值</li><li><code>bool Maybe&lt;T&gt;::IsJust() const</code> 与上面这个函数结果相反</li><li><code>T Maybe&lt;T&gt;::FromJust() const</code> 返回它本体的值，如果不具值则直接崩溃</li><li><code>T Maybe&lt;T&gt;::FromMaybe(const Maybe&amp; default_value) const</code> 返回它本体的值，如果不具值则返回<code>default_value</code></li></ul><p>样例代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8_test_fixture.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;v8.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> v8;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaybeTest</span> : <span class="hljs-keyword">public</span> V8TestFixture &#123;<br>&#125;;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeTest, Maybe) &#123;<br>  <span class="hljs-type">bool</span> cond = <span class="hljs-literal">true</span>;<br>  Maybe&lt;<span class="hljs-type">int</span>&gt; maybe = cond ? <span class="hljs-built_in">Just</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">10</span>) : <span class="hljs-built_in">Nothing</span>&lt;<span class="hljs-type">int</span>&gt;();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe.<span class="hljs-built_in">IsJust</span>());<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(maybe.<span class="hljs-built_in">IsNothing</span>());<br>  maybe.<span class="hljs-built_in">Check</span>();<br><br>  <span class="hljs-type">int</span> nr = maybe.<span class="hljs-built_in">ToChecked</span>();<br>  <span class="hljs-built_in">EXPECT_EQ</span>(nr, <span class="hljs-number">10</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(maybe.<span class="hljs-built_in">FromJust</span>(), <span class="hljs-number">10</span>);<br><br>  Maybe&lt;<span class="hljs-type">int</span>&gt; nothing = <span class="hljs-built_in">Nothing</span>&lt;<span class="hljs-type">int</span>&gt;();<br>  <span class="hljs-type">int</span> value = nothing.<span class="hljs-built_in">FromMaybe</span>(<span class="hljs-number">22</span>);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(value, <span class="hljs-number">22</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * I think the intention with a type Maybe&lt;void&gt; is that we don&#x27;t really</span><br><span class="hljs-comment"> * care/want to have a value in the Maybe apart from that is is empty or</span><br><span class="hljs-comment"> * something. So instead of having a bool and setting it to true just</span><br><span class="hljs-comment"> * have void and return an empty. I think this signals the intent of a</span><br><span class="hljs-comment"> * function better as one might otherwise wonder what the value in the maybe</span><br><span class="hljs-comment"> * represents.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">Maybe&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">doit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Nothing</span>&lt;<span class="hljs-type">void</span>&gt;();<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JustVoid</span>();<br>&#125;<br><br><span class="hljs-built_in">TEST_F</span>(MaybeTest, MaybeVoid) &#123;<br>  Maybe&lt;<span class="hljs-type">void</span>&gt; maybe = <span class="hljs-built_in">JustVoid</span>();<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(maybe.<span class="hljs-built_in">IsNothing</span>());<br><br>  Maybe&lt;<span class="hljs-type">void</span>&gt; maybe_nothing = <span class="hljs-built_in">Nothing</span>&lt;<span class="hljs-type">void</span>&gt;();<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(maybe_nothing.<span class="hljs-built_in">IsNothing</span>());<br><br>  <span class="hljs-built_in">EXPECT_TRUE</span>(<span class="hljs-built_in">doit</span>(<span class="hljs-number">-1</span>).<span class="hljs-built_in">IsNothing</span>());<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(<span class="hljs-built_in">doit</span>(<span class="hljs-number">1</span>).<span class="hljs-built_in">IsJust</span>());<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="函数function">函数（Function）</h2><p>别忘了函数也是对象的一种，所以说V8中的<code>Function</code>也是继承自<code>Object</code>的。对于外界传进来的<code>Value</code>类型的函数，读者能通过之前介绍过的<code>Local&lt;T&gt;::Cast</code>来将其转换成函数类型，也可以通过<code>CheckCast()</code>判断。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">void</span> v8::Function::<span class="hljs-built_in">CheckCast</span>(Value* that) &#123;<br>  i::Handle&lt;i::Object&gt; obj = Utils::<span class="hljs-built_in">OpenHandle</span>(that);<br>  Utils::<span class="hljs-built_in">ApiCheck</span>(obj-&gt;<span class="hljs-built_in">IsCallable</span>(), <span class="hljs-string">&quot;v8::Function::Cast&quot;</span>,<br>                  <span class="hljs-string">&quot;Value is not a Function&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>而对于一个已经是函数类型的数据来说，我们可以用以下一些常见的函数：</p><ul><li><code>Call()</code> 调用这个函数</li><li><code>NewInstance</code> 相当于通过<code>new</code>的方式调用这个函数以得到类的实例。</li><li><code>Setname()</code> <code>GetName()</code> 设置获取函数名</li><li>具体可以看<code>src/api/api.cc</code></li></ul><p>这里主要介绍一下如何调用一个函数的数据类型。</p><h3 id="函数调用call">函数调用（Call）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;v8::Value&gt; <span class="hljs-title">Function::Call</span><span class="hljs-params">(Local&lt;Context&gt; context,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     v8::Local&lt;v8::Value&gt; recv, <span class="hljs-type">int</span> argc,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     v8::Local&lt;v8::Value&gt; argv[])</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(context-&gt;<span class="hljs-built_in">GetIsolate</span>());<br>  <span class="hljs-built_in">TRACE_EVENT_CALL_STATS_SCOPED</span>(isolate, <span class="hljs-string">&quot;v8&quot;</span>, <span class="hljs-string">&quot;V8.Execute&quot;</span>);<br>  <span class="hljs-built_in">ENTER_V8</span>(isolate, context, Function, Call, <span class="hljs-built_in">MaybeLocal</span>&lt;Value&gt;(),<br>           InternalEscapableScope);<br>  <span class="hljs-function">i::TimerEventScope&lt;i::TimerEventExecute&gt; <span class="hljs-title">timer_scope</span><span class="hljs-params">(isolate)</span></span>;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  Utils::<span class="hljs-built_in">ApiCheck</span>(!self.<span class="hljs-built_in">is_null</span>(), <span class="hljs-string">&quot;v8::Function::Call&quot;</span>,<br>                  <span class="hljs-string">&quot;Function to be called is a null pointer&quot;</span>);<br>  i::Handle&lt;i::Object&gt; recv_obj = Utils::<span class="hljs-built_in">OpenHandle</span>(*recv);<br>  <span class="hljs-built_in">STATIC_ASSERT</span>(<span class="hljs-built_in">sizeof</span>(v8::Local&lt;v8::Value&gt;) == <span class="hljs-built_in">sizeof</span>(i::Handle&lt;i::Object&gt;));<br>  i::Handle&lt;i::Object&gt;* args = <span class="hljs-keyword">reinterpret_cast</span>&lt;i::Handle&lt;i::Object&gt;*&gt;(argv);<br>  Local&lt;Value&gt; result;<br>  has_pending_exception = !<span class="hljs-built_in">ToLocal</span>&lt;Value&gt;(<br>      i::Execution::<span class="hljs-built_in">Call</span>(isolate, self, recv_obj, argc, args), &amp;result);<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(Value);<br>  <span class="hljs-built_in">RETURN_ESCAPED</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure><p>各参数含义如下：</p><ul><li><code>context</code> 上下文</li><li><code>recv</code> 相当于被调用函数内部的<code>this</code></li><li><code>argc</code> 这次函数调用的参数个数</li><li><code>argv</code> 与参数个数对应的参数数组，以本地<code>Value</code>句柄的形式出现。</li></ul><h3 id="构造函数的实例化newinstance">构造函数的实例化（NewInstance）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;Object&gt; <span class="hljs-title">Function::NewInstance</span><span class="hljs-params">(Local&lt;Context&gt; context, <span class="hljs-type">int</span> argc,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         v8::Local&lt;v8::Value&gt; argv[])</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">NewInstanceWithSideEffectType</span>(context, argc, argv,<br>                                       SideEffectType::kHasSideEffect);<br>&#125;<br></code></pre></td></tr></table></figure><p>调用<code>NewInstanceWithSideEffectType()</code>生成</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;Object&gt; <span class="hljs-title">Function::NewInstanceWithSideEffectType</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    Local&lt;Context&gt; context, <span class="hljs-type">int</span> argc, v8::Local&lt;v8::Value&gt; argv[],</span></span><br><span class="hljs-params"><span class="hljs-function">    SideEffectType side_effect_type)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(context-&gt;<span class="hljs-built_in">GetIsolate</span>());<br>  <span class="hljs-built_in">TRACE_EVENT_CALL_STATS_SCOPED</span>(isolate, <span class="hljs-string">&quot;v8&quot;</span>, <span class="hljs-string">&quot;V8.Execute&quot;</span>);<br>  <span class="hljs-built_in">ENTER_V8</span>(isolate, context, Function, NewInstance, <span class="hljs-built_in">MaybeLocal</span>&lt;Object&gt;(),<br>           InternalEscapableScope);<br>  <span class="hljs-function">i::TimerEventScope&lt;i::TimerEventExecute&gt; <span class="hljs-title">timer_scope</span><span class="hljs-params">(isolate)</span></span>;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  <span class="hljs-built_in">STATIC_ASSERT</span>(<span class="hljs-built_in">sizeof</span>(v8::Local&lt;v8::Value&gt;) == <span class="hljs-built_in">sizeof</span>(i::Handle&lt;i::Object&gt;));<br>  <span class="hljs-type">bool</span> should_set_has_no_side_effect =<br>      side_effect_type == SideEffectType::kHasNoSideEffect &amp;&amp;<br>      isolate-&gt;<span class="hljs-built_in">debug_execution_mode</span>() == i::DebugInfo::kSideEffects;<br>  <span class="hljs-keyword">if</span> (should_set_has_no_side_effect) &#123;<br>    <span class="hljs-built_in">CHECK</span>(self-&gt;<span class="hljs-built_in">IsJSFunction</span>() &amp;&amp;<br>          i::JSFunction::<span class="hljs-built_in">cast</span>(*self).<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">IsApiFunction</span>());<br>    i::Object obj =<br>        i::JSFunction::<span class="hljs-built_in">cast</span>(*self).<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">get_api_func_data</span>().<span class="hljs-built_in">call_code</span>(<br>            kAcquireLoad);<br>    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">IsCallHandlerInfo</span>()) &#123;<br>      i::CallHandlerInfo handler_info = i::CallHandlerInfo::<span class="hljs-built_in">cast</span>(obj);<br>      <span class="hljs-keyword">if</span> (!handler_info.<span class="hljs-built_in">IsSideEffectFreeCallHandlerInfo</span>()) &#123;<br>        handler_info.<span class="hljs-built_in">SetNextCallHasNoSideEffect</span>();<br>      &#125;<br>    &#125;<br>  &#125;<br>  i::Handle&lt;i::Object&gt;* args = <span class="hljs-keyword">reinterpret_cast</span>&lt;i::Handle&lt;i::Object&gt;*&gt;(argv);<br>  Local&lt;Object&gt; result;<br>  has_pending_exception = !<span class="hljs-built_in">ToLocal</span>&lt;Object&gt;(<br>      i::Execution::<span class="hljs-built_in">New</span>(isolate, self, self, argc, args), &amp;result);<br>  <span class="hljs-keyword">if</span> (should_set_has_no_side_effect) &#123;<br>    i::Object obj =<br>        i::JSFunction::<span class="hljs-built_in">cast</span>(*self).<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">get_api_func_data</span>().<span class="hljs-built_in">call_code</span>(<br>            kAcquireLoad);<br>    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">IsCallHandlerInfo</span>()) &#123;<br>      i::CallHandlerInfo handler_info = i::CallHandlerInfo::<span class="hljs-built_in">cast</span>(obj);<br>      <span class="hljs-keyword">if</span> (has_pending_exception) &#123;<br>        <span class="hljs-comment">// Restore the map if an exception prevented restoration.</span><br>        handler_info.<span class="hljs-built_in">NextCallHasNoSideEffect</span>();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">DCHECK</span>(handler_info.<span class="hljs-built_in">IsSideEffectCallHandlerInfo</span>() ||<br>               handler_info.<span class="hljs-built_in">IsSideEffectFreeCallHandlerInfo</span>());<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(Object);<br>  <span class="hljs-built_in">RETURN_ESCAPED</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="函数名操作name">函数名操作(Name)</h3><p>获取函数名：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">Function::GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  i::Isolate* isolate = self-&gt;<span class="hljs-built_in">GetIsolate</span>();<br>  <span class="hljs-keyword">if</span> (self-&gt;<span class="hljs-built_in">IsJSBoundFunction</span>()) &#123;<br>    <span class="hljs-keyword">auto</span> func = i::Handle&lt;i::JSBoundFunction&gt;::<span class="hljs-built_in">cast</span>(self);<br>    i::Handle&lt;i::Object&gt; name;<br>    <span class="hljs-built_in">ASSIGN_RETURN_ON_EXCEPTION_VALUE</span>(isolate, name,<br>                                     i::JSBoundFunction::<span class="hljs-built_in">GetName</span>(isolate, func),<br>                                     <span class="hljs-built_in">Local</span>&lt;Value&gt;());<br>    <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(name);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (self-&gt;<span class="hljs-built_in">IsJSFunction</span>()) &#123;<br>    <span class="hljs-keyword">auto</span> func = i::Handle&lt;i::JSFunction&gt;::<span class="hljs-built_in">cast</span>(self);<br>    <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(<span class="hljs-built_in">handle</span>(func-&gt;<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">Name</span>(), isolate));<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ToApiHandle</span>&lt;Primitive&gt;(isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">undefined_value</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>设置更改函数名：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Function::SetName</span><span class="hljs-params">(v8::Local&lt;v8::String&gt; name)</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  <span class="hljs-keyword">if</span> (!self-&gt;<span class="hljs-built_in">IsJSFunction</span>()) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">auto</span> func = i::Handle&lt;i::JSFunction&gt;::<span class="hljs-built_in">cast</span>(self);<br>  <span class="hljs-built_in">ASSERT_NO_SCRIPT_NO_EXCEPTION</span>(func-&gt;<span class="hljs-built_in">GetIsolate</span>());<br>  func-&gt;<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">SetName</span>(*Utils::<span class="hljs-built_in">OpenHandle</span>(*name));<br>&#125;<br></code></pre></td></tr></table></figure><p>还有一些特定用途（如Debug）的函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">Function::GetInferredName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  <span class="hljs-keyword">if</span> (!self-&gt;<span class="hljs-built_in">IsJSFunction</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ToApiHandle</span>&lt;Primitive&gt;(<br>        self-&gt;<span class="hljs-built_in">GetIsolate</span>()-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">undefined_value</span>());<br>  &#125;<br>  <span class="hljs-keyword">auto</span> func = i::Handle&lt;i::JSFunction&gt;::<span class="hljs-built_in">cast</span>(self);<br>  <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(<br>      i::<span class="hljs-built_in">Handle</span>&lt;i::Object&gt;(func-&gt;<span class="hljs-built_in">shared</span>().<span class="hljs-built_in">inferred_name</span>(), func-&gt;<span class="hljs-built_in">GetIsolate</span>()));<br>&#125;<br><br><span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">Function::GetDebugName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> self = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  <span class="hljs-keyword">if</span> (!self-&gt;<span class="hljs-built_in">IsJSFunction</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ToApiHandle</span>&lt;Primitive&gt;(<br>        self-&gt;<span class="hljs-built_in">GetIsolate</span>()-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">undefined_value</span>());<br>  &#125;<br>  <span class="hljs-keyword">auto</span> func = i::Handle&lt;i::JSFunction&gt;::<span class="hljs-built_in">cast</span>(self);<br>  i::Handle&lt;i::String&gt; name = i::JSFunction::<span class="hljs-built_in">GetDebugName</span>(func);<br>  <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(i::<span class="hljs-built_in">Handle</span>&lt;i::Object&gt;(*name, self-&gt;<span class="hljs-built_in">GetIsolate</span>()));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="数组array">数组（Array）</h2><p>数组也继承自对象，通常在转换的时候由句柄的<code>As</code>函数来完成。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> Array : <span class="hljs-keyword">public</span> Object &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">Length</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a JavaScript array with the given length. If the length</span><br><span class="hljs-comment">   * is negative the returned array will have length 0.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Array&gt; <span class="hljs-title">New</span><span class="hljs-params">(Isolate* isolate, <span class="hljs-type">int</span> length = <span class="hljs-number">0</span>)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a JavaScript array out of a Local&lt;Value&gt; array in C++</span><br><span class="hljs-comment">   * with a known length.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Array&gt; <span class="hljs-title">New</span><span class="hljs-params">(Isolate* isolate, Local&lt;Value&gt;* elements,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">size_t</span> length)</span></span>;<br>  <span class="hljs-function">V8_INLINE <span class="hljs-type">static</span> Array* <span class="hljs-title">Cast</span><span class="hljs-params">(Value* obj)</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-built_in">Array</span>();<br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">CheckCast</span><span class="hljs-params">(Value* obj)</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>主要介绍一下<code>Array</code>的几个常用API：</p><h3 id="new">New</h3><p>与对象不同的是，数组的<code>New</code>函数还可以多带一个参数，代表该数组的长度。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++">Local&lt;v8::Array&gt; v8::Array::<span class="hljs-built_in">New</span>(Isolate* isolate, <span class="hljs-type">int</span> length) &#123;<br>  i::Isolate* i_isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(isolate);<br>  <span class="hljs-built_in">LOG_API</span>(i_isolate, Array, New);<br>  <span class="hljs-built_in">ENTER_V8_NO_SCRIPT_NO_EXCEPTION</span>(i_isolate);<br>  <span class="hljs-type">int</span> real_length = length &gt; <span class="hljs-number">0</span> ? length : <span class="hljs-number">0</span>;<br>  i::Handle&lt;i::JSArray&gt; obj = i_isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">NewJSArray</span>(real_length);<br>  i::Handle&lt;i::Object&gt; length_obj =<br>      i_isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">NewNumberFromInt</span>(real_length);<br>  obj-&gt;<span class="hljs-built_in">set_length</span>(*length_obj);<br>  <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(obj);<br>&#125;<br><br>Local&lt;v8::Array&gt; v8::Array::<span class="hljs-built_in">New</span>(Isolate* isolate, Local&lt;Value&gt;* elements,<br>                                <span class="hljs-type">size_t</span> length) &#123;<br>  i::Isolate* i_isolate = <span class="hljs-built_in">reinterpret_cast</span>&lt;i::Isolate*&gt;(isolate);<br>  i::Factory* factory = i_isolate-&gt;<span class="hljs-built_in">factory</span>();<br>  <span class="hljs-built_in">LOG_API</span>(i_isolate, Array, New);<br>  <span class="hljs-built_in">ENTER_V8_NO_SCRIPT_NO_EXCEPTION</span>(i_isolate);<br>  <span class="hljs-type">int</span> len = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(length);<br><br>  i::Handle&lt;i::FixedArray&gt; result = factory-&gt;<span class="hljs-built_in">NewFixedArray</span>(len);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>    i::Handle&lt;i::Object&gt; element = Utils::<span class="hljs-built_in">OpenHandle</span>(*elements[i]);<br>    result-&gt;<span class="hljs-built_in">set</span>(i, *element);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> Utils::<span class="hljs-built_in">ToLocal</span>(<br>      factory-&gt;<span class="hljs-built_in">NewJSArrayWithElements</span>(result, i::PACKED_ELEMENTS, len));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="set与get">Set与Get</h3><p>主要使用下标的形式来设置和获取</p><h3 id="length">Length</h3><p>获取数组的长度：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">uint32_t</span> v8::Array::<span class="hljs-built_in">Length</span>() <span class="hljs-type">const</span> &#123;<br>  i::Handle&lt;i::JSArray&gt; obj = Utils::<span class="hljs-built_in">OpenHandle</span>(<span class="hljs-keyword">this</span>);<br>  i::Object length = obj-&gt;<span class="hljs-built_in">length</span>();<br>  <span class="hljs-keyword">if</span> (length.<span class="hljs-built_in">IsSmi</span>()) &#123;<br>    <span class="hljs-keyword">return</span> i::Smi::<span class="hljs-built_in">ToInt</span>(length);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(length.<span class="hljs-built_in">Number</span>());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="json解析器">JSON解析器</h2><p>Chrome V8的JSON解析器也充满了黑科技，它在V8中是一个类：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++\">class V8_EXPORT JSON &#123;<br> public:<br>  /**<br>   * Tries to parse the string |json_string| and returns it as value if<br>   * successful.<br>   *<br>   * \param the context in which to parse and create the value.<br>   * \param json_string The string to parse.<br>   * \return The corresponding value if successfully parsed.<br>   */<br>  static V8_WARN_UNUSED_RESULT MaybeLocal&lt;Value&gt; Parse(<br>      Local&lt;Context&gt; context, Local&lt;String&gt; json_string);<br><br>  /**<br>   * Tries to stringify the JSON-serializable object |json_object| and returns<br>   * it as string if successful.<br>   *<br>   * \param json_object The JSON-serializable object to stringify.<br>   * \return The corresponding string if successfully stringified.<br>   */<br>  static V8_WARN_UNUSED_RESULT MaybeLocal&lt;String&gt; Stringify(<br>      Local&lt;Context&gt; context, Local&lt;Value&gt; json_object,<br>      Local&lt;String&gt; gap = Local&lt;String&gt;());<br>&#125;;<br></code></pre></td></tr></table></figure><p>主要使用<code>Parse</code>和<code>Stringify</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">MaybeLocal&lt;Value&gt; <span class="hljs-title">JSON::Parse</span><span class="hljs-params">(Local&lt;Context&gt; context,</span></span><br><span class="hljs-params"><span class="hljs-function">                              Local&lt;String&gt; json_string)</span> </span>&#123;<br>  <span class="hljs-built_in">PREPARE_FOR_EXECUTION</span>(context, JSON, Parse, Value);<br>  i::Handle&lt;i::String&gt; string = Utils::<span class="hljs-built_in">OpenHandle</span>(*json_string);<br>  i::Handle&lt;i::String&gt; source = i::String::<span class="hljs-built_in">Flatten</span>(isolate, string);<br>  i::Handle&lt;i::Object&gt; undefined = isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">undefined_value</span>();<br>  <span class="hljs-keyword">auto</span> maybe = source-&gt;<span class="hljs-built_in">IsOneByteRepresentation</span>()<br>                   ? i::JsonParser&lt;<span class="hljs-type">uint8_t</span>&gt;::<span class="hljs-built_in">Parse</span>(isolate, source, undefined)<br>                   : i::JsonParser&lt;<span class="hljs-type">uint16_t</span>&gt;::<span class="hljs-built_in">Parse</span>(isolate, source, undefined);<br>  Local&lt;Value&gt; result;<br>  has_pending_exception = !<span class="hljs-built_in">ToLocal</span>&lt;Value&gt;(maybe, &amp;result);<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(Value);<br>  <span class="hljs-built_in">RETURN_ESCAPED</span>(result);<br>&#125;<br><br><span class="hljs-function">MaybeLocal&lt;String&gt; <span class="hljs-title">JSON::Stringify</span><span class="hljs-params">(Local&lt;Context&gt; context,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   Local&lt;Value&gt; json_object,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   Local&lt;String&gt; gap)</span> </span>&#123;<br>  <span class="hljs-built_in">PREPARE_FOR_EXECUTION</span>(context, JSON, Stringify, String);<br>  i::Handle&lt;i::Object&gt; object = Utils::<span class="hljs-built_in">OpenHandle</span>(*json_object);<br>  i::Handle&lt;i::Object&gt; replacer = isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">undefined_value</span>();<br>  i::Handle&lt;i::String&gt; gap_string = gap.<span class="hljs-built_in">IsEmpty</span>()<br>                                        ? isolate-&gt;<span class="hljs-built_in">factory</span>()-&gt;<span class="hljs-built_in">empty_string</span>()<br>                                        : Utils::<span class="hljs-built_in">OpenHandle</span>(*gap);<br>  i::Handle&lt;i::Object&gt; maybe;<br>  has_pending_exception =<br>      !i::<span class="hljs-built_in">JsonStringify</span>(isolate, object, replacer, gap_string).<span class="hljs-built_in">ToHandle</span>(&amp;maybe);<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(String);<br>  Local&lt;String&gt; result;<br>  has_pending_exception =<br>      !<span class="hljs-built_in">ToLocal</span>&lt;String&gt;(i::Object::<span class="hljs-built_in">ToString</span>(isolate, maybe), &amp;result);<br>  <span class="hljs-built_in">RETURN_ON_FAILED_EXECUTION</span>(String);<br>  <span class="hljs-built_in">RETURN_ESCAPED</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="异常机制">异常机制</h1><p><code>TryCatch</code>是V8中一个捕获异常的类，管理其生命周期中V8层面异常。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> TryCatch &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a new try/catch block and registers it with v8.  Note that</span><br><span class="hljs-comment">   * all TryCatch blocks should be stack allocated because the memory</span><br><span class="hljs-comment">   * location itself is compared against JavaScript try/catch blocks.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">TryCatch</span><span class="hljs-params">(Isolate* isolate)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Unregisters and deletes this try/catch block.</span><br><span class="hljs-comment">   */</span><br>  ~<span class="hljs-built_in">TryCatch</span>();<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns true if an exception has been caught by this try/catch block.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">HasCaught</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * For certain types of exceptions, it makes no sense to continue execution.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * If CanContinue returns false, the correct action is to perform any C++</span><br><span class="hljs-comment">   * cleanup needed and then return.  If CanContinue returns false and</span><br><span class="hljs-comment">   * HasTerminated returns true, it is possible to call</span><br><span class="hljs-comment">   * CancelTerminateExecution in order to continue calling into the engine.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CanContinue</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns true if an exception has been caught due to script execution</span><br><span class="hljs-comment">   * being terminated.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * There is no JavaScript representation of an execution termination</span><br><span class="hljs-comment">   * exception.  Such exceptions are thrown when the TerminateExecution</span><br><span class="hljs-comment">   * methods are called to terminate a long-running script.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * If such an exception has been thrown, HasTerminated will return true,</span><br><span class="hljs-comment">   * indicating that it is possible to call CancelTerminateExecution in order</span><br><span class="hljs-comment">   * to continue calling into the engine.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">HasTerminated</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Throws the exception caught by this TryCatch in a way that avoids</span><br><span class="hljs-comment">   * it being caught again by this same TryCatch.  As with ThrowException</span><br><span class="hljs-comment">   * it is illegal to execute any JavaScript operations after calling</span><br><span class="hljs-comment">   * ReThrow; the caller must return immediately to where the exception</span><br><span class="hljs-comment">   * is caught.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">ReThrow</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns the exception caught by this try/catch block.  If no exception has</span><br><span class="hljs-comment">   * been caught an empty handle is returned.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">Local&lt;Value&gt; <span class="hljs-title">Exception</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns the .stack property of an object.  If no .stack</span><br><span class="hljs-comment">   * property is present an empty handle is returned.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">V8_WARN_UNUSED_RESULT <span class="hljs-type">static</span> MaybeLocal&lt;Value&gt; <span class="hljs-title">StackTrace</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Context&gt; context, Local&lt;Value&gt; exception)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns the .stack property of the thrown object.  If no .stack property is</span><br><span class="hljs-comment">   * present or if this try/catch block has not caught an exception, an empty</span><br><span class="hljs-comment">   * handle is returned.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">V8_WARN_UNUSED_RESULT MaybeLocal&lt;Value&gt; <span class="hljs-title">StackTrace</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      Local&lt;Context&gt; context)</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns the message associated with this exception.  If there is</span><br><span class="hljs-comment">   * no message associated an empty handle is returned.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">Local&lt;v8::Message&gt; <span class="hljs-title">Message</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Clears any exceptions that may have been caught by this try/catch block.</span><br><span class="hljs-comment">   * After this method has been called, HasCaught() will return false. Cancels</span><br><span class="hljs-comment">   * the scheduled exception if it is caught and ReThrow() is not called before.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * It is not necessary to clear a try/catch block before using it again; if</span><br><span class="hljs-comment">   * another exception is thrown the previously caught exception will just be</span><br><span class="hljs-comment">   * overwritten.  However, it is often a good idea since it makes it easier</span><br><span class="hljs-comment">   * to determine which operation threw a given exception.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reset</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Set verbosity of the external exception handler.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * By default, exceptions that are caught by an external exception</span><br><span class="hljs-comment">   * handler are not reported.  Call SetVerbose with true on an</span><br><span class="hljs-comment">   * external exception handler to have exceptions caught by the</span><br><span class="hljs-comment">   * handler reported as if they were not caught.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetVerbose</span><span class="hljs-params">(<span class="hljs-type">bool</span> value)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns true if verbosity is enabled.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsVerbose</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Set whether or not this TryCatch should capture a Message object</span><br><span class="hljs-comment">   * which holds source information about where the exception</span><br><span class="hljs-comment">   * occurred.  True by default.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetCaptureMessage</span><span class="hljs-params">(<span class="hljs-type">bool</span> value)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * There are cases when the raw address of C++ TryCatch object cannot be</span><br><span class="hljs-comment">   * used for comparisons with addresses into the JS stack. The cases are:</span><br><span class="hljs-comment">   * 1) ARM, ARM64 and MIPS simulators which have separate JS stack.</span><br><span class="hljs-comment">   * 2) Address sanitizer allocates local C++ object in the heap when</span><br><span class="hljs-comment">   *    UseAfterReturn mode is enabled.</span><br><span class="hljs-comment">   * This method returns address that can be used for comparisons with</span><br><span class="hljs-comment">   * addresses into the JS stack. When neither simulator nor ASAN&#x27;s</span><br><span class="hljs-comment">   * UseAfterReturn is enabled, then the address returned will be the address</span><br><span class="hljs-comment">   * of the C++ try catch handler itself.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">JSStackComparableAddress</span><span class="hljs-params">(TryCatch* handler)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">return</span> handler-&gt;js_stack_comparable_address_;<br>  &#125;<br><br>  <span class="hljs-built_in">TryCatch</span>(<span class="hljs-type">const</span> TryCatch&amp;) = <span class="hljs-keyword">delete</span>;<br>  <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> TryCatch&amp;) = <span class="hljs-keyword">delete</span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// Declaring operator new and delete as deleted is not spec compliant.</span><br>  <span class="hljs-comment">// Therefore declare them private instead to disable dynamic alloc</span><br>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span>;<br>  <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span> size);<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>)</span></span>;<br>  <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>);<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ResetInternal</span><span class="hljs-params">()</span></span>;<br><br>  internal::Isolate* isolate_;<br>  TryCatch* next_;<br>  <span class="hljs-type">void</span>* exception_;<br>  <span class="hljs-type">void</span>* message_obj_;<br>  <span class="hljs-type">void</span>* js_stack_comparable_address_;<br>  <span class="hljs-type">bool</span> is_verbose_ : <span class="hljs-number">1</span>;<br>  <span class="hljs-type">bool</span> can_continue_ : <span class="hljs-number">1</span>;<br>  <span class="hljs-type">bool</span> capture_message_ : <span class="hljs-number">1</span>;<br>  <span class="hljs-type">bool</span> rethrow_ : <span class="hljs-number">1</span>;<br>  <span class="hljs-type">bool</span> has_terminated_ : <span class="hljs-number">1</span>;<br><br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">internal</span>::Isolate;<br>&#125;;<br></code></pre></td></tr></table></figure><p>主要的API如下：</p><ul><li><code>TryCatch()</code> 构造函数传入的是<code>Isolate*</code>指针</li><li><code>bool HasCaught()</code> 是否有错误被该<code>TryCatch</code>域捕获</li><li><code>Local&lt;Value&gt; Exception()</code> 返回一个<code>Exception</code>对象，代表捕获的错误实体。</li><li><code>Local&lt;Value&gt; ReThrow();</code> 重新将其捕获的错误通过<code>throw</code>抛出去</li></ul><p>异常生成的类叫<code>Exception</code>类：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c++"><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">V8_EXPORT</span> Exception &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">RangeError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">ReferenceError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">SyntaxError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">TypeError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">WasmCompileError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">WasmLinkError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">WasmRuntimeError</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Value&gt; <span class="hljs-title">Error</span><span class="hljs-params">(Local&lt;String&gt; message)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates an error message for the given exception.</span><br><span class="hljs-comment">   * Will try to reconstruct the original stack trace from the exception value,</span><br><span class="hljs-comment">   * or capture the current stack trace if not available.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;Message&gt; <span class="hljs-title">CreateMessage</span><span class="hljs-params">(Isolate* isolate, Local&lt;Value&gt; exception)</span></span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns the original stack trace that was captured at the creation time</span><br><span class="hljs-comment">   * of a given exception, or an empty handle if not available.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> Local&lt;StackTrace&gt; <span class="hljs-title">GetStackTrace</span><span class="hljs-params">(Local&lt;Value&gt; exception)</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="小结">小结</h1><p>本节介绍了Chrome V8的一些基本数据类型和异常处理，其API均能在文档中找到。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Software-Development/" class="category-chain-item">Software Development</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Chromium/" class="print-no-link">#Chromium</a> <a href="/tags/v8/" class="print-no-link">#v8</a> <a href="/tags/javascript/" class="print-no-link">#javascript</a> <a href="/tags/Data-Types/" class="print-no-link">#Data Types</a></div></div><div class="license-box my-3"><div class="license-title"><div>Chrome V8基础（三）</div><div>https://mundi-xu.github.io/2021/08/15/Basics-of-Chrome-V8-3/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>煊宇</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>August 15, 2021</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-cc-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-cc-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/11/26/Common-vulnerabilities-mitigation-measures/" title="常见漏洞缓解措施"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">常见漏洞缓解措施</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2021/07/29/Basics-of-Chrome-V8-2/" title="Chrome V8基础（二）"><span class="hidden-mobile">Chrome V8基础（二）</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Mundi-Xu/mundi-xu.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkxNTQ1OTg4Mjg=","category":"Announcements","category-id":"DIC_kwDOCTb9rM4CeUGi","theme-light":"light","theme-dark":"dark","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","strict":0};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>Contact me</span></a> <i class="iconfont icon-love"></i> <a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>mundi.xu@gmail.com</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.umd.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,a,d,i=document.getElementById("updated-time");i&&(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/,(a=(t=i.textContent).match(e))&&(d=dayjs(a[0]).fromNow(),i.textContent=t.replace(e,d)),i.style.display="")};Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js",function(){Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js",function(){dayjs.extend(dayjs_plugin_relativeTime),"en".startsWith("en")?relativeDate():Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/en.min.js",function(){dayjs.locale("en"),relativeDate()})})})</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://cdnjs.cloudflare.com/ajax/libs/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/DynamicLine.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>